<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Miguel Jimenez">
    <meta name="version" content="2.0.0">
    <meta name="description" content="NetAssets v2.0 - Enterprise Network Device Inventory Dashboard for Network Operations Center - Multi-vendor support with intelligent detection, advanced filtering, and premium analytics">
    <meta name="keywords" content="NetAssets, Network Inventory, Device Management, NOC Dashboard, Network Operations, Asset Management, Serial Numbers, HA Configuration, FortiGate, Cisco, Palo Alto, Check Point, Juniper, F5, Multi-Vendor">
    <title>NetAssets v2.1 - Network Device Inventory Dashboard</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" sizes="192x192" href="favicon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="favicon-512.png">
    <link rel="apple-touch-icon" href="favicon-192.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="geographic_validator.js"></script>
    <style>
        :root {
            /* Premium Color Palette */
            --primary-color: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary-color: #8b5cf6;
            --accent-color: #ec4899;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;

            /* Dark Mode Colors */
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-card-hover: #334155;
            --dark-text: #f1f5f9;
            --dark-text-secondary: #cbd5e1;

            /* Glass Effect */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            padding: var(--spacing-lg);
            min-height: 100vh;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            right: -50%;
            bottom: -50%;
            background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.3), transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(255, 255, 198, 0.2), transparent 50%);
            animation: backgroundShift 20s ease infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes backgroundShift {
            0%, 100% { transform: rotate(0deg) scale(1); }
            33% { transform: rotate(60deg) scale(1.1); }
            66% { transform: rotate(-60deg) scale(0.9); }
        }

        body.dark-mode {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        }

        body.dark-mode::before {
            opacity: 0.3;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25),
                        0 0 0 1px rgba(255, 255, 255, 0.1);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        body.dark-mode .container {
            background: rgba(30, 41, 59, 0.95);
            color: var(--dark-text);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .header {
            background: linear-gradient(135deg,
                rgba(99, 102, 241, 0.95) 0%,
                rgba(139, 92, 246, 0.95) 50%,
                rgba(236, 72, 153, 0.95) 100%);
            backdrop-filter: blur(20px);
            color: white;
            padding: 28px 35px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15),
                       0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 10% 50%, rgba(255, 255, 255, 0.1), transparent 40%),
                        radial-gradient(circle at 90% 50%, rgba(255, 255, 255, 0.08), transparent 40%);
            pointer-events: none;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -100%;
            left: -25%;
            width: 150%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.03), transparent);
            animation: headerShine 8s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes headerShine {
            0%, 100% { transform: translateY(0) rotate(45deg); }
            50% { transform: translateY(200%) rotate(45deg); }
        }

        body.dark-mode .header {
            background: linear-gradient(135deg,
                rgba(15, 23, 42, 0.98) 0%,
                rgba(30, 41, 59, 0.98) 50%,
                rgba(51, 65, 85, 0.98) 100%);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3),
                       0 2px 10px rgba(0,0,0,0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .header-title {
            flex: 1;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 16px;
            animation: fadeInDown 0.5s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-icon {
            width: 52px;
            height: 52px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4),
                       inset 0 2px 4px rgba(255,255,255,0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: logoFloat 6s ease-in-out infinite;
            overflow: visible;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        .logo-icon:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.5),
                       inset 0 2px 8px rgba(255,255,255,0.3);
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='52' height='52' viewBox='0 0 52 52' xmlns='http://www.w3.org/2000/svg'%3E%3Cg transform='translate(26 26)'%3E%3Ccircle cx='0' cy='0' r='4.5' fill='white' opacity='0.95'/%3E%3Cline x1='0' y1='0' x2='-9.6' y2='-9.6' stroke='white' stroke-width='1.3' stroke-linecap='round' opacity='0.9'/%3E%3Cline x1='0' y1='0' x2='9.6' y2='-9.6' stroke='white' stroke-width='1.3' stroke-linecap='round' opacity='0.9'/%3E%3Cline x1='0' y1='0' x2='-9.6' y2='9.6' stroke='white' stroke-width='1.3' stroke-linecap='round' opacity='0.9'/%3E%3Cline x1='0' y1='0' x2='9.6' y2='9.6' stroke='white' stroke-width='1.3' stroke-linecap='round' opacity='0.9'/%3E%3Ccircle cx='-9.6' cy='-9.6' r='3' fill='white' opacity='0.95'/%3E%3Ccircle cx='9.6' cy='-9.6' r='3' fill='white' opacity='0.95'/%3E%3Ccircle cx='-9.6' cy='9.6' r='3' fill='white' opacity='0.95'/%3E%3Ccircle cx='9.6' cy='9.6' r='3' fill='white' opacity='0.95'/%3E%3Ccircle cx='-9.6' cy='-9.6' r='1' fill='%23667eea' opacity='0.8'/%3E%3Ccircle cx='9.6' cy='-9.6' r='1' fill='%23667eea' opacity='0.8'/%3E%3Ccircle cx='-9.6' cy='9.6' r='1' fill='%23667eea' opacity='0.8'/%3E%3Ccircle cx='9.6' cy='9.6' r='1' fill='%23667eea' opacity='0.8'/%3E%3Ccircle cx='0' cy='0' r='1.5' fill='%23667eea' opacity='0.8'/%3E%3C/g%3E%3C/svg%3E");
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            animation: logoSpin 20s linear infinite;
        }

        @keyframes logoSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .logo-icon::after {
            display: none;
        }

        .header h1 {
            font-size: 1.75em;
            margin: 0;
            font-weight: 700;
            color: white;
            letter-spacing: -0.025em;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: fadeInUp 0.5s ease 0.1s both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header h1 span {
            font-size: 0.5em;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
            backdrop-filter: blur(10px);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1),
                       inset 0 1px 2px rgba(255,255,255,0.3);
            animation: pulse 2s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .header .subtitle {
            font-size: 0.925em;
            opacity: 0.95;
            font-weight: 400;
            margin-top: 8px;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 0.02em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            animation: fadeInUp 0.5s ease 0.2s both;
        }

        .header .last-updated {
            font-size: 0.85em;
            opacity: 0.8;
            margin-top: 8px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            animation: fadeInUp 0.5s ease 0.3s both;
            gap: 4px;
        }

        .header .last-updated::before {
            content: '◷';
            font-size: 1em;
            opacity: 0.8;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            animation: fadeInRight 0.5s ease 0.3s both;
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .theme-toggle,
        .toggle-analytics-btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.1));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.25);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .theme-toggle::before,
        .toggle-analytics-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .theme-toggle:hover::before,
        .toggle-analytics-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .theme-toggle span,
        .toggle-analytics-btn span {
            position: relative;
            z-index: 1;
        }

        .theme-toggle:hover,
        .toggle-analytics-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .theme-toggle:active,
        .toggle-analytics-btn:active {
            transform: translateY(0);
        }

        body.dark-mode .theme-toggle,
        body.dark-mode .toggle-analytics-btn {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
        }

        body.dark-mode .theme-toggle:hover,
        body.dark-mode .toggle-analytics-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        .controls {
            padding: 24px 32px;
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.98) 0%,
                rgba(249, 250, 251, 0.98) 100%);
            border-bottom: 1px solid rgba(225, 225, 230, 0.5);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .controls::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                transparent,
                rgba(99, 102, 241, 0.03),
                transparent);
            animation: shimmer 8s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        body.dark-mode .controls {
            background: linear-gradient(135deg,
                rgba(30, 41, 59, 0.98) 0%,
                rgba(51, 65, 85, 0.98) 100%);
            border-bottom-color: rgba(71, 85, 105, 0.5);
        }

        .search-container {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
            position: relative;
            animation: slideInUp 0.5s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 45px;
            font-size: 0.925em;
            border: 2px solid rgba(225, 225, 230, 0.5);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.9),
                rgba(249, 250, 251, 0.9));
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .search-box::before {
            content: '🔍';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            opacity: 0.6;
            z-index: 1;
            pointer-events: none;
        }

        body.dark-mode .search-box input {
            background: linear-gradient(135deg,
                rgba(15, 23, 42, 0.9),
                rgba(30, 41, 59, 0.9));
            border-color: rgba(71, 85, 105, 0.5);
            color: #e2e8f0;
        }

        .search-box input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15),
                       0 4px 12px rgba(99, 102, 241, 0.2);
            background: white;
            transform: translateY(-1px);
        }

        body.dark-mode .search-box input:focus {
            background: #1e293b;
        }

        .search-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .search-clear.visible {
            opacity: 1;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .export-btn, .import-btn, .bulk-copy-btn, .print-btn, .header-btn {
            padding: 10px 20px;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.9),
                rgba(249, 250, 251, 0.9));
            backdrop-filter: blur(10px);
            color: #334155;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            animation: buttonFadeIn 0.5s ease;
        }

        @keyframes buttonFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .export-btn::after, .import-btn::after,
        .bulk-copy-btn::after, .print-btn::after, .header-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle,
                rgba(99, 102, 241, 0.1),
                transparent 70%);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease;
            pointer-events: none;
        }

        body.dark-mode .export-btn,
        body.dark-mode .import-btn,
        body.dark-mode .bulk-copy-btn,
        body.dark-mode .print-btn,
        body.dark-mode .header-btn {
            background: linear-gradient(135deg,
                rgba(51, 65, 85, 0.9),
                rgba(71, 85, 105, 0.9));
            color: #e2e8f0;
        }

        .export-btn:hover, .import-btn:hover,
        .bulk-copy-btn:hover, .print-btn:hover, .header-btn:hover {
            border-color: rgba(99, 102, 241, 0.2);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px) scale(1.02);
        }

        .export-btn:hover::after, .import-btn:hover::after,
        .bulk-copy-btn:hover::after, .print-btn:hover::after, .header-btn:hover::after {
            transform: translate(-50%, -50%) scale(2);
        }

        body.dark-mode .export-btn:hover,
        body.dark-mode .import-btn:hover,
        body.dark-mode .bulk-copy-btn:hover,
        body.dark-mode .print-btn:hover,
        body.dark-mode .header-btn:hover {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .view-btn {
            padding: 10px 18px;
            border: 2px solid rgba(225, 225, 230, 0.3);
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.8),
                rgba(249, 250, 251, 0.8));
            color: #475569;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .view-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            z-index: 0;
        }

        .view-btn span {
            position: relative;
            z-index: 1;
        }

        .view-btn.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transform: translateY(-1px);
        }

        .view-btn:hover:not(.active) {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }

        .view-btn:hover:not(.active)::before {
            width: 100%;
            height: 100%;
        }

        body.dark-mode .view-btn {
            background: linear-gradient(135deg,
                rgba(51, 65, 85, 0.8),
                rgba(71, 85, 105, 0.8));
            border-color: rgba(100, 116, 139, 0.3);
            color: #cbd5e1;
        }

        body.dark-mode .view-btn.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-color: transparent;
        }

        body.dark-mode .view-btn:hover:not(.active) {
            border-color: rgba(99, 102, 241, 0.3);
        }

        .filter-section {
            margin-bottom: 16px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .filter-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: #3b82f6;
        }

        body.dark-mode .filter-section {
            background: #1e293b;
            border-color: #334155;
        }

        .filter-section h3 {
            font-size: 0.9em;
            color: #1e293b;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .filter-section h3 {
            color: #e2e8f0;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.825rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .filter-btn:hover {
            background: #f8fafc;
            color: #475569;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .filter-btn.active:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        body.dark-mode .filter-btn {
            background: #334155;
            border-color: #475569;
            color: #94a3b8;
        }

        body.dark-mode .filter-btn:hover {
            background: #475569;
            border-color: #64748b;
            color: #cbd5e1;
        }

        body.dark-mode .filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .filter-badge {
            display: inline-block;
            margin-left: 6px;
            background: #ef4444;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7em;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
        }

        .filter-btn.active .filter-badge {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .filter-subgroup {
            margin-top: 15px;
            padding-left: 10px;
            border-left: 3px solid rgba(102, 126, 234, 0.3);
        }

        .filter-subgroup h4 {
            font-size: 0.85em;
            color: #546e7a;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        body.dark-mode .filter-subgroup h4 {
            color: #90a4ae;
        }

        .filter-buttons.compact .filter-btn {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 24px;
            margin-top: 24px;
            padding: 0 4px;
        }

        .stat-card {
            padding: 28px;
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.95),
                rgba(249, 250, 251, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08),
                       0 2px 10px rgba(0, 0, 0, 0.06),
                       inset 0 1px 2px rgba(255, 255, 255, 0.5);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: statCardFloat 0.6s ease;
        }

        @keyframes statCardFloat {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg,
                #6366f1 0%,
                #8b5cf6 25%,
                #ec4899 50%,
                #f97316 75%,
                #6366f1 100%);
            background-size: 200% 100%;
            animation: gradientSlide 4s linear infinite;
        }

        @keyframes gradientSlide {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle,
                rgba(99, 102, 241, 0.05),
                transparent 40%);
            animation: statPulse 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes statPulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }

        .stat-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                        0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .stat-card.stat-success::before {
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
        }

        .stat-card.stat-danger::before {
            background: linear-gradient(90deg, #ef4444 0%, #f87171 100%);
        }

        .stat-card.stat-info::before {
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
        }

        body.dark-mode .stat-card {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        body.dark-mode .stat-label {
            color: #a0a0a0;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
            animation: numberPop 0.6s ease;
        }

        @keyframes numberPop {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        body.dark-mode .stat-value {
            background: linear-gradient(135deg, #818cf8, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Premium Quick Filters - Enterprise Edition */
        .quick-filters {
            margin-top: 25px;
            padding: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        body.dark-mode .quick-filters {
            background: var(--dark-card);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .quick-filters-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid rgba(255,255,255,0.2);
        }

        .quick-filters-title {
            font-size: 1.1em;
            color: white;
            margin: 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-filters-actions {
            display: flex;
            gap: 10px;
        }

        .filter-action-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .filter-action-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .filter-action-btn:active {
            transform: translateY(0);
        }

        .quick-filters-body {
            padding: 25px;
        }

        .filter-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 12px;
        }

        body.dark-mode .filter-tabs {
            background: #1a2332;
        }

        .filter-tab {
            flex: 1;
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #64748b;
            font-size: 0.95em;
        }

        .filter-tab:hover {
            color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .filter-tab.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        body.dark-mode .filter-tab.active {
            background: var(--dark-card-hover);
            color: var(--primary-light);
        }

        .filter-tab-content {
            display: none;
        }

        .filter-tab-content.active {
            display: block;
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quick-filter-chips {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .chip {
            padding: 10px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid transparent;
            border-radius: 24px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .chip::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .chip:hover::before {
            left: 100%;
        }

        body.dark-mode .chip {
            background: linear-gradient(135deg, #2d3748 0%, #1a2332 100%);
            color: var(--dark-text);
        }

        .chip:hover {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
            border-color: var(--primary-light);
        }

        .chip.active {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
        }

        .chip-badge {
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
        }

        .chip.active .chip-badge {
            background: rgba(255,255,255,0.35);
        }

        .filter-combination {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            border-left: 4px solid var(--warning-color);
        }

        body.dark-mode .filter-combination {
            background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
        }

        .filter-combination-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .filter-combination-title {
            color: #fbbf24;
        }

        .filter-combination-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-logic-toggle {
            padding: 6px 12px;
            background: white;
            border: 2px solid var(--warning-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            color: var(--warning-color);
            transition: all 0.3s;
        }

        .filter-logic-toggle:hover {
            background: var(--warning-color);
            color: white;
        }

        .saved-filters-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .saved-filter-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode .saved-filter-item {
            background: #1a2332;
        }

        .saved-filter-item:hover {
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body.dark-mode .saved-filter-item:hover {
            background: var(--dark-card-hover);
        }

        .saved-filter-name {
            font-weight: 600;
            color: #1e293b;
        }

        body.dark-mode .saved-filter-name {
            color: var(--dark-text);
        }

        .saved-filter-meta {
            font-size: 0.85em;
            color: #64748b;
            margin-top: 4px;
        }

        .saved-filter-actions {
            display: flex;
            gap: 8px;
        }

        .saved-filter-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .saved-filter-btn.apply {
            background: var(--success-color);
            color: white;
        }

        .saved-filter-btn.delete {
            background: var(--danger-color);
            color: white;
        }

        .saved-filter-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .filter-templates {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-template {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        body.dark-mode .filter-template {
            background: linear-gradient(135deg, #1a2332 0%, #2d3748 100%);
        }

        .filter-template:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .filter-template-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .filter-template-name {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }

        body.dark-mode .filter-template-name {
            color: var(--dark-text);
        }

        .filter-template-desc {
            font-size: 0.85em;
            color: #64748b;
        }

        .table-container {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 20px 0;
            position: relative;
        }

        body.dark-mode .table-container {
            background: #0f172a;
        }

        /* Table wrapper with fixed height and scroll */
        .table-scroll-wrapper {
            max-height: calc(100vh - 400px);
            min-height: 400px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            position: relative;
            display: block;
        }

        body.dark-mode .table-scroll-wrapper {
            border-color: #334155;
            background: #1e293b;
        }

        /* Custom scrollbar styling */
        .table-scroll-wrapper::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .table-scroll-wrapper::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 6px;
        }

        .table-scroll-wrapper::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 6px;
            border: 2px solid #f1f5f9;
        }

        .table-scroll-wrapper::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        body.dark-mode .table-scroll-wrapper::-webkit-scrollbar-track {
            background: #1e293b;
        }

        body.dark-mode .table-scroll-wrapper::-webkit-scrollbar-thumb {
            background: #475569;
            border-color: #1e293b;
        }

        body.dark-mode .table-scroll-wrapper::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            min-width: 1200px; /* Ensure minimum width for all columns */
        }

        body.dark-mode table {
            background: #1e293b;
        }

        thead {
            background: #1e293b;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        body.dark-mode thead {
            background: #0f172a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Ensure the first grouped header row also stays sticky */
        thead tr:first-child th {
            position: sticky;
            top: 0;
            z-index: 11;
        }

        thead tr:last-child th {
            position: sticky;
            top: 38px; /* Height of first header row */
            z-index: 10;
        }

        th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8em;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #94a3b8;
            border-bottom: 2px solid #334155;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            position: relative;
        }

        th:first-child {
            width: 40px;
            text-align: center;
        }

        /* Column grouping with visual separators - adjusted for new structure */
        thead tr:last-child th:nth-child(1) {
            border-left: 3px solid #3730a3; /* Identity group */
        }

        thead tr:last-child th:nth-child(4) {
            border-left: 3px solid #dc2626; /* Status group */
        }

        thead tr:last-child th:nth-child(6) {
            border-left: 3px solid #0369a1; /* Device Info group */
        }

        thead tr:last-child th:nth-child(12) {
            border-left: 3px solid #059669; /* Location group */
        }

        thead tr:last-child th:nth-child(14) {
            border-left: 3px solid #f59e0b; /* HA group */
        }

        th:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        th::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            opacity: 0.3;
        }

        th.sort-asc::after {
            border-bottom: 6px solid #60a5fa;
            opacity: 1;
        }

        th.sort-desc::after {
            border-top: 6px solid #60a5fa;
            opacity: 1;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.875em;
            vertical-align: middle;
        }

        body.dark-mode td {
            border-bottom-color: #334155;
        }

        td:first-child {
            text-align: center;
            padding: 8px;
        }

        /* Column grouping visual separators - adjusted for new structure */
        td:nth-child(2) {
            border-left: 1px solid #e2e8f0; /* Identity group */
        }

        td:nth-child(5) {
            border-left: 1px solid #e2e8f0; /* Status group */
        }

        td:nth-child(7) {
            border-left: 1px solid #e2e8f0; /* Device Info group */
        }

        td:nth-child(13) {
            border-left: 1px solid #e2e8f0; /* Location group */
        }

        td:nth-child(15) {
            border-left: 1px solid #e2e8f0; /* HA group */
        }

        body.dark-mode td:nth-child(2),
        body.dark-mode td:nth-child(5),
        body.dark-mode td:nth-child(7),
        body.dark-mode td:nth-child(13),
        body.dark-mode td:nth-child(15) {
            border-left-color: #334155;
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        body.dark-mode tbody tr:nth-child(even) {
            background: rgba(30, 41, 59, 0.5);
        }

        tbody tr:hover {
            background: #eff6ff;
            transform: scale(1.002);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        body.dark-mode tbody tr:hover {
            background: #334155;
        }

        /* Row state indicators */
        tbody tr.critical-row {
            background: #fee2e2 !important;
            border-left: 4px solid #dc2626;
        }

        tbody tr.warning-row {
            background: #fef3c7 !important;
            border-left: 4px solid #f59e0b;
        }

        tbody tr.offline-row {
            background: #f3f4f6 !important;
            opacity: 0.7;
        }

        body.dark-mode tbody tr.critical-row {
            background: rgba(239, 68, 68, 0.1) !important;
        }

        body.dark-mode tbody tr.warning-row {
            background: rgba(245, 158, 11, 0.1) !important;
        }

        body.dark-mode tbody tr.offline-row {
            background: rgba(107, 114, 128, 0.1) !important;
        }

        tbody tr.selected {
            background: #e3f2fd;
        }

        body.dark-mode tbody tr.selected {
            background: #1e3a5f;
        }

        .row-checkbox {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .device-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-fgt60 {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-fg100 {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-fg200 {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-fg500 {
            background: #fce4ec;
            color: #c2185b;
        }

        .badge-other {
            background: #f5f5f5;
            color: #616161;
        }

        .ha-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .ha-yes {
            background: #d4edda;
            color: #155724;
        }

        .ha-no {
            background: #f8d7da;
            color: #721c24;
        }

        /* Professional badge styles */
        .vendor-badge, .type-badge, .site-badge, .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
            letter-spacing: 0.025em;
            border: 1px solid;
            transition: all 0.2s ease;
        }

        .vendor-badge {
            background: #f0f9ff;
            color: #0369a1;
            border-color: #bae6fd;
        }

        body.dark-mode .vendor-badge {
            background: rgba(14, 165, 233, 0.1);
            color: #38bdf8;
            border-color: rgba(14, 165, 233, 0.3);
        }

        .type-badge {
            background: #fef3c7;
            color: #92400e;
            border-color: #fde68a;
        }

        body.dark-mode .type-badge {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            border-color: rgba(251, 191, 36, 0.3);
        }

        .site-badge {
            background: #f0fdf4;
            color: #14532d;
            border-color: #bbf7d0;
        }

        body.dark-mode .site-badge {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .role-badge {
            background: #faf5ff;
            color: #581c87;
            border-color: #e9d5ff;
        }

        body.dark-mode .role-badge {
            background: rgba(168, 85, 247, 0.1);
            color: #c084fc;
            border-color: rgba(168, 85, 247, 0.3);
        }

        /* Status badge styles */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            border: 1px solid;
        }

        .status-badge.status-online,
        .status-badge.status-up {
            background: #dcfce7;
            color: #14532d;
            border-color: #86efac;
        }

        .status-badge.status-offline,
        .status-badge.status-down {
            background: #fee2e2;
            color: #7f1d1d;
            border-color: #fca5a5;
        }

        .status-badge.status-warning,
        .status-badge.status-degraded {
            background: #fef3c7;
            color: #78350f;
            border-color: #fde68a;
        }

        .status-badge.status-unknown {
            background: #f3f4f6;
            color: #374151;
            border-color: #d1d5db;
        }

        body.dark-mode .status-badge.status-online,
        body.dark-mode .status-badge.status-up {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            border-color: rgba(34, 197, 94, 0.3);
        }

        body.dark-mode .status-badge.status-offline,
        body.dark-mode .status-badge.status-down {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border-color: rgba(239, 68, 68, 0.3);
        }

        body.dark-mode .status-badge.status-warning,
        body.dark-mode .status-badge.status-degraded {
            background: rgba(245, 158, 11, 0.1);
            color: #fbbf24;
            border-color: rgba(245, 158, 11, 0.3);
        }

        body.dark-mode .status-badge.status-unknown {
            background: rgba(107, 114, 128, 0.1);
            color: #9ca3af;
            border-color: rgba(107, 114, 128, 0.3);
        }

        /* Health badge styles */
        .health-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 700;
            min-width: 50px;
            justify-content: center;
            border: 1px solid;
        }

        /* Port and Age badges */
        .port-badge, .age-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
        }

        body.dark-mode .port-badge,
        body.dark-mode .age-badge {
            background: rgba(100, 116, 139, 0.1);
            color: #94a3b8;
            border-color: rgba(100, 116, 139, 0.3);
        }

        /* Location cell styling */
        .location-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .location-primary {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
        }

        .location-detail {
            font-size: 0.8em;
            color: #7f8c8d;
            font-style: italic;
        }

        body.dark-mode .location-primary {
            color: #e4e4e4;
        }

        body.dark-mode .location-detail {
            color: #a0a0a0;
        }

        .copy-btn {
            padding: 4px 8px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 8px;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .copy-btn:active {
            transform: scale(0.95);
        }

        /* Inline copy button - subtle and elegant */
        .copy-btn-inline {
            padding: 2px 6px;
            background: transparent;
            color: #94a3b8;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            margin-left: 6px;
            transition: all 0.2s ease;
            opacity: 0.6;
            vertical-align: middle;
        }

        .copy-btn-inline:hover {
            opacity: 1;
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .copy-btn-inline:active {
            transform: scale(0.9);
        }

        /* Device Name Cell - Clean and professional */
        .device-name-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .device-name-primary {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.95em;
            letter-spacing: 0.01em;
        }

        body.dark-mode .device-name-primary {
            color: #e2e8f0;
        }

        /* Model Cell - Technical monospace styling */
        .model-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .model-text {
            font-family: 'SF Mono', 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 0.875em;
            color: #475569;
            font-weight: 500;
            background: #f8fafc;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            letter-spacing: 0.025em;
        }

        body.dark-mode .model-text {
            background: #1e293b;
            color: #cbd5e1;
            border-color: #334155;
        }

        /* Serial Number Cell - Technical precision */
        .serial-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .serial-text {
            font-family: 'SF Mono', 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 0.85em;
            color: #334155;
            font-weight: 500;
            background: #f1f5f9;
            padding: 4px 10px;
            border-radius: 4px;
            border-left: 3px solid #6366f1;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        body.dark-mode .serial-text {
            background: #0f172a;
            color: #cbd5e1;
            border-left-color: #818cf8;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 1.2em;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success-color);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Premium Model Distribution - Enterprise Edition */
        .model-breakdown {
            margin-top: 25px;
            padding: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        body.dark-mode .model-breakdown {
            background: var(--dark-card);
            border-color: rgba(139, 92, 246, 0.2);
        }

        .model-breakdown-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid rgba(255,255,255,0.2);
        }

        .model-breakdown-title {
            font-size: 1.1em;
            color: white;
            margin: 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .model-breakdown h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        body.dark-mode .model-breakdown h3 {
            color: var(--dark-text);
        }

        .model-breakdown-actions {
            display: flex;
            gap: 10px;
        }

        .model-action-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            border: none;
        }

        .model-action-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .model-action-btn.active {
            background: rgba(255,255,255,0.35);
            border-color: rgba(255,255,255,0.5);
        }

        .model-breakdown-body {
            padding: 25px;
        }

        .model-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .model-view-switcher {
            display: flex;
            gap: 5px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 10px;
        }

        body.dark-mode .model-view-switcher {
            background: #1a2332;
        }

        .model-view-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .model-view-btn:hover {
            color: var(--secondary-color);
            background: rgba(139, 92, 246, 0.1);
        }

        .model-view-btn.active {
            background: white;
            color: var(--secondary-color);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        body.dark-mode .model-view-btn.active {
            background: var(--dark-card-hover);
        }

        .model-search {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .model-search input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .model-search input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        body.dark-mode .model-search input {
            background: #1a2332;
            border-color: #2d3748;
            color: var(--dark-text);
        }

        .model-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        .model-stats-bar {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        body.dark-mode .model-stats-bar {
            background: linear-gradient(135deg, #1a2332 0%, #2d3748 100%);
        }

        .model-stat {
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .model-stat-label {
            font-size: 0.85em;
            color: #64748b;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .model-stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--secondary-color);
        }

        body.dark-mode .model-stat-value {
            color: var(--primary-light);
        }

        .model-grid {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 18px;
        }

        .model-grid.active {
            display: grid;
        }

        .model-item {
            padding: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .model-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .model-item:hover::before {
            transform: scaleX(1);
        }

        body.dark-mode .model-item {
            background: linear-gradient(135deg, #1a2332 0%, #2d3748 100%);
        }

        .model-item:hover {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 12px 32px rgba(139, 92, 246, 0.3);
            border-color: var(--secondary-color);
        }

        .model-vendor-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.75em;
            padding: 4px 8px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 6px;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .model-item:hover .model-vendor-badge {
            background: rgba(255,255,255,0.25);
            color: white;
        }

        .model-name {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #1e293b;
        }

        body.dark-mode .model-name {
            color: var(--dark-text);
        }

        .model-item:hover .model-name {
            color: white;
        }

        .model-count {
            font-size: 1.8em;
            font-weight: 800;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        .model-item:hover .model-count {
            color: white;
        }

        .model-percentage {
            font-size: 0.85em;
            color: #64748b;
            font-weight: 600;
        }

        .model-item:hover .model-percentage {
            color: rgba(255,255,255,0.85);
        }

        .model-health-bar {
            margin-top: 10px;
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .model-health-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .model-item:hover .model-health-bar {
            background: rgba(255,255,255,0.2);
        }

        .model-chart-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            min-height: 400px;
            display: none;
        }

        body.dark-mode .model-chart-container {
            background: #1a2332;
        }

        .model-chart-container.active {
            display: block;
            animation: fadeInUp 0.4s ease;
        }

        .model-list {
            display: none;
            flex-direction: column;
            gap: 12px;
        }

        .model-list.active {
            display: flex;
            animation: fadeInUp 0.4s ease;
        }

        .model-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid var(--secondary-color);
            transition: all 0.3s;
            cursor: pointer;
        }

        body.dark-mode .model-list-item {
            background: #1a2332;
        }

        .model-list-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.05) 0%, transparent 100%);
        }

        .model-list-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .model-list-name {
            font-weight: 700;
            color: #1e293b;
            min-width: 150px;
        }

        body.dark-mode .model-list-name {
            color: var(--dark-text);
        }

        .model-list-bar {
            flex: 1;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        body.dark-mode .model-list-bar {
            background: #2d3748;
        }

        .model-list-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            border-radius: 10px;
            transition: width 0.6s ease;
        }

        .model-list-count {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--secondary-color);
            min-width: 60px;
            text-align: right;
        }

        .model-drill-down {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            border-left: 4px solid #f59e0b;
            display: none;
        }

        body.dark-mode .model-drill-down {
            background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
        }

        .model-drill-down.active {
            display: block;
            animation: fadeInUp 0.4s ease;
        }

        .model-drill-title {
            font-weight: 700;
            margin-bottom: 15px;
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }

        body.dark-mode .model-drill-title {
            color: #fbbf24;
        }

        .model-drill-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        @media print {
            body {
                background: white !important;
                padding: 0;
                margin: 0;
            }

            .container {
                box-shadow: none !important;
                border-radius: 0;
                max-width: 100%;
            }

            /* Hide interactive elements */
            .header-actions,
            .search-container,
            .filter-section,
            .quick-filters,
            .stats,
            .model-breakdown,
            .footer,
            .copy-btn,
            .copy-btn-inline,
            .row-checkbox,
            th:first-child,
            td:first-child {
                display: none !important;
            }

            /* Header styling */
            .header {
                background: white !important;
                color: black !important;
                padding: 20px;
                border-bottom: 3px solid #2c3e50;
                page-break-after: avoid;
            }

            .header h1 {
                color: #2c3e50 !important;
                font-size: 24pt;
                margin-bottom: 5px;
                text-shadow: none;
            }

            .header p {
                color: #666 !important;
                font-size: 11pt;
                opacity: 1;
            }

            /* Table container */
            .table-container {
                max-height: none !important;
                overflow: visible !important;
                padding: 20px;
            }

            /* Table styling */
            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 9pt;
                page-break-inside: auto;
            }

            thead {
                background: #2c3e50 !important;
                color: white !important;
                position: static;
            }

            thead tr {
                page-break-inside: avoid;
                page-break-after: avoid;
            }

            th {
                padding: 10px 8px;
                text-align: left;
                font-size: 9pt;
                font-weight: 700;
                border: 1px solid #ddd;
                background: #2c3e50 !important;
                color: white !important;
            }

            th::after {
                content: '' !important;
            }

            tbody tr {
                page-break-inside: avoid;
                page-break-after: auto;
                border-bottom: 1px solid #ddd;
            }

            td {
                padding: 8px;
                font-size: 8pt;
                border: 1px solid #ddd;
                color: black !important;
            }

            /* Remove hover effects */
            tbody tr:hover {
                background: transparent !important;
                transform: none !important;
                box-shadow: none !important;
            }

            /* Badges and indicators */
            .device-badge,
            .ha-indicator {
                display: inline-block;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 7pt;
                font-weight: 600;
                border: 1px solid #ddd;
            }

            .badge-fgt60 {
                background: #e3f2fd !important;
                color: #1976d2 !important;
            }

            .badge-fg100 {
                background: #fff3e0 !important;
                color: #f57c00 !important;
            }

            .badge-fg200 {
                background: #f3e5f5 !important;
                color: #7b1fa2 !important;
            }

            .badge-fg500 {
                background: #fce4ec !important;
                color: #c2185b !important;
            }

            .badge-other {
                background: #f5f5f5 !important;
                color: #616161 !important;
            }

            .ha-yes {
                background: #d4edda !important;
                color: #155724 !important;
                border-color: #c3e6cb;
            }

            .ha-no {
                background: #f8d7da !important;
                color: #721c24 !important;
                border-color: #f5c6cb;
            }

            /* Device Name, Model, and Serial cells for print */
            .device-name-primary {
                font-weight: 700 !important;
                color: #000 !important;
            }

            .model-text {
                font-family: 'Courier New', monospace !important;
                font-size: 8pt !important;
                color: #2c3e50 !important;
                background: #f8f9fa !important;
                padding: 2px 6px !important;
                border: 1px solid #dee2e6 !important;
            }

            .serial-text {
                font-family: 'Courier New', monospace !important;
                font-size: 8pt !important;
                color: #000 !important;
                background: #f8f9fa !important;
                padding: 2px 6px !important;
                border-left: 2px solid #6366f1 !important;
            }

            /* Card view for print */
            .card-view-container {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                padding: 20px;
            }

            .device-card {
                page-break-inside: avoid;
                border: 2px solid #ddd;
                border-radius: 8px;
                padding: 12px;
                background: white !important;
            }

            .device-card-header {
                border-bottom: 2px solid #2c3e50;
                margin-bottom: 10px;
                padding-bottom: 8px;
            }

            .device-card-title {
                font-size: 11pt;
                font-weight: bold;
                color: #2c3e50 !important;
            }

            .device-card-region {
                font-size: 14pt;
            }

            .device-info-row {
                padding: 4px 0;
                display: flex;
                justify-content: space-between;
            }

            .device-info-label {
                font-size: 8pt;
                color: #666 !important;
                font-weight: 600;
            }

            .device-info-value {
                font-size: 8pt;
                color: #2c3e50 !important;
                font-family: 'Courier New', monospace;
            }

            /* Page headers and footers */
            @page {
                margin: 1cm;
                size: A4;
            }

            /* Print metadata */
            .print-header {
                display: block !important;
                text-align: right;
                font-size: 8pt;
                color: #666;
                margin-bottom: 10px;
                padding: 10px 20px;
                border-bottom: 1px solid #ddd;
            }

            /* No results message */
            .no-results {
                padding: 40px;
                text-align: center;
                font-size: 12pt;
                color: #666;
            }
        }

        .footer {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 2px solid #dee2e6;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }

        body.dark-mode .footer {
            background: #0f1419;
            border-top-color: #2d3748;
            color: #a0a0a0;
        }

        .keyboard-shortcuts {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .shortcut {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .key {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 2px 8px;
            font-family: monospace;
            font-size: 0.85em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        body.dark-mode .key {
            background: var(--dark-card);
            border-color: #2d3748;
        }

        /* Print metadata header - hidden by default */
        .print-header {
            display: none;
        }

        /* View Toggle Styles */
        .view-toggle {
            display: flex;
            gap: 5px;
            background: white;
            border-radius: 8px;
            padding: 5px;
            border: 2px solid #ddd;
        }

        body.dark-mode .view-toggle {
            background: var(--dark-card);
            border-color: #2d3748;
        }

        .view-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        body.dark-mode .view-btn {
            color: #a0a0a0;
        }

        .view-btn:hover {
            background: #f0f0f0;
        }

        body.dark-mode .view-btn:hover {
            background: #1a2332;
        }

        .view-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* Card View Styles */
        .card-view-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            padding: 30px;
        }

        .device-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid var(--primary-color);
            transition: all 0.3s;
        }

        body.dark-mode .device-card {
            background: var(--dark-card);
            border-left-color: var(--primary-color);
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .device-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        body.dark-mode .device-card-header {
            border-bottom-color: #2d3748;
        }

        .device-card-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }

        body.dark-mode .device-card-title {
            color: var(--dark-text);
        }

        .device-card-region {
            font-size: 1.5em;
        }

        .device-card-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .device-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .device-info-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-mode .device-info-label {
            color: #a0a0a0;
        }

        .device-info-value {
            font-family: monospace;
            font-size: 0.9em;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark-mode .device-info-value {
            color: var(--dark-text);
        }

        /* Export Menu Styles */
        .export-menu-container {
            position: relative;
            display: inline-block;
        }

        .export-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 220px;
            display: none;
            overflow: hidden;
        }

        body.dark-mode .export-dropdown {
            background: var(--dark-card);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .export-dropdown.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .export-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
        }

        body.dark-mode .export-option {
            border-bottom-color: #2d3748;
            color: var(--dark-text);
        }

        .export-option:last-child {
            border-bottom: none;
        }

        .export-option:hover {
            background: #f8f9fa;
        }

        body.dark-mode .export-option:hover {
            background: #1a2332;
        }

        .export-option-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }

        .export-option-text {
            flex: 1;
        }

        .export-option-title {
            font-weight: 600;
            font-size: 0.9em;
        }

        .export-option-desc {
            font-size: 0.75em;
            color: #666;
            margin-top: 2px;
        }

        body.dark-mode .export-option-desc {
            color: #a0a0a0;
        }

        /* Analytics Dashboard Styles */
        .analytics-dashboard {
            display: none;
            padding: 30px;
            background: #f8f9fa;
            border-top: 2px solid #dee2e6;
        }

        body.dark-mode .analytics-dashboard {
            background: #0f1419;
            border-top-color: #2d3748;
        }

        .analytics-dashboard.show {
            display: block;
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .analytics-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }

        body.dark-mode .analytics-title {
            color: var(--dark-text);
        }

        .toggle-analytics-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .toggle-analytics-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toggle-analytics-btn:hover::before {
            opacity: 1;
        }

        .toggle-analytics-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .toggle-analytics-btn:active {
            transform: translateY(0);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        body.dark-mode .chart-card {
            background: var(--dark-card);
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .chart-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        body.dark-mode .chart-title {
            color: var(--dark-text);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .insight-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border-left: 5px solid var(--primary-color);
        }

        body.dark-mode .insight-card {
            background: var(--dark-card);
        }

        .insight-card.warning {
            border-left-color: var(--warning-color);
        }

        .insight-card.danger {
            border-left-color: var(--danger-color);
        }

        .insight-card.success {
            border-left-color: var(--success-color);
        }

        .insight-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .insight-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        body.dark-mode .insight-title {
            color: var(--dark-text);
        }

        .insight-value {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .insight-description {
            font-size: 0.9em;
            color: #666;
            line-height: 1.5;
        }

        body.dark-mode .insight-description {
            color: #a0a0a0;
        }

        .site-health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .site-health-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        body.dark-mode .site-health-card {
            background: var(--dark-card);
        }

        .site-health-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .site-icon {
            font-size: 2.5em;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .site-icon.pdc {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .site-icon.bdc {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }

        .site-details {
            flex: 1;
        }

        .site-name {
            font-weight: 700;
            color: #2c3e50;
            font-size: 0.95em;
            margin-bottom: 5px;
        }

        body.dark-mode .site-name {
            color: var(--dark-text);
        }

        .site-status {
            font-size: 0.85em;
            color: #666;
        }

        body.dark-mode .site-status {
            color: #a0a0a0;
        }

        /* Import Button Styles */
        .import-btn {
            background: var(--primary-color);
            padding: 12px 24px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .import-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .import-menu-container {
            position: relative;
            display: inline-block;
        }

        .import-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 220px;
            display: none;
            overflow: hidden;
        }

        body.dark-mode .import-dropdown {
            background: var(--dark-card);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .import-dropdown.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        /* Import Modal Styles */
        .import-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            overflow-y: auto;
            backdrop-filter: blur(4px);
        }

        .import-modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .import-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            margin: 20px auto;
            border: 1px solid #e2e8f0;
            position: relative;
            z-index: 10000;
        }

        body.dark-mode .import-modal-content {
            background: var(--dark-card);
            border-color: #334155;
        }

        .import-modal-header {
            padding: 20px 24px;
            background: #1e293b;
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #0f172a;
        }

        body.dark-mode .import-modal-header {
            background: #0f172a;
            border-bottom-color: #020617;
        }

        .import-modal-title {
            font-size: 1.25em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .import-modal-close {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .import-modal-close:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
        }

        .import-modal-body {
            padding: 30px;
            background: white;
        }

        body.dark-mode .import-modal-body {
            background: var(--dark-bg);
        }

        .import-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        body.dark-mode .import-section {
            background: rgba(26, 35, 50, 0.3);
            border-color: #2d3748;
        }

        .import-section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        body.dark-mode .import-section-title {
            color: var(--dark-text);
            border-bottom-color: #2d3748;
        }

        .file-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: white;
            position: relative;
            overflow: hidden;
        }

        body.dark-mode .file-upload-area {
            background: rgba(26, 35, 50, 0.5);
            border-color: #2d3748;
        }

        .file-upload-area:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .file-upload-area.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
            border-style: solid;
        }

        .file-upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #64748b;
        }

        .file-upload-text {
            font-size: 1.1em;
            color: #1e293b;
            margin-bottom: 10px;
            font-weight: 500;
        }

        body.dark-mode .file-upload-text {
            color: #a0a0a0;
        }

        .file-upload-hint {
            font-size: 0.9em;
            color: #64748b;
        }

        .import-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .import-option-btn {
            padding: 12px 24px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #475569;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        body.dark-mode .import-option-btn {
            background: var(--dark-card);
            border-color: #2d3748;
        }

        .import-option-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
        }

        .import-option-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .import-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 20px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        body.dark-mode .import-preview {
            border-color: #2d3748;
            background: var(--dark-card);
        }

        .import-preview-table {
            width: 100%;
            font-size: 0.9em;
            border-collapse: collapse;
        }

        .import-preview-table th {
            background: #1e293b;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        body.dark-mode .import-preview-table th {
            background: #0f172a;
        }

        .import-preview-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
        }

        body.dark-mode .import-preview-table td {
            border-bottom-color: #2d3748;
            color: var(--dark-text);
        }

        .import-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .import-stat {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        body.dark-mode .import-stat {
            background: #1a2332;
        }

        .import-stat-value {
            font-size: 2em;
            font-weight: 600;
            color: #1e293b;
        }

        .import-stat-label {
            font-size: 0.85em;
            color: #64748b;
            margin-top: 5px;
            font-weight: 500;
        }

        body.dark-mode .import-stat-value {
            color: var(--dark-text);
        }

        body.dark-mode .import-stat-label {
            color: #a0a0a0;
        }

        .import-error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--danger-color);
        }

        body.dark-mode .import-error {
            background: rgba(220, 53, 69, 0.1);
            color: #ff6b6b;
        }

        .import-modal-footer {
            padding: 24px 30px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        body.dark-mode .import-modal-footer {
            background: #0f1419;
            border-top-color: #2d3748;
        }

        .import-modal-btn {
            padding: 10px 20px;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .import-modal-btn.cancel {
            background: white;
            color: #475569;
            border-color: #e2e8f0;
        }

        .import-modal-btn.cancel:hover {
            background: #f1f5f9;
            transform: translateY(-1px);
        }

        .import-modal-btn.confirm {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .import-modal-btn.confirm:hover {
            background: #059669;
            border-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
        }

        /* Enterprise Export Modal Styles - $500M App Quality */
        .export-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .export-modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        .export-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
        }

        body.dark-mode .export-modal-content {
            background: #1e293b;
            border: 1px solid #334155;
        }

        .export-modal-header {
            padding: 24px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
        }

        .export-modal-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .export-modal-subtitle {
            font-size: 0.95em;
            opacity: 0.9;
        }

        .export-modal-close {
            position: absolute;
            right: 20px;
            top: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .export-modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .export-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .export-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .export-option-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: white;
        }

        .export-option-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px rgba(102,126,234,0.5);
        }

        .export-option-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .export-option-icon {
            font-size: 2em;
            margin-bottom: 12px;
        }

        .export-option-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .export-option-desc {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .export-option-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .export-settings {
            background: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        body.dark-mode .export-settings {
            background: #0f172a;
        }

        .export-setting-group {
            margin-bottom: 20px;
        }

        .export-setting-label {
            font-size: 0.95em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #475569;
        }

        .export-preview {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 24px;
        }

        .export-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 24px 32px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        body.dark-mode .export-actions {
            background: #0f172a;
            border-top-color: #334155;
        }

        .export-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95em;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .export-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-width: 120px;
        }

        .export-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px rgba(102,126,234,0.5);
        }

        .export-btn-secondary {
            background: white;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .export-btn-secondary:hover {
            background: #f1f5f9;
        }

        /* Quick Export Toolbar */
        .quick-export-toolbar {
            position: fixed;
            right: 20px;
            bottom: 80px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .quick-export-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .quick-export-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .quick-export-btn.main {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        @media (max-width: 768px) {
            .header {
                padding: 25px 20px;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .logo-icon {
                width: 45px;
                height: 45px;
            }

            .header h1 {
                font-size: 2em;
            }

            .header .subtitle {
                font-size: 0.95em;
            }

            .header .last-updated {
                font-size: 0.85em;
            }

            .header-actions {
                width: 100%;
                justify-content: stretch;
                gap: 8px;
            }

            .header-actions button {
                flex: 1;
                padding: 10px 16px;
                font-size: 13px;
            }

            .search-container {
                flex-direction: column;
            }
            table {
                font-size: 0.9em;
            }
            th, td {
                padding: 10px;
            }
            .stats {
                grid-template-columns: 1fr;
            }
        }

        /* 🚨 NOC-SPECIFIC STYLES */

        /* Status badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-normal {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-minor {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-unknown {
            background-color: #e5e7eb;
            color: #374151;
        }

        .status-critical, .status-down {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-nostatus {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        body.dark-mode .status-normal {
            background-color: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        body.dark-mode .status-minor {
            background-color: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        body.dark-mode .status-unknown {
            background-color: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        body.dark-mode .status-critical,
        body.dark-mode .status-down {
            background-color: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        /* Health badge */
        .health-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 700;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            min-width: 50px;
            justify-content: center;
        }

        /* IP, Port, Age badges */
        .ip-cell, .port-badge, .age-badge, .firmware-text {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        .port-badge, .age-badge {
            padding: 4px 10px;
            background-color: #e0e7ff;
            color: #4338ca;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
            min-width: 40px;
            text-align: center;
        }

        body.dark-mode .port-badge,
        body.dark-mode .age-badge {
            background-color: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
        }

        /* Critical row highlighting */
        .critical-row {
            background-color: #fee2e2 !important;
            border-left: 4px solid #dc2626 !important;
        }

        .critical-row:hover {
            background-color: #fecaca !important;
        }

        body.dark-mode .critical-row {
            background-color: rgba(239, 68, 68, 0.15) !important;
            border-left: 4px solid #ef4444 !important;
        }

        body.dark-mode .critical-row:hover {
            background-color: rgba(239, 68, 68, 0.25) !important;
        }

        /* Offline row highlighting */
        .offline-row {
            background-color: #f3f4f6 !important;
            border-left: 4px solid #9ca3af !important;
            opacity: 0.85;
        }

        .offline-row:hover {
            background-color: #e5e7eb !important;
            opacity: 1;
        }

        body.dark-mode .offline-row {
            background-color: rgba(156, 163, 175, 0.1) !important;
            border-left: 4px solid #6b7280 !important;
        }

        body.dark-mode .offline-row:hover {
            background-color: rgba(156, 163, 175, 0.2) !important;
        }

        /* IP cell styling */
        .ip-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ip-text {
            color: #4338ca;
            font-weight: 500;
        }

        body.dark-mode .ip-text {
            color: #a5b4fc;
        }

        /* Firmware text */
        .firmware-text {
            color: #6b7280;
            font-size: 0.85em;
        }

        body.dark-mode .firmware-text {
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <div class="logo-container">
                        <div class="logo-icon"></div>
                        <h1>NetAssets <span style="font-size: 0.5em; opacity: 0.7; font-weight: 400;">v2.1 Global</span></h1>
                    </div>
                    <p class="subtitle">Global Network Device Inventory - Multi-Vendor, Multi-Region Smart Detection</p>
                    <p class="last-updated">Last Updated: <span id="lastUpdatedDate"></span></p>
                </div>
                <div class="header-actions">
                    <button class="toggle-analytics-btn" onclick="toggleAnalytics()">📊 Analytics Dashboard</button>
                    <button class="theme-toggle" onclick="toggleTheme()">🌓 Toggle Theme</button>
                </div>
            </div>
        </div>

        <div class="print-header">
            <div>Printed: <span id="printDate"></span></div>
            <div>Total Devices: <span id="printCount"></span></div>
        </div>

        <div class="controls">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="🔍 Search by device name or serial number...">
                    <button class="search-clear" id="searchClear" onclick="clearSearch()">✕</button>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('table')">📊 Table</button>
                    <button class="view-btn" onclick="switchView('card')">🗂️ Cards</button>
                </div>
                <div class="action-buttons">
                    <button class="bulk-copy-btn" onclick="bulkCopySerials()">📋 Copy All SNs</button>
                    <div class="import-menu-container">
                        <button class="import-btn" onclick="toggleImportMenu()">📤 Import ▼</button>
                        <div class="import-dropdown" id="importDropdown">
                            <div class="export-option" onclick="openImportModal('csv')">
                                <div class="export-option-icon">📄</div>
                                <div class="export-option-text">
                                    <div class="export-option-title">Import CSV</div>
                                    <div class="export-option-desc">Standard CSV format</div>
                                </div>
                            </div>
                            <div class="export-option" onclick="openImportModal('json')">
                                <div class="export-option-icon">📦</div>
                                <div class="export-option-text">
                                    <div class="export-option-title">Import JSON</div>
                                    <div class="export-option-desc">JSON data format</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="header-btn" onclick="showHelpMenu()" title="Help & Utilities">
                        ❓ Help
                    </button>
                    <button class="header-btn" onclick="showExportDiagnostics()" title="Export Diagnostics">
                        🔍 Diagnostics
                    </button>
                    <div class="export-menu-container">
                        <button class="export-btn" onclick="openExportModal()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                            <span style="margin-right: 6px;">💾</span>
                            Export Center
                        </button>
                        <div class="export-dropdown" id="exportDropdown" style="display: none;">
                            <div class="export-option" onclick="exportToCSV()">
                                <div class="export-option-icon">📄</div>
                                <div class="export-option-text">
                                    <div class="export-option-title">Standard CSV</div>
                                    <div class="export-option-desc">Excel compatible format</div>
                                </div>
                            </div>
                            <div class="export-option" onclick="exportToJSON()">
                                <div class="export-option-icon">📦</div>
                                <div class="export-option-text">
                                    <div class="export-option-title">JSON Format</div>
                                    <div class="export-option-desc">For APIs and automation</div>
                                </div>
                            </div>
                            <div class="export-option" onclick="exportToMarkdown()">
                                <div class="export-option-icon">📝</div>
                                <div class="export-option-text">
                                    <div class="export-option-title">Markdown Table</div>
                                    <div class="export-option-desc">For documentation</div>
                                </div>
                            </div>
                            <div class="export-option" onclick="exportToFormattedText()">
                                <div class="export-option-icon">📋</div>
                                <div class="export-option-text">
                                    <div class="export-option-title">Formatted Text</div>
                                    <div class="export-option-desc">NOC ticket format</div>
                                </div>
                            </div>
                            <div style="border-top: 1px solid #e0e0e0; margin: 8px 0;"></div>
                            <div class="export-option" onclick="exportToExcelNOC()">
                                <div class="export-option-icon">🔧</div>
                                <div class="export-option-text">
                                    <div class="export-option-title">Excel - NOC Technical</div>
                                    <div class="export-option-desc">Technical ops with stats</div>
                                </div>
                            </div>
                            <div class="export-option" onclick="exportToExcelCorporate()">
                                <div class="export-option-icon">📊</div>
                                <div class="export-option-text">
                                    <div class="export-option-title">Excel - Executive Report</div>
                                    <div class="export-option-desc">Professional corporate format</div>
                                </div>
                            </div>
                            <div class="export-option" onclick="exportInfrastructureAssetExcel()">
                                <div class="export-option-icon">📋</div>
                                <div class="export-option-text">
                                    <div class="export-option-title">Excel - Asset Inventory</div>
                                    <div class="export-option-desc">Editable asset list with core fields</div>
                                </div>
                            </div>
                            <!-- DISABLED: Health/Monitoring features removed
                            <div class="export-option" onclick="exportTechnicalAssessment()">
                                <div class="export-option-icon">🎯</div>
                                <div class="export-option-text">
                                    <div class="export-option-title">Technical Assessment</div>
                                    <div class="export-option-desc">Detailed risk & health analysis</div>
                                </div>
                            </div>
                            <div class="export-option" onclick="exportComplianceReport()">
                                <div class="export-option-icon">✅</div>
                                <div class="export-option-text">
                                    <div class="export-option-title">Compliance Report</div>
                                    <div class="export-option-desc">Policy compliance audit</div>
                                </div>
                            </div>
                            -->
                        </div>
                    </div>
                    <button class="print-btn" onclick="preparePrint(); window.print()">🖨️ Print</button>
                    <button class="clear-data-btn" onclick="clearAllData()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);">🗑️ Clear Data</button>
                </div>
            </div>

            <!-- 🚨 NOC Quick Filters -->
            <!-- Multi-Level Region Filter -->
            <div class="filter-section">
                <h3><span>🌍</span> Geographic Regions - Global</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByRegion('all', this)">
                        🌍 All Regions <span class="filter-badge" id="badge-region-all">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterByRegion('US', this)">
                        🇺🇸 United States <span class="filter-badge" id="badge-region-us">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterByRegion('EU', this)">
                        🇪🇺 Europe <span class="filter-badge" id="badge-region-eu">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterByRegion('APAC', this)">
                        🌏 Asia Pacific <span class="filter-badge" id="badge-region-apac">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterByRegion('LATAM', this)">
                        🌎 Latin America <span class="filter-badge" id="badge-region-latam">0</span>
                    </button>
                </div>
                <div class="filter-subgroup">
                    <h4>Countries/States - Auto-Detected from Data</h4>
                    <div class="filter-buttons compact" id="stateFiltersContainer">
                        <!-- Auto-populated from device data -->
                    </div>
                </div>
            </div>

            <!-- Vendor Filter -->
            <div class="filter-section">
                <h3><span>🏢</span> Vendor</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByVendor('all', this)">All Vendors <span class="filter-badge" id="badge-vendor-all">0</span></button>
                </div>
                <div class="filter-buttons compact" id="vendorFiltersContainer">
                    <!-- Auto-populated from device data -->
                </div>
            </div>

            <!-- Device Type Filter -->
            <div class="filter-section">
                <h3><span>🔌</span> Device Type</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByDeviceType('all', this)">All Types <span class="filter-badge" id="badge-type-all">0</span></button>
                </div>
                <div class="filter-buttons compact" id="deviceTypeFiltersContainer">
                    <!-- Auto-populated from device data -->
                </div>
            </div>

            <!-- Site Type Filter -->
            <div class="filter-section">
                <h3><span>🏢</span> Site Type</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterBySiteType('all', this)">All Sites <span class="filter-badge" id="badge-site-all">0</span></button>
                </div>
                <div class="filter-buttons compact" id="siteTypeFiltersContainer">
                    <!-- Auto-populated from device names -->
                </div>
            </div>

            <!-- Device Role Filter -->
            <div class="filter-section">
                <h3><span>🎯</span> Device Role</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByDeviceRole('all', this)">All Roles <span class="filter-badge" id="badge-role-all">0</span></button>
                </div>
                <div class="filter-buttons compact" id="deviceRoleFiltersContainer">
                    <!-- Auto-populated from device names -->
                </div>
            </div>

            <!-- Quick Access Filters -->
            <div class="filter-section">
                <h3><span>⚡</span> Quick Access</h3>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByQuickAccess('all', this)">All Devices <span class="filter-badge" id="badge-quick-all">0</span></button>
                </div>
                <div class="filter-buttons compact" id="quickAccessFiltersContainer">
                    <button class="filter-btn" onclick="quickFilterEnhanced('Firewall', event)">🔥 Firewalls <span class="filter-badge" id="badge-firewall">0</span></button>
                    <button class="filter-btn" onclick="quickFilterEnhanced('Router', event)">🔀 Routers <span class="filter-badge" id="badge-router">0</span></button>
                    <button class="filter-btn" onclick="quickFilterEnhanced('Switch', event)">🔗 Switches <span class="filter-badge" id="badge-switch">0</span></button>
                    <button class="filter-btn" onclick="quickFilterEnhanced('VPN', event)">🔐 VPN Gateway <span class="filter-badge" id="badge-vpn">0</span></button>
                    <button class="filter-btn" onclick="quickFilterEnhanced('Load Balancer', event)">⚖️ Load Balancers <span class="filter-badge" id="badge-loadbalancer">0</span></button>
                </div>
            </div>

            <!-- Critical Infrastructure Filter -->
            <div class="filter-section">
                <h3><span>🏢</span> Critical Sites</h3>
                <div class="filter-buttons compact">
                    <button class="filter-btn" onclick="quickFilterEnhanced('PDC', event)">🏢 Primary DC <span class="filter-badge" id="badge-pdc-quick">0</span></button>
                    <button class="filter-btn" onclick="quickFilterEnhanced('BDC', event)">🏢 Backup DC <span class="filter-badge" id="badge-bdc-quick">0</span></button>
                    <button class="filter-btn" onclick="quickFilterEnhanced('Cloud', event)">☁️ Cloud Sites <span class="filter-badge" id="badge-cloud-quick">0</span></button>
                </div>
            </div>

            <!-- Common Vendors Filter -->
            <div class="filter-section">
                <h3><span>🏷️</span> Top Vendors</h3>
                <div class="filter-buttons compact" id="topVendorsFiltersContainer">
                    <button class="filter-btn" onclick="quickFilterEnhanced('Cisco', event)">📡 Cisco <span class="filter-badge" id="badge-cisco-quick">0</span></button>
                    <button class="filter-btn" onclick="quickFilterEnhanced('Fortinet', event)">🔥 Fortinet <span class="filter-badge" id="badge-fortinet-quick">0</span></button>
                    <button class="filter-btn" onclick="quickFilterEnhanced('Palo Alto', event)">🛡️ Palo Alto <span class="filter-badge" id="badge-paloalto-quick">0</span></button>
                    <button class="filter-btn" onclick="quickFilterEnhanced('Juniper', event)">🌲 Juniper <span class="filter-badge" id="badge-juniper-quick">0</span></button>
                    <button class="filter-btn" onclick="quickFilterEnhanced('A10', event)">⚖️ A10 Networks <span class="filter-badge" id="badge-a10-quick">0</span></button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">📊 Total Devices</div>
                    <div class="stat-value" id="totalDevices">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">🇺🇸 US Devices</div>
                    <div class="stat-value" id="usDevices">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">🇪🇺 EU Devices</div>
                    <div class="stat-value" id="euDevices">0</div>
                </div>
                <div class="stat-card stat-success">
                    <div class="stat-label">✅ HA Configured</div>
                    <div class="stat-value" id="haDevices">0</div>
                </div>
                <div class="stat-card stat-danger">
                    <div class="stat-label">⚠️ Standalone</div>
                    <div class="stat-value" id="standaloneDevices">0</div>
                </div>
                <div class="stat-card stat-info">
                    <div class="stat-label">👁️ Currently Showing</div>
                    <div class="stat-value" id="visibleDevices">0</div>
                </div>
            </div>

        </div>

        <!-- Analytics Dashboard -->
        <div class="analytics-dashboard" id="analyticsDashboard">
            <div class="analytics-header">
                <h2 class="analytics-title">📊 Advanced Analytics & Insights</h2>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">🏢 Data Center Distribution</div>
                    <div class="chart-container">
                        <canvas id="dcChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">🔧 HA Configuration Status</div>
                    <div class="chart-container">
                        <canvas id="haChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">🌍 Regional Distribution</div>
                    <div class="chart-container">
                        <canvas id="regionChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">📦 Model Distribution</div>
                    <div class="chart-container">
                        <canvas id="modelChart"></canvas>
                    </div>
                </div>
            </div>

            <h3 class="chart-title" style="margin-top: 30px;">🔍 Key Insights</h3>
            <div class="insights-grid" id="insightsGrid"></div>

            <h3 class="chart-title" style="margin-top: 30px;">🏢 Critical Infrastructure Sites</h3>
            <div class="site-health-grid" id="siteHealthGrid"></div>
        </div>

        <div class="table-container" id="tableView">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <h3 style="margin: 0; color: #1e293b; font-size: 1.1em; font-weight: 600; letter-spacing: 0.025em;">
                        Network Inventory
                    </h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="background: #eff6ff; color: #1e40af; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600;">
                            <span id="tableRowCount">0</span> Devices
                        </span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="toggleCompactMode()" style="padding: 6px 12px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; color: #475569; font-size: 0.85em; cursor: pointer; transition: all 0.2s;">
                        📐 Compact View
                    </button>
                    <button onclick="exportVisibleTable()" style="padding: 6px 12px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; color: #475569; font-size: 0.85em; cursor: pointer; transition: all 0.2s;">
                        📥 Export View
                    </button>
                </div>
            </div>
            <div class="table-scroll-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width: 40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <!-- Identity Group -->
                            <th colspan="3" style="text-align: center; background: #0f172a; border-bottom: 3px solid #3730a3;">Identity</th>
                            <!-- Device Info Group -->
                            <th colspan="4" style="text-align: center; background: #0f172a; border-bottom: 3px solid #0369a1;">Device Details</th>
                            <!-- Location Group -->
                            <th colspan="2" style="text-align: center; background: #0f172a; border-bottom: 3px solid #059669;">Location</th>
                        </tr>
                        <tr>
                            <!-- Identity Group -->
                            <th onclick="sortTable(0)">Device Name</th>
                            <th onclick="sortTable(1)">IP Address</th>
                            <th onclick="sortTable(2)">Serial #</th>
                            <!-- Device Info Group -->
                            <th onclick="sortTable(3)">Vendor</th>
                            <th onclick="sortTable(4)">Type</th>
                            <th onclick="sortTable(5)">Model</th>
                            <th onclick="sortTable(6)">Firmware</th>
                            <!-- Location Group -->
                            <th onclick="sortTable(7)">Region</th>
                            <th onclick="sortTable(8)">Site/Role</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div id="noResults" class="no-results" style="display: none;">
                🔍 No devices found matching your search criteria.
            </div>
        </div>

        <div class="card-view-container" id="cardView" style="display: none;">
            <!-- Cards will be rendered here -->
        </div>

        <div class="footer">
            <p><strong>NetAssets</strong> - Network Device Inventory Dashboard</p>
            <div class="keyboard-shortcuts">
                <div class="shortcut">
                    <span class="key">Ctrl</span> + <span class="key">F</span>
                    <span>Focus Search</span>
                </div>
                <div class="shortcut">
                    <span class="key">Ctrl</span> + <span class="key">K</span>
                    <span>Clear Filters</span>
                </div>
                <div class="shortcut">
                    <span class="key">Ctrl</span> + <span class="key">P</span>
                    <span>Print</span>
                </div>
            </div>
            <p style="font-size: 0.8em; margin-top: 15px; opacity: 0.6; text-align: center; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 15px;">
                Developed by Miguel Jimenez
            </p>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="import-modal" id="importModal" onclick="if(event.target === this) closeImportModal()">
        <div class="import-modal-content">
            <div class="import-modal-header">
                <div class="import-modal-title">📤 Import Global Network Inventory</div>
                <button class="import-modal-close" onclick="closeImportModal()">✕</button>
            </div>
            <div class="import-modal-body">
                <div class="import-section">
                    <div class="import-section-title">📁 Select Data Source</div>
                    <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                        <div class="file-upload-icon">📂</div>
                        <div class="file-upload-text">Click to browse or drag and drop file here</div>
                        <div class="file-upload-hint">
                            <strong>Supported Formats:</strong> CSV, JSON<br>
                            <strong>Auto-Detection:</strong> Vendor, Model, Location (Global)<br>
                            <strong>Regions:</strong> US, EU, APAC, LATAM
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".csv,.json,.xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                </div>

                <div class="import-section">
                    <div class="import-section-title">🌍 Smart Detection Features</div>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em; line-height: 1.6;">
                        <div style="margin-bottom: 8px;"><strong>✅ Automatic Detection:</strong></div>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li>Vendor identification from serial numbers and device names</li>
                            <li>Model detection from product codes</li>
                            <li>Geographic location from device naming conventions</li>
                            <li>Site type classification (PDC, BDC, HQ, Branch, etc.)</li>
                            <li>Device role identification (VPN, WAN Edge, DMZ, etc.)</li>
                        </ul>
                        <div style="margin-top: 10px;"><strong>🌐 Global Region Support:</strong></div>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li><strong>Americas:</strong> US (all 50 states), Canada, Mexico, Brazil, Argentina</li>
                            <li><strong>Europe:</strong> UK, Germany, France, Italy, Spain, Netherlands, and more</li>
                            <li><strong>Asia-Pacific:</strong> Japan, Singapore, Australia, India, China, Korea</li>
                            <li><strong>Latin America:</strong> Brazil, Mexico, Argentina, Chile, Colombia</li>
                        </ul>
                    </div>
                </div>

                <div class="import-section" id="importOptionsSection" style="display: none;">
                    <div class="import-section-title">⚙️ Import Options</div>
                    <div class="import-options">
                        <button class="import-option-btn active" data-option="replace" onclick="selectImportOption('replace')">
                            🔄 Replace All Data
                        </button>
                        <button class="import-option-btn" data-option="append" onclick="selectImportOption('append')">
                            ➕ Append to Existing
                        </button>
                    </div>
                </div>

                <div class="import-section" id="importPreviewSection" style="display: none;">
                    <div class="import-section-title">👁️ Data Preview</div>
                    <div class="import-stats" id="importStats"></div>
                    <div class="import-preview" id="importPreview"></div>
                </div>

                <div id="importError" style="display: none;"></div>
            </div>
            <div class="import-modal-footer">
                <button class="import-modal-btn cancel" onclick="closeImportModal()">Cancel</button>
                <button class="import-modal-btn confirm" id="confirmImportBtn" onclick="confirmImport()" disabled>Import Data</button>
            </div>
        </div>
    </div>

    <!-- Enterprise Export Modal - $500M App Quality -->
    <div class="export-modal" id="exportModal" onclick="if(event.target === this) closeExportModal()">
        <div class="export-modal-content">
            <div class="export-modal-header">
                <button class="export-modal-close" onclick="closeExportModal()">✕</button>
                <div class="export-modal-title">🚀 Enterprise Export Center</div>
                <div class="export-modal-subtitle">Export your network inventory with professional-grade formatting</div>
            </div>
            <div class="export-modal-body">
                <div class="export-settings">
                    <div class="export-setting-group">
                        <div class="export-setting-label">📊 Data Scope</div>
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="radio" name="exportScope" value="all" checked onchange="updateExportPreview()">
                            <span>All devices (${deviceData ? deviceData.length : 0} total)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <input type="radio" name="exportScope" value="filtered" onchange="updateExportPreview()">
                            <span>Currently filtered (${filteredData ? filteredData.length : 0} devices)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="exportScope" value="selected" onchange="updateExportPreview()">
                            <span>Selected devices (${selectedRows ? selectedRows.size : 0} selected)</span>
                        </label>
                    </div>
                    <div class="export-setting-group">
                        <div class="export-setting-label">🎯 Export Template</div>
                        <select id="exportTemplate" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0;" onchange="updateExportPreview()">
                            <option value="standard">Standard Report</option>
                            <option value="executive">Executive Summary</option>
                            <option value="technical">Technical Deep Dive</option>
                            <option value="compliance">Compliance Audit</option>
                            <option value="migration">Migration Planning</option>
                        </select>
                    </div>
                </div>

                <div class="export-options-grid">
                    <div class="export-option-card" onclick="selectExportFormat('csv')">
                        <div class="export-option-icon">📄</div>
                        <div class="export-option-name">CSV</div>
                        <div class="export-option-desc">Excel-compatible spreadsheet</div>
                    </div>
                    <div class="export-option-card" onclick="selectExportFormat('json')">
                        <div class="export-option-icon">📦</div>
                        <div class="export-option-name">JSON</div>
                        <div class="export-option-desc">API-ready data format</div>
                    </div>
                    <div class="export-option-card" onclick="selectExportFormat('pdf')">
                        <div class="export-option-badge">PREMIUM</div>
                        <div class="export-option-icon">📑</div>
                        <div class="export-option-name">PDF Report</div>
                        <div class="export-option-desc">Print-ready professional report</div>
                    </div>
                    <!-- DISABLED: Health/Monitoring features removed
                    <div class="export-option-card" onclick="selectExportFormat('executive')">
                        <div class="export-option-badge">EXECUTIVE</div>
                        <div class="export-option-icon">📊</div>
                        <div class="export-option-name">Executive HTML</div>
                        <div class="export-option-desc">Interactive dashboard report</div>
                    </div>
                    <div class="export-option-card" onclick="selectExportFormat('technical')">
                        <div class="export-option-icon">⚙️</div>
                        <div class="export-option-name">Technical HTML</div>
                        <div class="export-option-desc">Detailed technical assessment</div>
                    </div>
                    <div class="export-option-card" onclick="selectExportFormat('compliance')">
                        <div class="export-option-icon">✅</div>
                        <div class="export-option-name">Compliance Report</div>
                        <div class="export-option-desc">Audit-ready documentation</div>
                    </div>
                    -->
                    <div class="export-option-card" onclick="selectExportFormat('markdown')">
                        <div class="export-option-icon">📝</div>
                        <div class="export-option-name">Markdown</div>
                        <div class="export-option-desc">Documentation format</div>
                    </div>
                    <div class="export-option-card" onclick="selectExportFormat('asset-inventory')">
                        <div class="export-option-icon">📋</div>
                        <div class="export-option-name">Asset Inventory</div>
                        <div class="export-option-desc">Editable Excel with core fields</div>
                    </div>
                    <div class="export-option-card" onclick="selectExportFormat('powerpoint')">
                        <div class="export-option-badge">COMING SOON</div>
                        <div class="export-option-icon">📺</div>
                        <div class="export-option-name">PowerPoint</div>
                        <div class="export-option-desc">Presentation-ready slides</div>
                    </div>
                </div>

                <div style="margin-top: 24px;">
                    <div class="export-setting-label">📋 Preview</div>
                    <div class="export-preview" id="exportPreview">
                        Select an export format to see preview...
                    </div>
                </div>
            </div>
            <div class="export-actions">
                <button class="export-btn export-btn-secondary" onclick="closeExportModal()">Cancel</button>
                <button class="export-btn export-btn-primary" id="exportExecuteBtn" onclick="executeExport()">
                    Export Now
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Export Toolbar -->
    <div class="quick-export-toolbar">
        <button class="quick-export-btn" onclick="quickExport('csv')" title="Quick CSV Export">
            📄
        </button>
        <button class="quick-export-btn" onclick="quickExport('pdf')" title="Quick PDF Export">
            📑
        </button>
        <button class="quick-export-btn main" onclick="openExportModal()" title="Export Center">
            💾
        </button>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="hiddenFileInput" accept=".csv,.json,.xlsx,.xls" style="display: none;">

    <!-- Uncomment below to preload CSV data -->
    <!-- <script src="device_data_combined.js"></script> -->
    <script>
        // Version and Debug Info
        const APP_VERSION = '2.1.1';
        const BUILD_DATE = '2025-01-25';
        console.log(`%c🚀 NetAssets v${APP_VERSION}`, 'color: #10b981; font-size: 16px; font-weight: bold;');
        console.log(`%c📅 Build Date: ${BUILD_DATE}`, 'color: #6366f1; font-size: 12px;');
        console.log('%c💡 CSV Import Fix: Model and Serial Number fields now preserve CSV data correctly', 'color: #f59e0b; font-size: 12px;');
        console.log('%c🔍 Enable "Preserve log" in DevTools to see import debugging', 'color: #8b5cf6; font-size: 12px;');
        console.log('%c🐛 Enhanced debugging: Now showing full data flow from CSV → Import → Render', 'color: #ec4899; font-size: 12px;');
        console.log('');

        let deviceData = [];
        let filteredData = [];
        let selectedRows = new Set();
        let currentFilter = 'all';
        let currentRegion = 'all';
        let currentVendor = 'all';
        let currentDeviceType = 'all';
        let currentSiteType = 'all';
        let currentDeviceRole = 'all';
        let currentNOCStatus = 'all';  // 🚨 NOC filter
        let sortColumn = 0;
        let sortAscending = true;

        // ============================================
        // COMPREHENSIVE DATA MAPPING SYSTEM - $5M Edition
        // ============================================

        // Device Category ID to Device Type Mapping (from CSV analysis)
        const DEVICE_CATEGORY_MAP = {
            '685': 'UPS',
            '688': 'Firewall',
            '691': 'Switch',
            '692': 'Switch',
            '694': 'Switch',
            '695': 'Switch',
            '696': 'Router',
            '699': 'Firewall',
            '703': 'Load Balancer'
        };

        // Device Vendor ID to Vendor Name Mapping
        const VENDOR_ID_MAP = {
            '1924': 'APC',
            '1925': 'APC',
            '3038': 'Cisco',
            '705': 'A10 Networks',
            '706': 'A10 Networks',
            '7652': 'Fortinet',
            '7653': 'Fortinet',
            '7655': 'Fortinet',
            '11348': 'Juniper',
            '11537': 'Juniper',
            '11579': 'Juniper',
            '11800': 'Juniper',
            '12162': 'Palo Alto Networks'
        };

        // Vendor Icons Mapping
        const VENDOR_ICONS = {
            'Cisco': '📡',
            'Fortinet': '🔥',
            'Juniper': '🌲',
            'Juniper Networks': '🌲',
            'Palo Alto Networks': '🛡️',
            'A10 Networks': '⚖️',
            'APC': '🔌',
            'American Power Conversion': '🔌',
            'Check Point': '✅',
            'F5 Networks': '⚖️',
            'Net-SNMP': '🔧',
            'Arista Networks': '🌐',
            'IBM': '💼',
            'Lantronix': '🔌',
            'Silver Peak Systems': '🏔️',
            'VMware': '☁️',
            'Unknown': '❓'
        };

        // Device Type Icons Mapping
        const DEVICE_TYPE_ICONS = {
            'Firewall': '🔥',
            'Router': '🔀',
            'Switch': '🔗',
            'Load Balancer': '⚖️',
            'UPS': '🔌',
            'Unknown': '❓'
        };

        // Site Type Icons and Labels
        const SITE_TYPE_INFO = {
            'PDC': { icon: '🏢', label: 'Primary DC' },
            'BDC': { icon: '🏢', label: 'Backup DC' },
            'CAT': { icon: '📁', label: 'CAT Sites' },
            'HQ': { icon: '🏛️', label: 'Headquarters' },
            'Branch': { icon: '🏪', label: 'Branch' },
            'Remote': { icon: '📡', label: 'Remote' },
            'Cloud': { icon: '☁️', label: 'Cloud' },
            'Colo': { icon: '🏭', label: 'Colocation' },
            'Other': { icon: '📍', label: 'Other' }
        };

        // Device Role Icons and Labels
        const DEVICE_ROLE_INFO = {
            'VPN Gateway': { icon: '🔐', label: 'VPN Gateway' },
            'WAN Edge': { icon: '🌐', label: 'WAN Edge' },
            'DMZ Firewall': { icon: '🛡️', label: 'DMZ Firewall' },
            'Internet Edge': { icon: '🌍', label: 'Internet Edge' },
            'Access': { icon: '🚪', label: 'Access' },
            'Core': { icon: '⚙️', label: 'Core' },
            'Distribution': { icon: '🔄', label: 'Distribution' },
            'Firewall': { icon: '🔥', label: 'Firewall' },
            'Load Balancer': { icon: '⚖️', label: 'Load Balancer' },
            'General Purpose': { icon: '📦', label: 'General Purpose' }
        };

        // ============================================
        // INTELLIGENT AUTO-DETECTION FUNCTIONS
        // ============================================

        // Normalize vendor names (consolidate duplicates, filter out software)
        function normalizeVendor(vendorName) {
            if (!vendorName) return null;

            const vendor = vendorName.trim();
            const lowerVendor = vendor.toLowerCase();

            // Filter out software/agent names (not hardware vendors)
            const softwareVendors = ['net-snmp', 'snmp', 'linux', 'windows', 'ubuntu'];
            if (softwareVendors.some(sw => lowerVendor === sw)) {
                return null; // Filtered out
            }

            // Consolidate duplicate vendor names
            if (lowerVendor === 'american power conversion') return 'APC';
            if (lowerVendor === 'apc' || lowerVendor.includes('american power')) return 'APC';
            if (lowerVendor === 'juniper networks' || lowerVendor === 'juniper') return 'Juniper Networks';

            return vendor; // Return as-is
        }

        // Detect vendor from CSV fields (Device Vendor ID + System Description fallback)
        function detectVendorFromCSV(device) {
            // Try the vendor field if it's a numeric ID in our map (most common case)
            if (device.vendor && VENDOR_ID_MAP[device.vendor.trim()]) {
                return VENDOR_ID_MAP[device.vendor.trim()];
            }

            // Try Device Vendor ID field (alternative column name)
            if (device.deviceVendor && VENDOR_ID_MAP[device.deviceVendor.trim()]) {
                return VENDOR_ID_MAP[device.deviceVendor.trim()];
            }

            // Try the vendor field if it's a non-numeric name (with normalization)
            if (device.vendor && !/^\d+$/.test(device.vendor.trim())) {
                const normalized = normalizeVendor(device.vendor);
                if (normalized) return normalized;
            }

            // Try the deviceVendor field if it's a non-numeric name (with normalization)
            if (device.deviceVendor && !/^\d+$/.test(device.deviceVendor.trim())) {
                const normalized = normalizeVendor(device.deviceVendor);
                if (normalized) return normalized;
            }

            // Fallback to System Description field
            const sysDesc = (device.systemDescription || '').toLowerCase();
            if (sysDesc.includes('cisco')) return 'Cisco';
            if (sysDesc.includes('fortinet') || sysDesc.includes('fortigate')) return 'Fortinet';
            if (sysDesc.includes('juniper')) return 'Juniper';
            if (sysDesc.includes('palo alto') || sysDesc.includes('pan-os')) return 'Palo Alto Networks';
            if (sysDesc.includes('a10') || sysDesc.includes('thunder') || sysDesc.includes('ax series')) return 'A10 Networks';
            if (sysDesc.includes('apc')) return 'APC';
            if (sysDesc.includes('checkpoint') || sysDesc.includes('check point')) return 'Check Point';
            if (sysDesc.includes('f5')) return 'F5 Networks';

            // Tertiary fallback to device name
            const name = (device.deviceName || '').toLowerCase();
            if (name.includes('cisco') || name.includes('cis-')) return 'Cisco';
            if (name.includes('forti') || name.includes('fg-') || name.includes('fgt')) return 'Fortinet';
            if (name.includes('juniper') || name.includes('jun-') || name.includes('srx') || name.includes('ex-')) return 'Juniper';
            if (name.includes('palo') || name.includes('pa-')) return 'Palo Alto Networks';
            if (name.includes('a10')) return 'A10 Networks';
            if (name.includes('apc') || name.includes('ups')) return 'APC';

            // ENHANCED: Detect Cisco from model numbers in device name
            // Common Cisco model patterns: 2960, 3560, 3750, 4500, 6500, 6513, ASA, ISR
            if (name.match(/\b(29\d{2}|35\d{2}|37\d{2}|45\d{2}|65\d{2}|asa|isr|cat|catalyst)\b/)) {
                return 'Cisco';
            }

            // Detect from other common model patterns
            if (name.match(/\b(srx\d+|ex\d+|mx\d+)\b/)) return 'Juniper Networks';  // Juniper SRX, EX, MX series
            if (name.match(/\bfg-?\d+/)) return 'Fortinet';  // FortiGate models

            // Detect IPC/Security devices - common vendors
            if (name.match(/^(ipc|ipg|atc|atg)-/i)) {
                // Check for specific vendor patterns in device name or description
                if (sysDesc.includes('axis')) return 'Axis Communications';
                if (sysDesc.includes('hikvision') || sysDesc.includes('hik')) return 'Hikvision';
                if (sysDesc.includes('dahua')) return 'Dahua';
                if (sysDesc.includes('hanwha') || sysDesc.includes('samsung')) return 'Hanwha';
                if (sysDesc.includes('bosch')) return 'Bosch';
                if (sysDesc.includes('avigilon')) return 'Avigilon';
                // If no vendor detected from description, mark as Unknown (vendor must be in Excel)
            }

            // Log unmapped vendor IDs for debugging
            if (device.vendor && /^\d+$/.test(device.vendor.trim())) {
                console.warn('⚠️ Unmapped vendor ID in "Vendor" column:', device.vendor, 'for device:', device.deviceName);
            }
            if (device.deviceVendor && /^\d+$/.test(device.deviceVendor.trim())) {
                console.warn('⚠️ Unmapped vendor ID in "Device Vendor" column:', device.deviceVendor, 'for device:', device.deviceName);
            }

            return 'Unknown';
        }

        // ==================================================================================
        // ENHANCED MODEL NUMBER EXTRACTION FROM DEVICE NAME
        // ==================================================================================
        function extractModelFromDeviceName(deviceName) {
            if (!deviceName) return 'Unknown';

            const name = deviceName.toUpperCase();

            // Cisco Catalyst models: 2960, 3560, 3750, 4500, 6500, 6513, etc.
            const ciscoMatch = name.match(/\b(CATALYST\s*)?(\d{4})\b/);
            if (ciscoMatch) {
                return `Catalyst ${ciscoMatch[2]}`;
            }

            // Juniper models: SRX, EX, MX series
            const juniperMatch = name.match(/\b(SRX|EX|MX)(\d+)\b/i);
            if (juniperMatch) {
                return `${juniperMatch[1].toUpperCase()}${juniperMatch[2]}`;
            }

            // FortiGate models
            const fortiMatch = name.match(/\bFG-?(\d+[A-Z]?)\b/i);
            if (fortiMatch) {
                return `FortiGate-${fortiMatch[1]}`;
            }

            // A10 Thunder models
            const a10Match = name.match(/\b(THUNDER|AX)(\d+)\b/i);
            if (a10Match) {
                return `${a10Match[1]} ${a10Match[2]}`;
            }

            // IPC/Security device models: EC-M01, M01, M02, etc.
            const ipcMatch = name.match(/\b(EC|M|P|S)-?([A-Z]?\d+[A-Z]?)\b/i);
            if (ipcMatch && name.match(/^(IPC|IPG|ATC|ATG)-/i)) {
                return `${ipcMatch[1]}-${ipcMatch[2]}`.toUpperCase();
            }

            // Palo Alto models: PA-220, PA-3020, etc.
            const paloMatch = name.match(/\bPA-(\d+[A-Z]?)\b/i);
            if (paloMatch) {
                return `PA-${paloMatch[1]}`;
            }

            // Generic number pattern (like "6513" in "AUSTXDCA6513SW2")
            const genericMatch = name.match(/\b(\d{4})\b/);
            if (genericMatch) {
                return genericMatch[1];
            }

            return 'Unknown';
        }

        // ==================================================================================
        // COMPREHENSIVE DEVICE NAME PARSER
        // Extracts: Location (City/State), Site Type, Model, Device Role
        // ==================================================================================
        function parseDeviceNameComprehensive(deviceName) {
            const result = {
                city: '',
                state: '',
                stateCode: '',
                siteType: '',
                model: '',
                deviceRole: '',
                deviceNumber: ''
            };

            if (!deviceName) return result;

            const name = deviceName.toUpperCase();
            const nameLower = deviceName.toLowerCase();

            // PATTERN 1: AUSTXDCA6513SW2 format
            // City(3-4 chars) + State(2 chars) + Site + Model + Type + Number
            const pattern1 = name.match(/^([A-Z]{3,4})(TX|CA|NY|FL|RI|NV|IL|CO|GA|TN|KY|MI|IN|WI|MN|OH|NC|SC|VA|MD|PA|NJ|MA|CT)([A-Z]+)(\d{4})([A-Z]+)(\d+)$/);
            if (pattern1) {
                const cityCode = pattern1[1];
                result.stateCode = pattern1[2];
                result.siteType = pattern1[3];
                result.model = pattern1[4];
                const deviceType = pattern1[5];
                result.deviceNumber = pattern1[6];

                // Map city codes
                const cityMap = {
                    'AUST': 'Austin', 'AUS': 'Austin',
                    'HOUS': 'Houston', 'HOU': 'Houston',
                    'DALL': 'Dallas', 'DAL': 'Dallas',
                    'GERM': 'Germantown',
                    'PROV': 'Providence',
                    'WGWI': 'West Greenwich',
                    'CHAR': 'Charlotte',
                    'ATLA': 'Atlanta', 'ATL': 'Atlanta'
                };
                result.city = cityMap[cityCode] || '';

                // Map state codes
                const stateMap = {
                    'TX': 'Texas', 'CA': 'California', 'NY': 'New York', 'FL': 'Florida',
                    'RI': 'Rhode Island', 'NV': 'Nevada', 'IL': 'Illinois', 'CO': 'Colorado',
                    'GA': 'Georgia', 'TN': 'Tennessee', 'KY': 'Kentucky', 'MI': 'Michigan'
                };
                result.state = stateMap[result.stateCode] || result.stateCode;

                // Map device type codes
                if (deviceType === 'SW') result.deviceRole = 'Switch';
                else if (deviceType === 'RTR') result.deviceRole = 'Router';
                else if (deviceType === 'FW') result.deviceRole = 'Firewall';

                return result;
            }

            // PATTERN 2: RI-NMS-2960-Sw4 format
            // State-Site-Model-Type+Number
            const pattern2 = name.match(/^([A-Z]{2})-([A-Z]+)-(\d{4})-(SW|RTR|FW)(\d+)$/i);
            if (pattern2) {
                result.stateCode = pattern2[1];
                result.siteType = pattern2[2];
                result.model = pattern2[3];
                const deviceType = pattern2[4].toUpperCase();
                result.deviceNumber = pattern2[5];

                const stateMap = {
                    'TX': 'Texas', 'CA': 'California', 'NY': 'New York', 'FL': 'Florida',
                    'RI': 'Rhode Island', 'NV': 'Nevada', 'IL': 'Illinois', 'CO': 'Colorado',
                    'GA': 'Georgia', 'TN': 'Tennessee', 'KY': 'Kentucky', 'MI': 'Michigan'
                };
                result.state = stateMap[result.stateCode] || result.stateCode;

                if (deviceType === 'SW') result.deviceRole = 'Switch';
                else if (deviceType === 'RTR') result.deviceRole = 'Router';
                else if (deviceType === 'FW') result.deviceRole = 'Firewall';

                return result;
            }

            // PATTERN 4: IPC-{JURISDICTION}-{SITE}-{MODEL} format
            // Industrial/IP Camera naming: IPC-RISP-EC-M01, IPC-TXSP-EC-M02
            // Prefix-Jurisdiction-Site-Model
            const pattern4 = name.match(/^(IPC|IPG|ATC|ATG)-([A-Z]{4})-([A-Z]+)-([A-Z0-9]+)$/i);
            if (pattern4) {
                const devicePrefix = pattern4[1].toUpperCase();  // IPC, IPG, ATC, ATG
                const jurisdictionCode = pattern4[2].toUpperCase();  // RISP, TXSP, etc.
                result.siteType = pattern4[3];  // EC, M01, etc.
                result.model = pattern4[4];

                // Jurisdiction code mapping
                const jurisdictionMap = {
                    'RISP': { state: 'Rhode Island', stateCode: 'RI', jurisdiction: 'RI Sports' },
                    'TXSP': { state: 'Texas', stateCode: 'TX', jurisdiction: 'TX Sports' },
                    'CASP': { state: 'California', stateCode: 'CA', jurisdiction: 'CA Sports' },
                    'FLSP': { state: 'Florida', stateCode: 'FL', jurisdiction: 'FL Sports' },
                    'NYSP': { state: 'New York', stateCode: 'NY', jurisdiction: 'NY Sports' },
                    'NVSP': { state: 'Nevada', stateCode: 'NV', jurisdiction: 'NV Sports' },
                    'ILSP': { state: 'Illinois', stateCode: 'IL', jurisdiction: 'IL Sports' },
                    'COSP': { state: 'Colorado', stateCode: 'CO', jurisdiction: 'CO Sports' }
                };

                if (jurisdictionMap[jurisdictionCode]) {
                    result.state = jurisdictionMap[jurisdictionCode].state;
                    result.stateCode = jurisdictionMap[jurisdictionCode].stateCode;
                }

                // Device role based on prefix
                if (devicePrefix === 'IPC' || devicePrefix === 'IPG') {
                    result.deviceRole = 'IP Camera';
                } else if (devicePrefix === 'ATC' || devicePrefix === 'ATG') {
                    result.deviceRole = 'Access Control';
                }

                return result;
            }

            // PATTERN 3: NEW-NLV-HNS-HUB-SW1 format
            // State-City-Site-Type-Device
            if (name.includes('-')) {
                const parts = name.split('-');

                // Check for state codes
                const stateMap = {
                    'NEW': 'Nevada', 'NV': 'Nevada',
                    'TX': 'Texas', 'TN': 'Tennessee',
                    'RI': 'Rhode Island', 'CA': 'California'
                };

                // Check for city codes
                const cityMap = {
                    'NLV': 'North Las Vegas', 'LV': 'Las Vegas',
                    'AUS': 'Austin', 'AUST': 'Austin'
                };

                // Parse parts
                if (parts[0] && stateMap[parts[0]]) {
                    result.state = stateMap[parts[0]];
                    result.stateCode = parts[0].length === 2 ? parts[0] : '';
                }
                if (parts[1] && cityMap[parts[1]]) {
                    result.city = cityMap[parts[1]];
                }

                // Check for site types (HNS, HUB, DCA, NOC, etc.)
                for (const part of parts) {
                    if (['HNS', 'HUB', 'DCA', 'NOC', 'PDC', 'BDC'].includes(part)) {
                        result.siteType = part;
                        break;
                    }
                }

                // Check for device type in last part
                const lastPart = parts[parts.length - 1];
                if (lastPart.match(/SW\d+/i)) result.deviceRole = 'Switch';
                else if (lastPart.match(/RTR\d+/i)) result.deviceRole = 'Router';
                else if (lastPart.match(/FW\d+/i)) result.deviceRole = 'Firewall';
            }

            // Extract model if not already found
            if (!result.model) {
                result.model = extractModelFromDeviceName(deviceName);
            }

            return result;
        }

        // Detect device type from Device Category
        function detectDeviceTypeFromCSV(device) {
            // Try the deviceType field if it's a numeric category ID in our map (most common case)
            if (device.deviceType && DEVICE_CATEGORY_MAP[device.deviceType.trim()]) {
                return DEVICE_CATEGORY_MAP[device.deviceType.trim()];
            }

            // Try Device Category field (alternative column name)
            if (device.deviceCategory && DEVICE_CATEGORY_MAP[device.deviceCategory.trim()]) {
                return DEVICE_CATEGORY_MAP[device.deviceCategory.trim()];
            }

            // Try the deviceType field if it's a non-numeric name
            if (device.deviceType && !/^\d+$/.test(device.deviceType.trim())) {
                return device.deviceType.trim();
            }

            // Fallback to device name patterns
            const name = (device.deviceName || '').toUpperCase();
            if (name.includes('FW') || name.includes('FIREWALL')) return 'Firewall';
            if (name.includes('RTR') || name.includes('ROUTER')) return 'Router';
            if (name.includes('SW') || name.includes('SWITCH')) return 'Switch';
            if (name.includes('LB') || name.includes('A10')) return 'Load Balancer';
            if (name.includes('UPS')) return 'UPS';

            // Tertiary fallback to System Description
            const sysDesc = (device.systemDescription || '').toLowerCase();
            if (sysDesc.includes('firewall') || sysDesc.includes('pix') || sysDesc.includes('asa') || sysDesc.includes('fortigate')) return 'Firewall';
            if (sysDesc.includes('router') || sysDesc.includes('ios software')) return 'Router';
            if (sysDesc.includes('switch') || sysDesc.includes('catalyst')) return 'Switch';
            if (sysDesc.includes('load balancer') || sysDesc.includes('thunder') || sysDesc.includes('ax series')) return 'Load Balancer';
            if (sysDesc.includes('ups') || sysDesc.includes('apc')) return 'UPS';

            // Log unmapped category IDs for debugging
            if (device.deviceType && /^\d+$/.test(device.deviceType.trim())) {
                console.warn('⚠️ Unmapped device type ID in "Type" column:', device.deviceType, 'for device:', device.deviceName);
            }
            if (device.deviceCategory && /^\d+$/.test(device.deviceCategory.trim())) {
                console.warn('⚠️ Unmapped device category ID in "Device Category" column:', device.deviceCategory, 'for device:', device.deviceName);
            }

            return 'Unknown';
        }

        // Extract state name from tenant field
        function extractStateFromTenant(tenantName) {
            if (!tenantName || tenantName === 'Default Tenant') return 'Unknown';

            // Remove "_Tenant" suffix and clean up
            let state = tenantName.replace(/_Tenant$/i, '').replace(/_/g, ' ').trim();

            // Handle special cases
            if (state === 'DCA Hosted Services') return 'DCA';
            if (state === 'NRC') return 'NRC';

            return state;
        }

        // ============================================
        // AUTO-POPULATION OF FILTER SECTIONS
        // ============================================

        function populateAllFilters() {
            console.log('populateAllFilters called, deviceData.length:', deviceData.length);
            if (deviceData.length === 0) {
                console.warn('populateAllFilters: No data to populate');
                return;
            }

            try {
                populateStateFilters();
                populateVendorFilters();
                populateDeviceTypeFilters();
                populateSiteTypeFilters();
                populateDeviceRoleFilters();
                console.log('✓ All filters populated successfully');
            } catch (error) {
                console.error('Error populating filters:', error);
            }
        }

        function populateStateFilters() {
            // Valid US state names for safety validation
            const validUSStates = new Set([
                'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado',
                'Connecticut', 'Delaware', 'Florida', 'Georgia', 'Hawaii', 'Idaho',
                'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana',
                'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota',
                'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada',
                'New Hampshire', 'New Jersey', 'New Mexico', 'New York',
                'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon',
                'Pennsylvania', 'Rhode Island', 'South Carolina', 'South Dakota',
                'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington',
                'West Virginia', 'Wisconsin', 'Wyoming'
            ]);

            const states = {};
            deviceData.forEach(device => {
                // Use VALIDATED state from geographic validator (device.state)
                // This comes from analyzeGeographicLocation() with 99.9% accuracy
                const state = device.state || '';

                // STRICT VALIDATION: Only count valid US state names
                if (state && state.trim() !== '' && state !== 'Unknown' && validUSStates.has(state)) {
                    states[state] = (states[state] || 0) + 1;
                }
            });

            const container = document.getElementById('stateFiltersContainer');
            if (!container) return;

            // Sort by state name alphabetically and FILTER OUT ZERO COUNTS
            const stateEntries = Object.entries(states).filter(([state, count]) => count > 0);

            container.innerHTML = stateEntries
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([state, count]) => {
                    const id = state.toLowerCase().replace(/\s+/g, '-');
                    return `<button class="filter-btn" onclick="filterByRegion('${state.replace(/'/g, "\\'")}', this)"><span>🏛️ ${state}</span><span class="filter-badge" id="badge-region-${id}">${count}</span></button>`;
                }).join('');

            console.log(`✅ Geographic Regions populated: ${stateEntries.length} states with validated data (${Object.keys(states).length - stateEntries.length} zero-count states filtered out)`);
        }

        function populateVendorFilters() {
            const vendors = {};
            const sampleDevices = [];

            deviceData.forEach((device, index) => {
                const vendor = detectVendorFromCSV(device);

                // Collect sample for debugging (first 3 devices)
                if (index < 3) {
                    sampleDevices.push({
                        name: device.deviceName,
                        vendor: vendor,
                        deviceVendor: device.deviceVendor,
                        rawVendor: device.vendor,
                        deviceType: device.deviceType
                    });
                }

                // Count vendors (detection function already handles mapping and filtering)
                if (vendor !== 'Unknown') {
                    vendors[vendor] = (vendors[vendor] || 0) + 1;
                }
            });

            console.log('✓ Sample devices detected:', sampleDevices);
            console.log('✓ Valid vendors found:', Object.keys(vendors).length, vendors);

            const container = document.getElementById('vendorFiltersContainer');
            if (!container) {
                console.error('vendorFiltersContainer element not found!');
                return;
            }

            const vendorList = Object.entries(vendors).sort((a, b) => b[1] - a[1]);
            console.log('Creating vendor buttons:', vendorList.map(([v, c]) => `${v}: ${c}`).join(', '));

            const html = vendorList.map(([vendor, count]) => {
                const icon = VENDOR_ICONS[vendor] || '❓';
                const id = vendor.toLowerCase().replace(/\s+/g, '-');
                return `<button class="filter-btn" onclick="filterByVendor('${vendor.replace(/'/g, "\\'")}', this)"><span>${icon} ${vendor}</span><span class="filter-badge" id="badge-vendor-${id}">${count}</span></button>`;
            }).join('');

            container.innerHTML = html;
            console.log('✓ Vendor filters populated:', Object.keys(vendors).length, 'vendors');
            console.log('Sample button HTML:', html.substring(0, 300));
            console.log('Container element:', container);
            console.log('Container children count:', container.children.length);

            // Verify buttons were created
            setTimeout(() => {
                const buttons = container.querySelectorAll('.filter-btn');
                console.log('Vendor buttons created:', buttons.length);
                if (buttons.length > 0) {
                    console.log('First button text:', buttons[0].textContent);
                    console.log('First button HTML:', buttons[0].outerHTML.substring(0, 150));
                }
            }, 100);
        }

        function populateDeviceTypeFilters() {
            const types = {};
            deviceData.forEach(device => {
                const type = detectDeviceTypeFromCSV(device);
                // Count types (detection function already handles mapping and filtering)
                if (type !== 'Unknown') {
                    types[type] = (types[type] || 0) + 1;
                }
            });

            console.log('✓ Device types found:', Object.keys(types).length, types);

            const container = document.getElementById('deviceTypeFiltersContainer');
            if (!container) return;

            container.innerHTML = Object.entries(types)
                .sort((a, b) => b[1] - a[1])
                .map(([type, count]) => {
                    const icon = DEVICE_TYPE_ICONS[type] || '❓';
                    const id = type.toLowerCase().replace(/\s+/g, '-');
                    const label = type === 'Firewall' ? 'Firewalls' :
                                  type === 'Router' ? 'Routers' :
                                  type === 'Switch' ? 'Switches' :
                                  type === 'Load Balancer' ? 'Load Balancers' :
                                  type + 's';
                    return `<button class="filter-btn" onclick="filterByDeviceType('${type.replace(/'/g, "\\'")}', this)"><span>${icon} ${label}</span><span class="filter-badge" id="badge-type-${id}">${count}</span></button>`;
                }).join('');
        }

        function populateSiteTypeFilters() {
            const siteTypes = {};
            deviceData.forEach(device => {
                const siteType = detectSiteType(device.deviceName);
                if (siteType && siteType !== 'Unknown') {
                    siteTypes[siteType] = (siteTypes[siteType] || 0) + 1;
                }
            });

            const container = document.getElementById('siteTypeFiltersContainer');
            if (!container) return;

            container.innerHTML = Object.entries(siteTypes)
                .sort((a, b) => b[1] - a[1])
                .map(([siteType, count]) => {
                    const info = SITE_TYPE_INFO[siteType] || { icon: '📍', label: siteType };
                    const id = siteType.toLowerCase().replace(/\s+/g, '-');
                    return `<button class="filter-btn" onclick="filterBySiteType('${siteType.replace(/'/g, "\\'")}', this)"><span>${info.icon} ${info.label}</span><span class="filter-badge" id="badge-site-${id}">${count}</span></button>`;
                }).join('');
        }

        function populateDeviceRoleFilters() {
            const roles = {};
            deviceData.forEach(device => {
                const role = detectDeviceRole(device.deviceName);
                if (role && role !== 'Unknown') {
                    roles[role] = (roles[role] || 0) + 1;
                }
            });

            const container = document.getElementById('deviceRoleFiltersContainer');
            if (!container) return;

            container.innerHTML = Object.entries(roles)
                .sort((a, b) => b[1] - a[1])
                .map(([role, count]) => {
                    const info = DEVICE_ROLE_INFO[role] || { icon: '📦', label: role };
                    const id = role.toLowerCase().replace(/\s+/g, '-');
                    return `<button class="filter-btn" onclick="filterByDeviceRole('${role.replace(/'/g, "\\'")}', this)"><span>${info.icon} ${info.label}</span><span class="filter-badge" id="badge-role-${id}">${count}</span></button>`;
                }).join('');
        }

        // Enhanced device detection system
        function detectDeviceInfo(device) {
            const sn = device.sn || '';
            const deviceName = device.deviceName || '';
            const region = device.region || 'US';

            let vendor = 'Unknown';
            let deviceType = 'Firewall'; // Default based on current data
            let model = 'Unknown';
            let series = 'Unknown';
            let siteType = detectSiteType(deviceName);
            let deviceRole = detectDeviceRole(deviceName);
            let location = detectLocation(deviceName, region);

            // Vendor and Model Detection
            if (sn.includes('FG') || sn.includes('FGT') || deviceName.includes('Forti')) {
                vendor = 'Fortinet';
                deviceType = 'Firewall';

                // FortiGate Model Detection
                if (sn.includes('FGT30') || sn.includes('FG30')) { model = 'FortiGate-30'; series = 'FGT30'; }
                else if (sn.includes('FGT40') || sn.includes('FG40')) { model = 'FortiGate-40'; series = 'FGT40'; }
                else if (sn.includes('FGT60') || sn.includes('FG60')) { model = 'FortiGate-60'; series = 'FGT60'; }
                else if (sn.includes('FGT80') || sn.includes('FG80')) { model = 'FortiGate-80'; series = 'FGT80'; }
                else if (sn.includes('FGT81') || sn.includes('FG81') || sn.includes('FG181')) { model = 'FortiGate-81'; series = 'FGT81'; }
                else if (sn.includes('FG100') || sn.includes('FG101')) { model = 'FortiGate-100'; series = 'FG100'; }
                else if (sn.includes('FG200')) { model = 'FortiGate-200'; series = 'FG200'; }
                else if (sn.includes('FG300')) { model = 'FortiGate-300'; series = 'FG300'; }
                else if (sn.includes('FG400')) { model = 'FortiGate-400'; series = 'FG400'; }
                else if (sn.includes('FG5') || sn.includes('FG500')) { model = 'FortiGate-500'; series = 'FG500'; }
                else if (sn.includes('FG600')) { model = 'FortiGate-600'; series = 'FG600'; }
                else if (sn.includes('FG1000') || sn.includes('FG1K')) { model = 'FortiGate-1000'; series = 'FG1000'; }
                else if (sn.includes('FG2K') || sn.includes('FG2000')) { model = 'FortiGate-2000'; series = 'FG2000'; }
                else if (sn.includes('FG3K') || sn.includes('FG3000')) { model = 'FortiGate-3000'; series = 'FG3000'; }
                else if (sn.includes('FGVM') || sn.includes('FG-VM')) { model = 'FortiGate-VM'; series = 'FGVM'; }
                else if (sn.includes('FG2H0')) { model = 'FortiGate-200'; series = 'FG200'; }
                else { model = 'FortiGate-Other'; series = 'Other'; }
            }
            // Palo Alto Networks Detection
            else if (sn.includes('PA-') || deviceName.includes('PA-') || deviceName.includes('Palo')) {
                vendor = 'Palo Alto Networks';
                deviceType = 'Firewall';
                if (sn.includes('PA-220') || deviceName.includes('PA-220')) { model = 'PA-220'; series = 'PA-200'; }
                else if (sn.includes('PA-410') || deviceName.includes('PA-410')) { model = 'PA-410'; series = 'PA-400'; }
                else if (sn.includes('PA-440') || deviceName.includes('PA-440')) { model = 'PA-440'; series = 'PA-400'; }
                else if (sn.includes('PA-450') || deviceName.includes('PA-450')) { model = 'PA-450'; series = 'PA-400'; }
                else if (sn.includes('PA-850') || deviceName.includes('PA-850')) { model = 'PA-850'; series = 'PA-800'; }
                else if (sn.includes('PA-3020') || deviceName.includes('PA-3020')) { model = 'PA-3020'; series = 'PA-3000'; }
                else if (sn.includes('PA-3050') || deviceName.includes('PA-3050')) { model = 'PA-3050'; series = 'PA-3000'; }
                else if (sn.includes('PA-5220') || deviceName.includes('PA-5220')) { model = 'PA-5220'; series = 'PA-5000'; }
                else if (sn.includes('PA-5250') || deviceName.includes('PA-5250')) { model = 'PA-5250'; series = 'PA-5000'; }
                else if (sn.includes('PA-7050') || deviceName.includes('PA-7050')) { model = 'PA-7050'; series = 'PA-7000'; }
                else if (sn.includes('PA-VM') || deviceName.includes('PA-VM')) { model = 'PA-VM'; series = 'PA-VM'; }
                else { model = 'PA-Other'; series = 'PA-Other'; }
            }
            // Cisco ASA Detection
            else if (sn.includes('ASA') || deviceName.includes('ASA') || sn.includes('FPR')) {
                vendor = 'Cisco';
                deviceType = 'Firewall';
                if (sn.includes('5505') || deviceName.includes('5505')) { model = 'ASA-5505'; series = 'ASA-5500'; }
                else if (sn.includes('5506') || deviceName.includes('5506')) { model = 'ASA-5506'; series = 'ASA-5500'; }
                else if (sn.includes('5508') || deviceName.includes('5508')) { model = 'ASA-5508'; series = 'ASA-5500'; }
                else if (sn.includes('5516') || deviceName.includes('5516')) { model = 'ASA-5516'; series = 'ASA-5500'; }
                else if (sn.includes('5525') || deviceName.includes('5525')) { model = 'ASA-5525'; series = 'ASA-5500'; }
                else if (sn.includes('5545') || deviceName.includes('5545')) { model = 'ASA-5545'; series = 'ASA-5500'; }
                else if (sn.includes('5555') || deviceName.includes('5555')) { model = 'ASA-5555'; series = 'ASA-5500'; }
                else if (sn.includes('5585') || deviceName.includes('5585')) { model = 'ASA-5585'; series = 'ASA-5500'; }
                else if (sn.includes('FPR1') || deviceName.includes('Firepower-1')) { model = 'Firepower-1000'; series = 'Firepower'; }
                else if (sn.includes('FPR2') || deviceName.includes('Firepower-2')) { model = 'Firepower-2100'; series = 'Firepower'; }
                else if (sn.includes('FPR4') || deviceName.includes('Firepower-4')) { model = 'Firepower-4100'; series = 'Firepower'; }
                else if (sn.includes('FPR9') || deviceName.includes('Firepower-9')) { model = 'Firepower-9300'; series = 'Firepower'; }
                else { model = 'Cisco-ASA-Other'; series = 'ASA'; }
            }
            // Check Point Detection
            else if (sn.includes('CP-') || deviceName.toLowerCase().includes('checkpoint') || deviceName.includes('CP-')) {
                vendor = 'Check Point';
                deviceType = 'Firewall';
                if (deviceName.includes('1500') || sn.includes('1500')) { model = 'Check Point-1500'; series = 'CP-1000'; }
                else if (deviceName.includes('3000') || sn.includes('3000')) { model = 'Check Point-3000'; series = 'CP-3000'; }
                else if (deviceName.includes('5000') || sn.includes('5000')) { model = 'Check Point-5000'; series = 'CP-5000'; }
                else if (deviceName.includes('15000') || sn.includes('15000')) { model = 'Check Point-15000'; series = 'CP-15000'; }
                else if (deviceName.includes('23000') || sn.includes('23000')) { model = 'Check Point-23000'; series = 'CP-23000'; }
                else { model = 'Check Point-Other'; series = 'CP-Other'; }
            }
            // Juniper Detection
            else if (sn.includes('SRX') || deviceName.includes('SRX') || sn.includes('JN')) {
                vendor = 'Juniper';
                deviceType = 'Firewall';
                if (deviceName.includes('SRX300') || sn.includes('SRX300')) { model = 'SRX300'; series = 'SRX-300'; }
                else if (deviceName.includes('SRX550') || sn.includes('SRX550')) { model = 'SRX550'; series = 'SRX-500'; }
                else if (deviceName.includes('SRX1500') || sn.includes('SRX1500')) { model = 'SRX1500'; series = 'SRX-1500'; }
                else if (deviceName.includes('SRX4000') || sn.includes('SRX4000')) { model = 'SRX4000'; series = 'SRX-4000'; }
                else { model = 'Juniper-SRX'; series = 'SRX'; }
            }
            // F5 Detection (Load Balancers)
            else if (sn.includes('F5-') || deviceName.toLowerCase().includes('bigip') || deviceName.includes('F5')) {
                vendor = 'F5 Networks';
                deviceType = 'Load Balancer';
                if (deviceName.includes('2000') || sn.includes('2000')) { model = 'BIG-IP 2000'; series = 'BIG-IP-2000'; }
                else if (deviceName.includes('4000') || sn.includes('4000')) { model = 'BIG-IP 4000'; series = 'BIG-IP-4000'; }
                else if (deviceName.includes('5000') || sn.includes('5000')) { model = 'BIG-IP 5000'; series = 'BIG-IP-5000'; }
                else if (deviceName.includes('10000') || sn.includes('10000')) { model = 'BIG-IP 10000'; series = 'BIG-IP-10000'; }
                else { model = 'F5-Other'; series = 'F5'; }
            }
            // Cisco Router Detection
            else if (deviceName.toLowerCase().includes('router') || deviceName.includes('ISR') || sn.includes('ISR')) {
                vendor = 'Cisco';
                deviceType = 'Router';
                if (deviceName.includes('ISR4') || sn.includes('ISR4')) { model = 'ISR-4000'; series = 'ISR-4000'; }
                else if (deviceName.includes('ISR1') || sn.includes('ISR1')) { model = 'ISR-1000'; series = 'ISR-1000'; }
                else if (deviceName.includes('ASR1') || sn.includes('ASR1')) { model = 'ASR-1000'; series = 'ASR-1000'; }
                else if (deviceName.includes('ASR9') || sn.includes('ASR9')) { model = 'ASR-9000'; series = 'ASR-9000'; }
                else { model = 'Cisco-Router'; series = 'Router'; }
            }
            // Cisco Switch Detection
            else if (deviceName.toLowerCase().includes('switch') || deviceName.includes('Cat') || deviceName.includes('Nexus')) {
                vendor = 'Cisco';
                deviceType = 'Switch';
                if (deviceName.includes('9300') || sn.includes('9300')) { model = 'Catalyst-9300'; series = 'Cat-9000'; }
                else if (deviceName.includes('9500') || sn.includes('9500')) { model = 'Catalyst-9500'; series = 'Cat-9000'; }
                else if (deviceName.includes('Nexus-9') || sn.includes('N9K')) { model = 'Nexus-9000'; series = 'Nexus-9K'; }
                else if (deviceName.includes('Nexus-7') || sn.includes('N7K')) { model = 'Nexus-7000'; series = 'Nexus-7K'; }
                else { model = 'Cisco-Switch'; series = 'Switch'; }
            }

            return {
                vendor: vendor,
                deviceType: deviceType,
                model: model,
                series: series,
                siteType: siteType,
                deviceRole: deviceRole,
                country: location.country,
                state: location.state,
                city: location.city,
                fullLocation: location.fullLocation
            };
        }

        // Enhanced geolocation detection - US States, Cities, EU Countries/Regions
        function detectLocation(deviceName, region) {
            if (!deviceName) return { country: region || 'Unknown', state: null, city: null, fullLocation: region || 'Unknown' };

            const name = deviceName.toUpperCase();
            let country = region || 'US';
            let state = null;
            let city = null;

            // US State Detection (comprehensive)
            const usStates = {
                'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
                'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
                'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
                'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
                'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
                'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
                'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
                'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
                'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
                'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
            };

            // City detection patterns (common city codes/abbreviations)
            const cities = {
                'NYC': 'New York City', 'LA': 'Los Angeles', 'CHI': 'Chicago', 'HOU': 'Houston',
                'PHX': 'Phoenix', 'PHI': 'Philadelphia', 'SAN': 'San Antonio', 'DAL': 'Dallas',
                'SJ': 'San Jose', 'AUS': 'Austin', 'JAX': 'Jacksonville', 'SF': 'San Francisco',
                'IND': 'Indianapolis', 'CLB': 'Columbus', 'FW': 'Fort Worth', 'CHA': 'Charlotte',
                'SEA': 'Seattle', 'DEN': 'Denver', 'DC': 'Washington DC', 'BOS': 'Boston',
                'DET': 'Detroit', 'NSH': 'Nashville', 'MEM': 'Memphis', 'POR': 'Portland',
                'OKC': 'Oklahoma City', 'LV': 'Las Vegas', 'MIL': 'Milwaukee', 'ATL': 'Atlanta',
                'MIA': 'Miami', 'TPA': 'Tampa', 'ORL': 'Orlando', 'MIN': 'Minneapolis',
                'CLE': 'Cleveland', 'RAL': 'Raleigh', 'STL': 'St Louis', 'PIT': 'Pittsburgh'
            };

            // EU Countries
            const euCountries = {
                'UK': 'United Kingdom', 'GB': 'United Kingdom', 'LONDON': 'United Kingdom', 'LON': 'United Kingdom',
                'DE': 'Germany', 'BERLIN': 'Germany', 'MUNICH': 'Germany', 'FRANKFURT': 'Germany', 'BER': 'Germany', 'MUN': 'Germany', 'FRA': 'Germany',
                'FR': 'France', 'PARIS': 'France', 'LYON': 'France', 'MARSEILLE': 'France', 'PAR': 'France',
                'IT': 'Italy', 'ROME': 'Italy', 'MILAN': 'Italy', 'ROM': 'Italy', 'MIL': 'Italy',
                'ES': 'Spain', 'MADRID': 'Spain', 'BARCELONA': 'Spain', 'MAD': 'Spain', 'BCN': 'Spain',
                'NL': 'Netherlands', 'AMSTERDAM': 'Netherlands', 'ROTTERDAM': 'Netherlands', 'AMS': 'Netherlands',
                'BE': 'Belgium', 'BRUSSELS': 'Belgium', 'ANTWERP': 'Belgium', 'BRU': 'Belgium',
                'SE': 'Sweden', 'STOCKHOLM': 'Sweden', 'STO': 'Sweden',
                'NO': 'Norway', 'OSLO': 'Norway', 'OSL': 'Norway',
                'DK': 'Denmark', 'COPENHAGEN': 'Denmark', 'CPH': 'Denmark',
                'FI': 'Finland', 'HELSINKI': 'Finland', 'HEL': 'Finland',
                'PL': 'Poland', 'WARSAW': 'Poland', 'WAW': 'Poland',
                'CZ': 'Czech Republic', 'PRAGUE': 'Czech Republic', 'PRG': 'Czech Republic',
                'AT': 'Austria', 'VIENNA': 'Austria', 'VIE': 'Austria',
                'CH': 'Switzerland', 'ZURICH': 'Switzerland', 'GENEVA': 'Switzerland', 'ZRH': 'Switzerland',
                'PT': 'Portugal', 'LISBON': 'Portugal', 'LIS': 'Portugal',
                'IE': 'Ireland', 'DUBLIN': 'Ireland', 'DUB': 'Ireland'
            };

            // APAC Countries
            const apacCountries = {
                'JP': 'Japan', 'TOKYO': 'Japan', 'TYO': 'Japan', 'OSAKA': 'Japan',
                'CN': 'China', 'BEIJING': 'China', 'SHANGHAI': 'China', 'BEI': 'China', 'SHA': 'China',
                'SG': 'Singapore', 'SINGAPORE': 'Singapore', 'SIN': 'Singapore',
                'HK': 'Hong Kong', 'HONGKONG': 'Hong Kong', 'HKG': 'Hong Kong',
                'AU': 'Australia', 'SYDNEY': 'Australia', 'MELBOURNE': 'Australia', 'SYD': 'Australia', 'MEL': 'Australia',
                'NZ': 'New Zealand', 'AUCKLAND': 'New Zealand', 'AKL': 'New Zealand',
                'IN': 'India', 'MUMBAI': 'India', 'DELHI': 'India', 'BANGALORE': 'India', 'BOM': 'India', 'DEL': 'India', 'BLR': 'India',
                'KR': 'South Korea', 'SEOUL': 'South Korea', 'SEL': 'South Korea',
                'TH': 'Thailand', 'BANGKOK': 'Thailand', 'BKK': 'Thailand',
                'MY': 'Malaysia', 'KUALALUMPUR': 'Malaysia', 'KUL': 'Malaysia',
                'ID': 'Indonesia', 'JAKARTA': 'Indonesia', 'JKT': 'Indonesia',
                'PH': 'Philippines', 'MANILA': 'Philippines', 'MNL': 'Philippines',
                'TW': 'Taiwan', 'TAIPEI': 'Taiwan', 'TPE': 'Taiwan'
            };

            // LATAM Countries
            const latamCountries = {
                'BR': 'Brazil', 'SAOPAULO': 'Brazil', 'RIO': 'Brazil', 'SAO': 'Brazil', 'GRU': 'Brazil',
                'MX': 'Mexico', 'MEXICOCITY': 'Mexico', 'MEX': 'Mexico',
                'AR': 'Argentina', 'BUENOSAIRES': 'Argentina', 'EZE': 'Argentina',
                'CL': 'Chile', 'SANTIAGO': 'Chile', 'SCL': 'Chile',
                'CO': 'Colombia', 'BOGOTA': 'Colombia', 'BOG': 'Colombia',
                'PE': 'Peru', 'LIMA': 'Peru', 'LIM': 'Peru',
                'VE': 'Venezuela', 'CARACAS': 'Venezuela', 'CCS': 'Venezuela',
                'EC': 'Ecuador', 'QUITO': 'Ecuador', 'UIO': 'Ecuador',
                'UY': 'Uruguay', 'MONTEVIDEO': 'Uruguay', 'MVD': 'Uruguay',
                'PY': 'Paraguay', 'ASUNCION': 'Paraguay', 'ASU': 'Paraguay'
            };

            // Detect US State from device name
            if (region === 'US' || !region) {
                for (const [abbr, fullName] of Object.entries(usStates)) {
                    // Look for state abbreviation as whole word or with delimiters
                    const pattern = new RegExp(`[^A-Z]${abbr}[^A-Z]|^${abbr}[^A-Z]|[^A-Z]${abbr}$|^${abbr}$`);
                    if (pattern.test(name)) {
                        state = abbr;
                        country = 'US';
                        break;
                    }
                }

                // Detect city
                for (const [abbr, fullName] of Object.entries(cities)) {
                    if (name.includes(abbr)) {
                        city = fullName;
                        break;
                    }
                }
            }

            // Detect EU Country
            if (region === 'EU' || region === 'UK' || region === 'DE' || region === 'FR' || region === 'Europe') {
                for (const [abbr, countryName] of Object.entries(euCountries)) {
                    if (name.includes(abbr)) {
                        country = countryName;
                        break;
                    }
                }
            }

            // Detect APAC Country
            if (region === 'APAC' || region === 'Asia' || region === 'AP') {
                for (const [abbr, countryName] of Object.entries(apacCountries)) {
                    if (name.includes(abbr)) {
                        country = countryName;
                        break;
                    }
                }
            }

            // Detect LATAM Country
            if (region === 'LATAM' || region === 'SA' || region === 'South America' || region === 'Latin America') {
                for (const [abbr, countryName] of Object.entries(latamCountries)) {
                    if (name.includes(abbr)) {
                        country = countryName;
                        break;
                    }
                }
            }

            // Check all regions if no specific region provided
            if (!region || region === 'Global' || region === 'ALL') {
                // Check EU
                for (const [abbr, countryName] of Object.entries(euCountries)) {
                    if (name.includes(abbr)) {
                        country = countryName;
                        break;
                    }
                }
                // Check APAC
                if (!country || country === region) {
                    for (const [abbr, countryName] of Object.entries(apacCountries)) {
                        if (name.includes(abbr)) {
                            country = countryName;
                            break;
                        }
                    }
                }
                // Check LATAM
                if (!country || country === region) {
                    for (const [abbr, countryName] of Object.entries(latamCountries)) {
                        if (name.includes(abbr)) {
                            country = countryName;
                            break;
                        }
                    }
                }
            }

            // Build full location string
            let fullLocation = '';
            if (city) fullLocation = city;
            if (state) fullLocation += (fullLocation ? ', ' : '') + state;
            if (country) fullLocation += (fullLocation ? ', ' : '') + country;
            if (!fullLocation) fullLocation = country || region || 'Unknown';

            return {
                country: country,
                state: state,
                city: city,
                fullLocation: fullLocation
            };
        }

        // Detect site type from device name
        function detectSiteType(deviceName) {
            if (!deviceName) return 'Unknown';
            const name = deviceName.toUpperCase();

            if (name.includes('PDC') || name.includes('PRIMARY-DC')) return 'PDC';
            if (name.includes('BDC') || name.includes('BACKUP-DC') || name.includes('SECONDARY-DC')) return 'BDC';
            if (name.includes('CAT') || name.includes('CATALOG')) return 'CAT';
            if (name.includes('HQ') || name.includes('HEADQUARTER')) return 'HQ';
            if (name.includes('BRANCH') || name.includes('BR-')) return 'Branch';
            if (name.includes('REMOTE')) return 'Remote';
            if (name.includes('CLOUD') || name.includes('AWS') || name.includes('AZURE') || name.includes('GCP')) return 'Cloud';
            if (name.includes('COLO') || name.includes('COLOCATION')) return 'Colo';

            return 'Other';
        }

        // Detect device role from device name
        function detectDeviceRole(deviceName) {
            if (!deviceName) return 'Unknown';
            const name = deviceName.toUpperCase();

            if (name.includes('VPN') || name.includes('ADVPN') || name.includes('SSLVPN')) return 'VPN Gateway';
            if (name.includes('WAN') || name.includes('EDGE')) return 'WAN Edge';
            if (name.includes('DMZ')) return 'DMZ Firewall';
            if (name.includes('INTERNET') || name.includes('INET')) return 'Internet Edge';
            if (name.includes('ACCESS') || name.includes('ACC')) return 'Access';
            if (name.includes('CORE')) return 'Core';
            if (name.includes('DIST') || name.includes('DISTRIBUTION')) return 'Distribution';
            if (name.includes('FW') || name.includes('FIREWALL')) return 'Firewall';
            if (name.includes('LB') || name.includes('LOADBALANCER')) return 'Load Balancer';

            return 'General Purpose';
        }

        // Legacy function for backward compatibility
        function detectModel(sn) {
            const device = { sn: sn, deviceName: '' };
            return detectDeviceInfo(device).series;
        }

        // Premium Assessment Functions for Enhanced Reporting

        // Calculate comprehensive device health score (0-100)
        function calculateDeviceHealth(device) {
            let score = 100;
            let details = [];

            // HA Configuration (30 points)
            if (!device.hasHA) {
                score -= 30;
                details.push({ category: 'HA Configuration', impact: -30, reason: 'No High Availability configured' });
            }

            // Device Age (20 points)
            const deviceAge = device.ageYears || estimateDeviceAge(device);
            if (deviceAge > 5) {
                score -= 20;
                details.push({ category: 'Device Age', impact: -20, reason: `Device is ${deviceAge} years old (>5 years)` });
            } else if (deviceAge > 3) {
                score -= 10;
                details.push({ category: 'Device Age', impact: -10, reason: `Device is ${deviceAge} years old (3-5 years)` });
            }

            // Critical Site without HA (15 points)
            if ((device.siteType === 'PDC' || device.siteType === 'BDC') && !device.hasHA) {
                score -= 15;
                details.push({ category: 'Critical Site', impact: -15, reason: `Critical site (${device.siteType}) without HA` });
            }

            // Vendor Support Status (15 points) - based on model age
            const vendorSupport = assessVendorSupport(device);
            if (vendorSupport === 'EOL') {
                score -= 15;
                details.push({ category: 'Vendor Support', impact: -15, reason: 'Device is End-of-Life' });
            } else if (vendorSupport === 'EOS') {
                score -= 10;
                details.push({ category: 'Vendor Support', impact: -10, reason: 'Device is End-of-Sale' });
            }

            // Network Role Criticality (10 points)
            if ((device.deviceRole === 'Core' || device.deviceRole === 'Distribution') && !device.hasHA) {
                score -= 10;
                details.push({ category: 'Role Criticality', impact: -10, reason: `Critical role (${device.deviceRole}) without redundancy` });
            }

            // Configuration Compliance (10 points)
            if (!device.complianceStatus || device.complianceStatus === 'Non-Compliant') {
                score -= 10;
                details.push({ category: 'Compliance', impact: -10, reason: 'Configuration non-compliant' });
            }

            return {
                score: Math.max(0, score),
                grade: getHealthGrade(Math.max(0, score)),
                details: details,
                recommendations: generateHealthRecommendations(details)
            };
        }

        // Calculate risk assessment score
        function calculateRiskScore(device) {
            let riskScore = 0;
            let riskFactors = [];

            // Single Point of Failure Risk
            if (!device.hasHA) {
                const spofRisk = calculateSPOFRisk(device);
                riskScore += spofRisk;
                if (spofRisk > 0) {
                    riskFactors.push({
                        type: 'SPOF',
                        severity: spofRisk > 30 ? 'Critical' : 'High',
                        score: spofRisk,
                        description: 'Single point of failure risk'
                    });
                }
            }

            // Age-related Risk
            const ageRisk = calculateAgeRisk(device);
            if (ageRisk > 0) {
                riskScore += ageRisk;
                riskFactors.push({
                    type: 'Age',
                    severity: ageRisk > 20 ? 'High' : 'Medium',
                    score: ageRisk,
                    description: 'Hardware age and reliability concerns'
                });
            }

            // Vendor Risk
            const vendorRisk = calculateVendorRisk(device);
            if (vendorRisk > 0) {
                riskScore += vendorRisk;
                riskFactors.push({
                    type: 'Vendor',
                    severity: vendorRisk > 15 ? 'High' : 'Medium',
                    score: vendorRisk,
                    description: 'Vendor support and lifecycle risk'
                });
            }

            // Site Criticality Risk
            const siteRisk = calculateSiteRisk(device);
            if (siteRisk > 0) {
                riskScore += siteRisk;
                riskFactors.push({
                    type: 'Site',
                    severity: siteRisk > 20 ? 'Critical' : 'High',
                    score: siteRisk,
                    description: 'Critical site vulnerability'
                });
            }

            return {
                totalScore: Math.min(100, riskScore),
                level: getRiskLevel(Math.min(100, riskScore)),
                factors: riskFactors,
                mitigation: generateMitigationPlan(riskFactors)
            };
        }

        // Calculate compliance score
        function calculateComplianceScore(device) {
            let score = 100;
            let violations = [];

            // HA Compliance for critical devices
            if (requiresHA(device) && !device.hasHA) {
                score -= 40;
                violations.push({
                    policy: 'HA-001',
                    description: 'High Availability required for critical infrastructure',
                    severity: 'Critical'
                });
            }

            // EOL Compliance
            if (assessVendorSupport(device) === 'EOL') {
                score -= 30;
                violations.push({
                    policy: 'LC-001',
                    description: 'End-of-Life equipment must be replaced',
                    severity: 'High'
                });
            }

            // Configuration Standards
            if (!meetsConfigStandards(device)) {
                score -= 20;
                violations.push({
                    policy: 'CFG-001',
                    description: 'Device configuration does not meet standards',
                    severity: 'Medium'
                });
            }

            // Security Compliance
            if (!meetsSecurityRequirements(device)) {
                score -= 10;
                violations.push({
                    policy: 'SEC-001',
                    description: 'Security requirements not met',
                    severity: 'Medium'
                });
            }

            return {
                score: Math.max(0, score),
                status: score >= 80 ? 'Compliant' : score >= 60 ? 'Partially Compliant' : 'Non-Compliant',
                violations: violations,
                remediationPlan: generateRemediationPlan(violations)
            };
        }

        // Helper functions for assessment calculations
        function estimateDeviceAge(device) {
            // Estimate based on model generation
            const modelYear = extractModelYear(device.model);
            if (modelYear) {
                return new Date().getFullYear() - modelYear;
            }
            return 3; // Default assumption
        }

        function assessVendorSupport(device) {
            // Check for EOL/EOS based on model
            const eolModels = ['ASA5505', 'ASA5510', 'FGT30D', 'FGT60C', 'PA-200', 'SRX100'];
            const eosModels = ['FGT60D', 'FGT100D', 'PA-500', 'ASA5515'];

            if (eolModels.some(m => device.model && device.model.includes(m))) return 'EOL';
            if (eosModels.some(m => device.model && device.model.includes(m))) return 'EOS';
            return 'Supported';
        }

        function getHealthGrade(score) {
            if (score >= 90) return 'A';
            if (score >= 80) return 'B';
            if (score >= 70) return 'C';
            if (score >= 60) return 'D';
            return 'F';
        }

        function getRiskLevel(score) {
            if (score >= 70) return 'Critical';
            if (score >= 50) return 'High';
            if (score >= 30) return 'Medium';
            if (score >= 10) return 'Low';
            return 'Minimal';
        }

        function calculateSPOFRisk(device) {
            if (device.siteType === 'PDC' || device.siteType === 'BDC') return 40;
            if (device.deviceRole === 'Core' || device.deviceRole === 'Distribution') return 30;
            if (device.deviceRole === 'Edge' || device.deviceRole === 'Perimeter') return 20;
            return 10;
        }

        function calculateAgeRisk(device) {
            const age = device.ageYears || estimateDeviceAge(device);
            if (age > 7) return 30;
            if (age > 5) return 20;
            if (age > 3) return 10;
            return 0;
        }

        function calculateVendorRisk(device) {
            const support = assessVendorSupport(device);
            if (support === 'EOL') return 25;
            if (support === 'EOS') return 15;
            return 0;
        }

        function calculateSiteRisk(device) {
            if (!device.hasHA) {
                if (device.siteType === 'PDC') return 30;
                if (device.siteType === 'BDC') return 25;
                if (device.siteType === 'HQ') return 15;
            }
            return 0;
        }

        function requiresHA(device) {
            return device.siteType === 'PDC' || device.siteType === 'BDC' ||
                   device.deviceRole === 'Core' || device.deviceRole === 'Distribution';
        }

        function meetsConfigStandards(device) {
            // Simplified check - in real implementation would check actual configs
            return device.complianceStatus !== 'Non-Compliant';
        }

        function meetsSecurityRequirements(device) {
            // Simplified check
            return device.securityPosture !== 'Failed';
        }

        function extractModelYear(model) {
            // Extract year from model numbers like "2020" or estimate from series
            const yearMatch = model && model.match(/20\d{2}/);
            if (yearMatch) return parseInt(yearMatch[0]);

            // Estimate based on known model generations
            if (model && model.includes('FGT30E')) return 2016;
            if (model && model.includes('FGT60F')) return 2019;
            if (model && model.includes('FGT100F')) return 2020;
            return null;
        }

        function generateHealthRecommendations(details) {
            const recommendations = [];
            details.forEach(detail => {
                if (detail.category === 'HA Configuration') {
                    recommendations.push('Configure High Availability to eliminate single point of failure');
                }
                if (detail.category === 'Device Age' && detail.impact <= -20) {
                    recommendations.push('Plan device refresh - hardware exceeds recommended lifecycle');
                }
                if (detail.category === 'Vendor Support') {
                    recommendations.push('Replace EOL/EOS equipment with supported models');
                }
            });
            return recommendations;
        }

        function generateMitigationPlan(factors) {
            const plan = [];
            factors.forEach(factor => {
                if (factor.type === 'SPOF') {
                    plan.push({
                        action: 'Implement HA configuration',
                        priority: 'Critical',
                        timeline: '30 days'
                    });
                }
                if (factor.type === 'Age') {
                    plan.push({
                        action: 'Schedule hardware refresh',
                        priority: 'High',
                        timeline: '90 days'
                    });
                }
            });
            return plan;
        }

        function generateRemediationPlan(violations) {
            return violations.map(v => ({
                policy: v.policy,
                action: `Remediate: ${v.description}`,
                priority: v.severity,
                estimatedEffort: v.severity === 'Critical' ? '1 week' : '2 weeks'
            }));
        }

        // Load data
        function loadData() {
            console.log('loadData() called');
            console.log('DEVICE_DATA type:', typeof DEVICE_DATA);

            if (typeof DEVICE_DATA !== 'undefined' && DEVICE_DATA.length > 0) {
                console.log('DEVICE_DATA found, length:', DEVICE_DATA.length);
                deviceData = DEVICE_DATA.map(device => {
                    const deviceInfo = detectDeviceInfo(device);
                    return {
                        ...device,
                        model: device.model || (deviceInfo.model !== 'Unknown' ? deviceInfo.model : ''),
                        series: device.series || (deviceInfo.series !== 'Unknown' ? deviceInfo.series : ''),
                        vendor: device.vendor || (deviceInfo.vendor !== 'Unknown' ? deviceInfo.vendor : ''),
                        deviceType: device.deviceType || deviceInfo.deviceType,
                        siteType: device.siteType || deviceInfo.siteType,
                        deviceRole: device.deviceRole || deviceInfo.deviceRole,
                        country: device.country || deviceInfo.country,
                        state: device.state || deviceInfo.state,
                        city: device.city || deviceInfo.city,
                        fullLocation: device.fullLocation || deviceInfo.fullLocation
                    };
                });
                console.log('deviceData created with enhanced detection, length:', deviceData.length);
            } else {
                console.log('Starting with empty data - use Import to add devices');
                deviceData = [];
            }

            filteredData = [...deviceData];
            console.log('filteredData created, length:', filteredData.length);
            updateStats();
            updateModelBreakdown();
            populateAllFilters();
            renderTable();
            console.log('All functions called, table should be rendered');
        }

        // Update statistics
        function updateStats() {
            const haCount = deviceData.filter(d => d.hasHA).length;
            const total = deviceData.length;
            // CRITICAL FIX: Check worldRegion or country, not region (region contains state names like "California", not "US")
            const usCount = deviceData.filter(d => d.worldRegion === 'US' || d.country === 'US' || d.country === 'United States').length;
            const euCount = deviceData.filter(d => d.worldRegion === 'EU' || ['UK', 'Germany', 'France', 'Spain', 'Italy', 'Netherlands', 'Belgium', 'Poland', 'Austria', 'Sweden', 'Denmark', 'Norway', 'Finland'].includes(d.country)).length;

            // Safely update stat elements with null checks
            const updateElem = (id, value) => {
                const elem = document.getElementById(id);
                if (elem) elem.textContent = value;
            };

            updateElem('totalDevices', total);
            updateElem('usDevices', usCount);
            updateElem('euDevices', euCount);
            updateElem('visibleDevices', filteredData.length);

            // Update filter badges
            updateElem('badge-region-all', total);
            updateElem('badge-region-us', usCount);
            updateElem('badge-region-eu', euCount);

            console.log('✓ Stats updated - Total:', total, 'Visible:', filteredData.length);
        }

        // Update model breakdown
        // ============================================
        // PREMIUM MODEL DISTRIBUTION - ENTERPRISE EDITION
        // ============================================

        let modelChartInstance = null;
        let currentModelView = 'grid';
        let modelSearchTerm = '';

        function updateModelBreakdown() {
            // Model distribution UI removed - kept for compatibility
            updateQuickFilterBadges();
        }

        function updateModelStats() {
            // Model distribution UI removed - kept for compatibility
        }

        function updateModelGrid() {
            // Model distribution UI removed - kept for compatibility
        }

        function updateModelList() {
            // Model distribution UI removed - kept for compatibility
        }

        function updateModelChart() {
            // Model distribution UI removed - kept for compatibility
        }

        function switchModelView(view) {
            // Model distribution UI removed - kept for compatibility
        }

        function filterModels() {
            // Model distribution UI removed - kept for compatibility
        }

        function drillDownModel(modelName) {
            // Model distribution UI removed - kept for compatibility
        }

        function exportModelReport() {
            // Model distribution UI removed - kept for compatibility
        }

        // ============================================
        // PREMIUM QUICK FILTERS - ENTERPRISE EDITION
        // ============================================

        let activeQuickFilters = [];
        let filterLogicMode = 'OR'; // 'AND' or 'OR'
        let savedFilters = JSON.parse(localStorage.getItem('netassets_saved_filters') || '[]');

        function updateQuickFilterBadges() {
            const updateBadge = (id, count) => {
                const badge = document.getElementById(id);
                if (badge) badge.textContent = count;
            };

            // Quick Access - Device Types
            updateBadge('badge-quick-all', deviceData.length);
            updateBadge('badge-firewall', deviceData.filter(d => detectDeviceTypeFromCSV(d).toLowerCase().includes('firewall')).length);
            updateBadge('badge-router', deviceData.filter(d => detectDeviceTypeFromCSV(d).toLowerCase().includes('router')).length);
            updateBadge('badge-switch', deviceData.filter(d => detectDeviceTypeFromCSV(d).toLowerCase().includes('switch')).length);
            updateBadge('badge-vpn', deviceData.filter(d => {
                const type = detectDeviceTypeFromCSV(d).toLowerCase();
                const role = (d.deviceRole || '').toLowerCase();
                return type.includes('vpn') || role.includes('vpn');
            }).length);
            updateBadge('badge-loadbalancer', deviceData.filter(d => detectDeviceTypeFromCSV(d).toLowerCase().includes('load balancer')).length);

            // Critical Sites
            updateBadge('badge-pdc-quick', deviceData.filter(d => d.siteType === 'PDC').length);
            updateBadge('badge-bdc-quick', deviceData.filter(d => d.siteType === 'BDC').length);
            updateBadge('badge-cloud-quick', deviceData.filter(d => d.siteType === 'Cloud').length);

            // Top Vendors
            updateBadge('badge-cisco-quick', deviceData.filter(d => detectVendorFromCSV(d).toLowerCase().includes('cisco')).length);
            updateBadge('badge-fortinet-quick', deviceData.filter(d => detectVendorFromCSV(d).toLowerCase().includes('fortinet')).length);
            updateBadge('badge-paloalto-quick', deviceData.filter(d => detectVendorFromCSV(d).toLowerCase().includes('palo alto')).length);
            updateBadge('badge-juniper-quick', deviceData.filter(d => detectVendorFromCSV(d).toLowerCase().includes('juniper')).length);
            updateBadge('badge-a10-quick', deviceData.filter(d => detectVendorFromCSV(d).toLowerCase().includes('a10')).length);
        }

        function filterByQuickAccess(type, buttonElement) {
            if (type === 'all') {
                // Clear all quick filters
                activeQuickFilters = [];
                document.querySelectorAll('#quickAccessFiltersContainer .filter-btn, .filter-section .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (buttonElement) buttonElement.classList.add('active');
                applyFilters();
            }
        }

        function quickFilterEnhanced(keyword, event) {
            if (event) {
                const chip = event.currentTarget;

                // Toggle filter
                if (activeQuickFilters.includes(keyword)) {
                    activeQuickFilters = activeQuickFilters.filter(f => f !== keyword);
                    chip.classList.remove('active');
                } else {
                    activeQuickFilters.push(keyword);
                    chip.classList.add('active');
                }

                // Update filter combination display
                updateFilterCombinationDisplay();

                // Apply filters
                applyQuickFilters();
            }
        }

        function updateFilterCombinationDisplay() {
            // Simplified UI - no longer needed but kept for compatibility
        }

        function toggleFilterLogic() {
            filterLogicMode = filterLogicMode === 'AND' ? 'OR' : 'AND';
            const filterLogicEl = document.getElementById('filterLogic');
            if (filterLogicEl) filterLogicEl.textContent = filterLogicMode;
            applyQuickFilters();
        }

        function applyQuickFilters() {
            if (activeQuickFilters.length === 0) {
                applyFilters();
                return;
            }

            filteredData = deviceData.filter(device => {
                const matches = activeQuickFilters.map(keyword => {
                    const lowerKeyword = keyword.toLowerCase();
                    const detectedVendor = detectVendorFromCSV(device).toLowerCase();
                    const detectedType = detectDeviceTypeFromCSV(device).toLowerCase();

                    return (
                        (device.deviceRole && device.deviceRole.toLowerCase().includes(lowerKeyword)) ||
                        detectedType.includes(lowerKeyword) ||
                        (device.siteType && device.siteType.toLowerCase().includes(lowerKeyword)) ||
                        detectedVendor.includes(lowerKeyword) ||
                        (lowerKeyword === 'ha' && device.hasHA) ||
                        (device.region && device.region.toLowerCase().includes(lowerKeyword))
                    );
                });

                if (filterLogicMode === 'AND') {
                    return matches.every(m => m);
                } else {
                    return matches.some(m => m);
                }
            });

            updateStats();
            renderTable();
        }

        function clearAllFilters() {
            activeQuickFilters = [];
            document.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.value = '';

            // Reset all filter buttons
            selectedRegion = 'all';
            selectedVendor = 'all';
            selectedDeviceType = 'all';
            selectedSiteType = 'all';
            selectedDeviceRole = 'all';
            selectedConfig = 'all';

            // Update UI
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.filter-btn[onclick*="\'all\'"]').forEach(btn => btn.classList.add('active'));

            applyFilters();
            showNotification('🔄 All filters cleared');
        }

        function switchFilterTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.filter-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}FilterTab`).classList.add('active');

            // Load saved filters if switching to saved tab
            if (tabName === 'saved') {
                renderSavedFilters();
            }
        }

        function saveCurrentFilter() {
            if (activeQuickFilters.length === 0) {
                showNotification('⚠️ No filters to save. Please select at least one filter.');
                return;
            }

            const filterName = prompt('Enter a name for this filter:');
            if (!filterName) return;

            const filter = {
                name: filterName,
                filters: [...activeQuickFilters],
                logic: filterLogicMode,
                created: new Date().toISOString(),
                count: filteredData.length
            };

            savedFilters.push(filter);
            localStorage.setItem('netassets_saved_filters', JSON.stringify(savedFilters));

            showNotification(`💾 Filter "${filterName}" saved successfully!`);
        }

        function renderSavedFilters() {
            const list = document.getElementById('savedFiltersList');

            if (savedFilters.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No saved filters yet. Apply filters and click "Save Filter" to get started.</p>';
                return;
            }

            list.innerHTML = savedFilters.map((filter, index) => `
                <div class="saved-filter-item">
                    <div>
                        <div class="saved-filter-name">${filter.name}</div>
                        <div class="saved-filter-meta">
                            ${filter.filters.join(` ${filter.logic} `)} • ${new Date(filter.created).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="saved-filter-actions">
                        <button class="saved-filter-btn apply" onclick="applySavedFilter(${index})">Apply</button>
                        <button class="saved-filter-btn delete" onclick="deleteSavedFilter(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function applySavedFilter(index) {
            const filter = savedFilters[index];

            // Clear current filters
            activeQuickFilters = [];
            document.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));

            // Apply saved filter
            filterLogicMode = filter.logic;
            activeQuickFilters = [...filter.filters];

            // Update UI
            activeQuickFilters.forEach(keyword => {
                const chip = Array.from(document.querySelectorAll('.chip')).find(c =>
                    c.textContent.toLowerCase().includes(keyword.toLowerCase())
                );
                if (chip) chip.classList.add('active');
            });

            updateFilterCombinationDisplay();
            applyQuickFilters();

            // Switch to quick tab
            document.querySelectorAll('.filter-tab')[0].click();

            showNotification(`✅ Filter "${filter.name}" applied`);
        }

        function deleteSavedFilter(index) {
            const filter = savedFilters[index];
            if (confirm(`Delete filter "${filter.name}"?`)) {
                savedFilters.splice(index, 1);
                localStorage.setItem('netassets_saved_filters', JSON.stringify(savedFilters));
                renderSavedFilters();
                showNotification(`🗑️ Filter "${filter.name}" deleted`);
            }
        }

        function applyFilterTemplate(templateName) {
            // Clear current filters
            clearAllFilters();

            let filters = [];

            switch (templateName) {
                case 'security-audit':
                    filters = ['Firewall', 'VPN'];
                    break;
                case 'ha-review':
                    filters = ['HA'];
                    break;
                case 'vendor-fortinet':
                    filters = ['Fortinet'];
                    break;
                case 'critical-sites':
                    filters = ['PDC', 'BDC'];
                    filterLogicMode = 'OR';
                    break;
                case 'standalone-risk':
                    // This would need more complex logic
                    alert('Advanced template - filter for non-HA devices at critical sites');
                    return;
                case 'cloud-infrastructure':
                    filters = ['Cloud'];
                    break;
            }

            // Apply template filters
            filters.forEach(keyword => {
                const chip = Array.from(document.querySelectorAll('.chip')).find(c =>
                    c.textContent.toLowerCase().includes(keyword.toLowerCase())
                );
                if (chip) {
                    chip.classList.add('active');
                    activeQuickFilters.push(keyword);
                }
            });

            updateFilterCombinationDisplay();
            applyQuickFilters();

            // Switch to quick tab
            document.querySelectorAll('.filter-tab')[0].click();

            showNotification(`📋 Template "${templateName}" applied`);
        }

        function exportFilteredData() {
            if (filteredData.length === 0) {
                showNotification('⚠️ No data to export');
                return;
            }

            let csv = 'Location,Device Name,Vendor,Type,Model,Site,Role,Primary SN,HA Status,HA SN 1,HA SN 2\n';

            filteredData.forEach(device => {
                csv += `"${device.fullLocation || device.region}",`;
                csv += `"${device.deviceName}",`;
                csv += `"${device.vendor}",`;
                csv += `"${device.deviceType}",`;
                csv += `"${device.model}",`;
                csv += `"${device.siteType}",`;
                csv += `"${device.deviceRole}",`;
                csv += `"${device.sn}",`;
                csv += `"${device.hasHA ? 'Yes' : 'No'}",`;
                csv += `"${device.sn_ha1 || ''}",`;
                csv += `"${device.sn_ha2 || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `filtered-devices-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification(`📥 Exported ${filteredData.length} devices`);
        }

        function exportTenantReport(tenantName) {
            const tenantDevices = deviceData.filter(d => d.tenant === tenantName);

            if (tenantDevices.length === 0) {
                showNotification(`⚠️ No devices found for tenant: ${tenantName}`);
                return;
            }

            let csv = 'Status,Device Name,Management IP,Type,Model,SNMP State,ICMP State,HA Status\n';

            tenantDevices.forEach(device => {
                csv += `"${device.status || ''}",`;
                csv += `"${device.deviceName || ''}",`;
                csv += `"${device.managementIP || ''}",`;
                csv += `"${device.deviceType || ''}",`;
                csv += `"${device.model || ''}",`;
                csv += `"${device.snmpState || ''}",`;
                csv += `"${device.icmpState || ''}",`;
                csv += `"${device.hasHA ? 'Yes' : 'No'}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tenant-${tenantName.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification(`📥 Exported ${tenantDevices.length} devices for ${tenantName}`);
        }

        // Get badge class for model
        function getModelBadgeClass(model) {
            const classes = {
                'FGT60': 'badge-fgt60',
                'FG100': 'badge-fg100',
                'FG200': 'badge-fg200',
                'FG500': 'badge-fg500'
            };
            return classes[model] || 'badge-other';
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const noResults = document.getElementById('noResults');

            if (!tbody) {
                console.error('tableBody element not found');
                return;
            }

            // Clear existing content first
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                if (noResults) noResults.style.display = 'block';
                return;
            }

            if (noResults) noResults.style.display = 'none';

            // For very large datasets, limit initial render and add pagination
            const maxInitialRender = 500;
            const dataToRender = filteredData.length > maxInitialRender
                ? filteredData.slice(0, maxInitialRender)
                : filteredData;

            if (filteredData.length > maxInitialRender) {
                console.log(`⚡ Rendering first ${maxInitialRender} of ${filteredData.length} devices for performance`);
                showNotification(`📊 Displaying first ${maxInitialRender} devices. Use filters to narrow results.`, 'info');
            }

            const html = dataToRender.map((device, index) => {
                // CRITICAL FIX: Use extracted vendor/type first, fallback to detection
                // Previous bug: Always called detectVendorFromCSV() and ignored device.vendor
                const detectedVendor = device.vendor || detectVendorFromCSV(device);
                const detectedType = device.deviceType || detectDeviceTypeFromCSV(device);

                const firmwareShort = device.firmwareVersion ? device.firmwareVersion.substring(0, 20) : '-';
                const ipAddress = device.managementIP || '-';
                const rowClass = device.isCritical ? 'critical-row' : (device.isOffline ? 'offline-row' : '');

                // Debug first 3 devices to see actual data
                if (index < 3) {
                    console.log(`📊 Rendering device ${index + 1}:`, {
                        deviceName: device.deviceName,
                        'device.vendor (extracted)': device.vendor,
                        'detectedVendor (final)': detectedVendor,
                        'device.model': device.model,
                        'device.firmwareVersion': device.firmwareVersion,
                        'device.deviceProfile': device.deviceProfile,
                        'device.systemDescription': device.systemDescription,
                        sn: device.sn,
                        type: detectedType,
                        state: device.state,
                        region: device.region,
                        worldRegion: device.worldRegion,
                        fullLocation: device.fullLocation
                    });
                }

                return `
                <tr class="${selectedRows.has(index) ? 'selected' : ''} ${rowClass}" data-index="${index}">
                    <td><input type="checkbox" class="row-checkbox" ${selectedRows.has(index) ? 'checked' : ''} onchange="toggleRowSelection(${index})"></td>
                    <!-- Identity Group -->
                    <td>
                        <div class="device-name-cell">
                            <span class="device-name-primary">${escapeHtml(device.deviceName)}</span>
                            ${device.deviceName ? '<button class="copy-btn-inline" onclick="copyToClipboard(\'' + escapeHtml(device.deviceName) + '\', event)" title="Copy">📋</button>' : ''}
                        </div>
                    </td>
                    <td>
                        <div class="ip-cell">
                            <span class="ip-text">${escapeHtml(ipAddress)}</span>
                            ${ipAddress !== '-' ? '<button class="copy-btn-inline" onclick="copyToClipboard(\'' + escapeHtml(ipAddress) + '\', event)" title="Copy">📋</button>' : ''}
                        </div>
                    </td>
                    <td>
                        <div class="serial-cell">
                            <code style="font-size: 0.8em; background: #f1f5f9; padding: 2px 4px; border-radius: 3px;">${escapeHtml(device.sn) || '-'}</code>
                            ${device.sn ? '<button class="copy-btn-inline" onclick="copyToClipboard(\'' + escapeHtml(device.sn) + '\', event)" title="Copy">📋</button>' : ''}
                        </div>
                    </td>
                    <!-- Device Info Group -->
                    <td><span class="vendor-badge">${getVendorIcon(detectedVendor)} ${detectedVendor}</span></td>
                    <td><span class="type-badge">${getDeviceTypeIcon(detectedType)} ${detectedType}</span></td>
                    <td>
                        <span class="model-text" style="font-family: monospace; font-size: 0.85em; font-weight: 600;">${escapeHtml(device.model) || 'Unknown'}</span>
                    </td>
                    <td>
                        <span class="firmware-text" title="${escapeHtml(device.firmwareVersion || '')}" style="font-size: 0.8em; color: #64748b;">${escapeHtml(firmwareShort)}</span>
                    </td>
                    <!-- Location Group -->
                    <td>
                        <div class="location-cell">
                            <span style="font-size: 1.2em;">${getRegionFlag(device.region)}</span>
                            <span style="font-weight: 600; margin-left: 4px;">${device.fullLocation || device.region || 'Unknown'}</span>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <span class="site-badge">${getSiteTypeIcon(device.siteType)} ${device.siteType || 'Other'}</span>
                            <span class="role-badge">${device.deviceRole || 'General'}</span>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');

            // Use requestAnimationFrame for smooth rendering
            requestAnimationFrame(() => {
                tbody.innerHTML = html;
                // Reset opacity after rendering
                tbody.style.opacity = '1';
                tbody.style.transition = 'opacity 0.3s';
                // Update table statistics
                updateTableStatistics();
            });
        }

        // Update table statistics display
        function updateTableStatistics() {
            const totalDevices = filteredData.length;

            const rowCountEl = document.getElementById('tableRowCount');

            if (rowCountEl) rowCountEl.textContent = totalDevices;
        }

        // Toggle compact mode for the table - Enhanced for premium feel
        function toggleCompactMode() {
            const table = document.getElementById('dataTable');
            const wrapper = document.querySelector('.table-scroll-wrapper');
            if (table) {
                table.classList.toggle('compact-mode');
                if (wrapper) wrapper.classList.toggle('compact-mode');
                const btn = event.target;
                if (table.classList.contains('compact-mode')) {
                    btn.textContent = '📊 Normal View';
                    btn.style.background = '#3b82f6';
                    btn.style.color = 'white';
                    // Enhanced compact mode styling for cleaner, more defined look
                    const style = document.createElement('style');
                    style.id = 'compact-mode-style';
                    style.innerHTML = `
                        /* Premium Compact Mode - Enterprise Grade */
                        .compact-mode td {
                            padding: 4px 6px !important;
                            font-size: 0.8em !important;
                            border-bottom: 1px solid #e2e8f0 !important;
                            height: 32px !important;
                            line-height: 1.4 !important;
                            vertical-align: middle !important;
                        }
                        .compact-mode th {
                            padding: 6px 8px !important;
                            font-size: 0.75em !important;
                            font-weight: 600 !important;
                            letter-spacing: 0.5px !important;
                            text-transform: uppercase !important;
                        }
                        .compact-mode tr {
                            transition: background 0.1s !important;
                        }
                        .compact-mode tr:hover td {
                            background: linear-gradient(90deg, #f0f9ff 0%, #f8fafc 100%) !important;
                        }
                        .compact-mode .copy-btn-inline {
                            display: none !important;
                        }
                        .compact-mode .badge {
                            padding: 1px 5px !important;
                            font-size: 0.65em !important;
                            border-radius: 2px !important;
                            font-weight: 600 !important;
                        }
                        .compact-mode code {
                            font-size: 0.65em !important;
                            padding: 0 2px !important;
                        }
                        .compact-mode.table-scroll-wrapper {
                            max-height: calc(100vh - 320px) !important;
                        }
                        .compact-mode tbody tr:nth-child(even) td {
                            background: #fafbfc !important;
                        }
                        body.dark-mode .compact-mode td {
                            border-bottom: 1px solid #334155 !important;
                        }
                        body.dark-mode .compact-mode tr:hover td {
                            background: #1e293b !important;
                        }
                        body.dark-mode .compact-mode tbody tr:nth-child(even) td {
                            background: #0f172a !important;
                        }
                    `;
                    document.head.appendChild(style);
                    localStorage.setItem('preferCompactView', 'true');
                } else {
                    btn.textContent = '📐 Compact View';
                    btn.style.background = '';
                    btn.style.color = '';
                    const compactStyle = document.getElementById('compact-mode-style');
                    if (compactStyle) compactStyle.remove();
                    localStorage.setItem('preferCompactView', 'false');
                }
            }
        }

        // Export visible table data
        function exportVisibleTable() {
            const headers = ['Device Name', 'IP Address', 'Serial Number', 'Vendor', 'Type', 'Model', 'Firmware', 'Region', 'Site'];
            const rows = filteredData.map(device => [
                device.deviceName || '',
                device.managementIP || '',
                device.sn || '',
                detectVendorFromCSV(device),
                detectDeviceTypeFromCSV(device),
                device.model || '',
                device.firmwareVersion || '',
                device.fullLocation || device.region || '',
                device.siteType || ''
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `network-inventory-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification(`✅ Exported ${filteredData.length} devices to CSV`);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper functions for table rendering
        function getRegionFlag(region) {
            const flags = {
                'US': '🇺🇸', 'CA': '🇨🇦', 'MX': '🇲🇽',
                'EU': '🇪🇺', 'UK': '🇬🇧', 'DE': '🇩🇪', 'FR': '🇫🇷',
                'APAC': '🌏', 'LATAM': '🌎', 'MEA': '🌍'
            };
            return flags[region] || '🌍';
        }

        function getVendorIcon(vendor) {
            const icons = {
                'Fortinet': '🔥',
                'Palo Alto Networks': '🛡️',
                'Cisco': '📡',
                'Check Point': '✅',
                'Juniper': '🌲',
                'F5 Networks': '⚖️'
            };
            return icons[vendor] || '🏢';
        }

        function getDeviceTypeIcon(type) {
            const icons = {
                'Firewall': '🔥',
                'Router': '🔀',
                'Switch': '🔗',
                'Load Balancer': '⚖️'
            };
            return icons[type] || '🔌';
        }

        function getSiteTypeIcon(siteType) {
            const icons = {
                'PDC': '🏢',
                'BDC': '🏢',
                'CAT': '📁',
                'HQ': '🏛️',
                'Branch': '🏪',
                'Remote': '📡',
                'Cloud': '☁️',
                'Colo': '🏗️'
            };
            return icons[siteType] || '📍';
        }

        // 🚨 NOC Rendering Helper Functions
        function getStatusIcon(status) {
            const icons = {
                'NORMAL': '✅',
                'MINOR': '⚠️',
                'UNKNOWN': '❓',
                'CRITICAL': '🔴',
                'DOWN': '❌',
                'NOSTATUS': '⚪'
            };
            return icons[status] || '❓';
        }

        function getHealthColor(score) {
            if (score >= 90) return '#28a745';  // Green
            if (score >= 70) return '#ffc107';  // Yellow
            if (score >= 50) return '#fd7e14';  // Orange
            return '#dc3545';  // Red
        }

        function getHealthIcon(score) {
            if (score >= 90) return '💚';
            if (score >= 70) return '💛';
            if (score >= 50) return '🧡';
            return '❤️';
        }

        // Filter by region
        // Region Filter
        function filterByRegion(region, buttonElement) {
            currentRegion = region;
            if (buttonElement) updateActiveButton(buttonElement);
            applyFilters();
        }

        // Vendor Filter
        function filterByVendor(vendor, buttonElement) {
            currentVendor = vendor;
            if (buttonElement) updateActiveButton(buttonElement);
            applyFilters();
        }

        // Device Type Filter
        function filterByDeviceType(deviceType, buttonElement) {
            currentDeviceType = deviceType;
            if (buttonElement) updateActiveButton(buttonElement);
            applyFilters();
        }

        // Site Type Filter
        function filterBySiteType(siteType, buttonElement) {
            currentSiteType = siteType;
            if (buttonElement) updateActiveButton(buttonElement);
            applyFilters();
        }

        // Device Role Filter
        function filterByDeviceRole(deviceRole, buttonElement) {
            currentDeviceRole = deviceRole;
            if (buttonElement) updateActiveButton(buttonElement);
            applyFilters();
        }

        // 🚨 NOC Status Filter
        function filterByNOCStatus(status, buttonElement) {
            currentNOCStatus = status;
            if (buttonElement) updateActiveButton(buttonElement);
            applyFilters();
        }

        // Helper function to update active button
        function updateActiveButton(clickedButton) {
            const parentSection = clickedButton.closest('.filter-section');
            const buttonsInSection = parentSection.querySelectorAll('.filter-btn');
            buttonsInSection.forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
        }

        // Apply all filters - Multi-dimensional filtering
        function applyFilters() {
            console.log('applyFilters called');

            // Show loading state
            const tbody = document.getElementById('tableBody');
            if (tbody) {
                tbody.style.opacity = '0.5';
                tbody.style.transition = 'opacity 0.2s';
            }

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            console.log('Current filters - Region:', currentRegion, 'Vendor:', currentVendor, 'Type:', currentDeviceType, 'Search:', searchTerm);

            filteredData = deviceData.filter(device => {
                // Region filter - Use VALIDATED state from geographic validator
                let regionMatch = true;
                if (currentRegion !== 'all') {
                    // Use validated device.state from analyzeGeographicLocation()
                    const deviceState = device.state || '';
                    regionMatch = deviceState === currentRegion;
                }

                // Vendor filter - Use intelligent detection
                let vendorMatch = true;
                if (currentVendor !== 'all') {
                    const detectedVendor = detectVendorFromCSV(device);
                    vendorMatch = detectedVendor === currentVendor;
                }

                // Device Type filter - Use intelligent detection
                let deviceTypeMatch = true;
                if (currentDeviceType !== 'all') {
                    const detectedType = detectDeviceTypeFromCSV(device);
                    deviceTypeMatch = detectedType === currentDeviceType;
                }

                // Site Type filter - Use intelligent detection
                let siteTypeMatch = true;
                if (currentSiteType !== 'all') {
                    const detectedSiteType = detectSiteType(device.deviceName);
                    siteTypeMatch = detectedSiteType === currentSiteType;
                }

                // Device Role filter - Use intelligent detection
                let deviceRoleMatch = true;
                if (currentDeviceRole !== 'all') {
                    const detectedRole = detectDeviceRole(device.deviceName);
                    deviceRoleMatch = detectedRole === currentDeviceRole;
                }

                // 🚨 NOC Status filter
                let nocStatusMatch = true;
                if (currentNOCStatus !== 'all') {
                    switch(currentNOCStatus.toLowerCase()) {
                        case 'critical':
                            nocStatusMatch = device.isCritical === true;
                            break;
                        case 'offline':
                            nocStatusMatch = device.isOffline === true;
                            break;
                        case 'low_health':
                            nocStatusMatch = device.healthScore && device.healthScore < 70;
                            break;
                        default:
                            nocStatusMatch = true;
                    }
                }

                // Search filter - now includes new fields
                const searchMatch = !searchTerm ||
                    (device.deviceName && device.deviceName.toLowerCase().includes(searchTerm)) ||
                    (device.sn && device.sn.toLowerCase().includes(searchTerm)) ||
                    (device.sn_ha1 && device.sn_ha1.toLowerCase().includes(searchTerm)) ||
                    (device.sn_ha2 && device.sn_ha2.toLowerCase().includes(searchTerm)) ||
                    (device.model && device.model.toLowerCase().includes(searchTerm)) ||
                    (device.series && device.series.toLowerCase().includes(searchTerm)) ||
                    (device.vendor && device.vendor.toLowerCase().includes(searchTerm)) ||
                    (device.deviceType && device.deviceType.toLowerCase().includes(searchTerm)) ||
                    (device.siteType && device.siteType.toLowerCase().includes(searchTerm)) ||
                    (device.deviceRole && device.deviceRole.toLowerCase().includes(searchTerm)) ||
                    (device.region && device.region.toLowerCase().includes(searchTerm));

                return regionMatch && vendorMatch && deviceTypeMatch && siteTypeMatch && deviceRoleMatch && nocStatusMatch && searchMatch;
            });

            console.log('✓ applyFilters complete - filteredData.length:', filteredData.length, 'of', deviceData.length);
            updateStats();
            updateFilterBadges();
            renderTable();
        }

        // Update all filter badges
        function updateFilterBadges() {
            // Helper function to safely update badge
            const updateBadge = (id, count) => {
                const badge = document.getElementById(id);
                if (badge) badge.textContent = count;
            };

            // Region badges
            updateBadge('badge-region-all', deviceData.length);
            updateBadge('badge-region-us', deviceData.filter(d => d.region === 'US').length);
            updateBadge('badge-region-ca', deviceData.filter(d => d.region === 'CA').length);
            updateBadge('badge-region-mx', deviceData.filter(d => d.region === 'MX').length);
            updateBadge('badge-region-eu', deviceData.filter(d => d.region === 'EU').length);
            updateBadge('badge-region-uk', deviceData.filter(d => d.region === 'UK').length);
            updateBadge('badge-region-de', deviceData.filter(d => d.region === 'DE').length);
            updateBadge('badge-region-fr', deviceData.filter(d => d.region === 'FR').length);
            updateBadge('badge-region-apac', deviceData.filter(d => d.region === 'APAC').length);
            updateBadge('badge-region-latam', deviceData.filter(d => d.region === 'LATAM').length);
            updateBadge('badge-region-mea', deviceData.filter(d => d.region === 'MEA').length);

            // Vendor badges
            updateBadge('badge-vendor-all', deviceData.length);
            updateBadge('badge-vendor-fortinet', deviceData.filter(d => d.vendor === 'Fortinet').length);
            updateBadge('badge-vendor-paloalto', deviceData.filter(d => d.vendor === 'Palo Alto Networks').length);
            updateBadge('badge-vendor-cisco', deviceData.filter(d => d.vendor === 'Cisco').length);
            updateBadge('badge-vendor-checkpoint', deviceData.filter(d => d.vendor === 'Check Point').length);
            updateBadge('badge-vendor-juniper', deviceData.filter(d => d.vendor === 'Juniper').length);
            updateBadge('badge-vendor-f5', deviceData.filter(d => d.vendor === 'F5 Networks').length);

            // Device Type badges
            updateBadge('badge-type-all', deviceData.length);
            updateBadge('badge-type-firewall', deviceData.filter(d => d.deviceType === 'Firewall').length);
            updateBadge('badge-type-router', deviceData.filter(d => d.deviceType === 'Router').length);
            updateBadge('badge-type-switch', deviceData.filter(d => d.deviceType === 'Switch').length);
            updateBadge('badge-type-lb', deviceData.filter(d => d.deviceType === 'Load Balancer').length);

            // Site Type badges
            updateBadge('badge-site-all', deviceData.length);
            updateBadge('badge-site-pdc', deviceData.filter(d => d.siteType === 'PDC').length);
            updateBadge('badge-site-bdc', deviceData.filter(d => d.siteType === 'BDC').length);
            updateBadge('badge-site-cat', deviceData.filter(d => d.siteType === 'CAT').length);
            updateBadge('badge-site-hq', deviceData.filter(d => d.siteType === 'HQ').length);
            updateBadge('badge-site-branch', deviceData.filter(d => d.siteType === 'Branch').length);
            updateBadge('badge-site-remote', deviceData.filter(d => d.siteType === 'Remote').length);
            updateBadge('badge-site-cloud', deviceData.filter(d => d.siteType === 'Cloud').length);

            // Device Role badges
            updateBadge('badge-role-all', deviceData.length);
            updateBadge('badge-role-vpn', deviceData.filter(d => d.deviceRole === 'VPN Gateway').length);
            updateBadge('badge-role-wan', deviceData.filter(d => d.deviceRole === 'WAN Edge').length);
            updateBadge('badge-role-dmz', deviceData.filter(d => d.deviceRole === 'DMZ Firewall').length);
            updateBadge('badge-role-internet', deviceData.filter(d => d.deviceRole === 'Internet Edge').length);
            updateBadge('badge-role-access', deviceData.filter(d => d.deviceRole === 'Access').length);
            updateBadge('badge-role-firewall', deviceData.filter(d => d.deviceRole === 'Firewall').length);
        }

        // Quick filter
        function quickFilter(keyword) {
            document.getElementById('searchInput').value = keyword;
            searchData();

            // Highlight active chip
            document.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Search data
        function searchData() {
            const searchTerm = document.getElementById('searchInput').value;
            const clearBtn = document.getElementById('searchClear');

            if (searchTerm) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }

            applyFilters();
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchClear').classList.remove('visible');
            document.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
            searchData();
        }

        // Sort table
        function sortTable(column) {
            // Update sort indicators
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            if (sortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                sortColumn = column;
                sortAscending = true;
            }

            // Column mapping: 0=Location, 1=Device Name, 2=Vendor, 3=Type, 4=Model, 5=Site, 6=Role, 7=Primary SN, 8=HA Status, 9=HA SN 1, 10=HA SN 2
            const fields = ['region', 'deviceName', 'vendor', 'deviceType', 'model', 'siteType', 'deviceRole', 'sn', 'hasHA', 'sn_ha1', 'sn_ha2'];
            const field = fields[column];

            filteredData.sort((a, b) => {
                let valA, valB;

                // Use detection functions for vendor and type
                if (field === 'vendor') {
                    valA = detectVendorFromCSV(a);
                    valB = detectVendorFromCSV(b);
                } else if (field === 'deviceType') {
                    valA = detectDeviceTypeFromCSV(a);
                    valB = detectDeviceTypeFromCSV(b);
                } else {
                    valA = a[field];
                    valB = b[field];
                }

                if (typeof valA === 'boolean') {
                    valA = valA ? 1 : 0;
                    valB = valB ? 1 : 0;
                }

                // Handle null/undefined values
                if (valA == null) valA = '';
                if (valB == null) valB = '';

                if (valA < valB) return sortAscending ? -1 : 1;
                if (valA > valB) return sortAscending ? 1 : -1;
                return 0;
            });

            // Add sort indicator to clicked column
            const th = event.target;
            th.classList.add(sortAscending ? 'sort-asc' : 'sort-desc');

            renderTable();
        }

        // Row selection
        function toggleRowSelection(index) {
            if (selectedRows.has(index)) {
                selectedRows.delete(index);
            } else {
                selectedRows.add(index);
            }
            renderTable();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            if (selectAll.checked) {
                filteredData.forEach((_, index) => selectedRows.add(index));
            } else {
                selectedRows.clear();
            }
            renderTable();
        }

        // Copy to clipboard
        function copyToClipboard(text, event) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('✅ Copied: ' + text);
                if (event && event.target) {
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.style.background = '#28a745';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 1500);
                }
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('❌ Failed to copy', 'error');
            });
        }

        // Bulk copy serials
        function bulkCopySerials() {
            const serials = filteredData
                .map(d => d.sn)
                .filter(sn => sn)
                .join('\n');

            navigator.clipboard.writeText(serials).then(() => {
                showNotification(`✅ Copied ${filteredData.length} serial numbers!`);
            }).catch(err => {
                showNotification('❌ Failed to copy', 'error');
            });
        }

        // =====================================================
        // EXCEL-GRADE CSV EXPORT - NOC OPTIMIZED
        // =====================================================
        function exportToCSV() {
            if (!filteredData || filteredData.length === 0) {
                showNotification('⚠️ No data available for export', 'error');
                return;
            }

            const now = new Date();
            const timestamp = now.toISOString().split('T')[0];

            try {
                // Professional CSV Header - Excel Compatible, No Comments
                const headers = [
                    'Device Name',
                    'IP Address',
                    'Vendor',
                    'Model',
                    'Serial Number',
                    'Device Type',
                    'Risk Level',
                    'Risk Score',
                    'Compliance',
                    'Region',
                    'Country',
                    'State/Province',
                    'City',
                    'Site Type',
                    'Device Role',
                    'Firmware Version',
                    'Age (Years)',
                    'Support Status',
                    'Last Seen',
                    'Critical Issues',
                    'Recommendations',
                    'Import Date'
                ];

                let csv = headers.join(',') + '\n';

                // Process each device with complete data validation
                filteredData.forEach(device => {
                    try {
                        // Safe calculation functions with error handling
                        const health = device.healthScore ?
                            { score: device.healthScore, grade: getHealthGrade(device.healthScore) } :
                            calculateDeviceHealth(device);

                        const risk = device.riskScore ?
                            { totalScore: device.riskScore, level: getRiskLevel(device.riskScore) } :
                            calculateRiskScore(device);

                        const compliance = device.complianceScore ?
                            { score: device.complianceScore, status: device.complianceScore >= 80 ? 'Compliant' : 'Non-Compliant' } :
                            calculateComplianceScore(device);

                        // Ensure all values are properly formatted and escaped
                        const rowData = [
                            device.deviceName || 'UNKNOWN',
                            device.ipAddress || device.managementIP || '',
                            device.vendor || detectVendorFromCSV(device) || 'Unknown',
                            device.model || 'Unknown',
                            device.sn || device.serialNumber || '',
                            device.deviceType || detectDeviceTypeFromCSV(device) || 'Unknown',
                            risk.level || 'Unknown',
                            risk.totalScore || 0,
                            compliance.status || 'Unknown',
                            device.region || 'Unknown',
                            device.country || '',
                            device.state || '',
                            device.city || '',
                            device.siteType || 'General',
                            device.deviceRole || 'Network',
                            device.firmwareVersion || device.firmware || '',
                            device.ageYears || estimateDeviceAge(device) || 0,
                            assessVendorSupport(device) || 'Unknown',
                            device.lastSeen || now.toISOString(),
                            risk.level === 'Critical' ? 'YES' : 'NO',
                            getTopRecommendation(health, risk, compliance),
                            device.importDate || timestamp
                        ];

                        // Excel-safe CSV formatting
                        const csvRow = rowData.map(val => {
                            if (val === null || val === undefined) return '';
                            const str = String(val);
                            // Handle special characters properly for Excel
                            if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
                                return `"${str.replace(/"/g, '""').replace(/\n/g, ' ').replace(/\r/g, '')}"`;
                            }
                            return str;
                        }).join(',');

                        csv += csvRow + '\n';
                    } catch (deviceError) {
                        console.error(`Error processing device ${device.deviceName}:`, deviceError);
                        // Add error row with basic info
                        csv += `"${device.deviceName || 'ERROR'}",ERROR,ERROR,ERROR,"${device.sn || ''}",ERROR,ERROR,0,F,Unknown,0,Unknown,"${device.region || 'Unknown'}",,,,,,,,,,,,,,"Processing Error","${timestamp}"\n`;
                    }
                });

                // Create UTF-8 BOM for Excel compatibility
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `NetAssets_Export_${timestamp}.csv`;
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification(`✅ Successfully exported ${filteredData.length} devices to Excel-compatible CSV`, 'success');

                // Log export metrics
                console.log('📊 Export Metrics:', {
                    format: 'CSV',
                    devices: filteredData.length,
                    timestamp: timestamp,
                    healthAvg: (filteredData.reduce((sum, d) => sum + (calculateDeviceHealth(d).score || 0), 0) / filteredData.length).toFixed(1)
                });

                if (document.getElementById('exportDropdown')) {
                    document.getElementById('exportDropdown').classList.remove('show');
                }
            } catch (error) {
                console.error('Export error:', error);
                showNotification('❌ Export failed. Please check console for details.', 'error');
            }
        }

        // Helper function to get top recommendation
        function getTopRecommendation(health, risk, compliance) {
            const recommendations = [];

            if (health && health.score < 50) {
                recommendations.push('Urgent: Health check required');
            }
            if (risk && risk.level === 'Critical') {
                recommendations.push('Critical: Immediate risk mitigation needed');
            }
            if (compliance && compliance.status === 'Non-Compliant') {
                recommendations.push('Action: Compliance remediation required');
            }

            if (recommendations.length === 0) {
                if (health && health.recommendations && health.recommendations.length > 0) {
                    recommendations.push(health.recommendations[0]);
                } else {
                    recommendations.push('Monitoring: Continue standard maintenance');
                }
            }

            return recommendations.join('; ');
        }

        // Helper function to get risk level from score
        function getRiskLevel(score) {
            if (!score || score === 0) return 'Minimal';
            if (score >= 80) return 'Critical';
            if (score >= 60) return 'High';
            if (score >= 40) return 'Medium';
            if (score >= 20) return 'Low';
            return 'Minimal';
        }

        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            showNotification(`🌓 ${isDark ? 'Dark' : 'Light'} mode enabled`);
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;

            if (type === 'error') {
                notification.style.background = 'var(--danger-color)';
            }

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', searchData);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                clearSearch();
            }
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                preparePrint();
                setTimeout(() => window.print(), 100);
            }
        });

        // Prepare print metadata
        function preparePrint() {
            document.getElementById('printDate').textContent = new Date().toLocaleString();
            document.getElementById('printCount').textContent = filteredData.length;
        }

        // Update print metadata before printing
        window.addEventListener('beforeprint', preparePrint);

        // Analytics Dashboard
        let analyticsCharts = {};

        function toggleAnalytics() {
            const dashboard = document.getElementById('analyticsDashboard');
            dashboard.classList.toggle('show');

            if (dashboard.classList.contains('show')) {
                initializeAnalytics();
            }
        }

        function initializeAnalytics() {
            generateInsights();
            generateSiteHealth();
            createDataCenterChart();
            createHAChart();
            createRegionChart();
            createModelChart();
        }

        function generateInsights() {
            const pdcDevices = deviceData.filter(d => d.deviceName.includes('PDC'));
            const bdcDevices = deviceData.filter(d => d.deviceName.includes('BDC'));
            const noHADevices = deviceData.filter(d => !d.hasHA);
            const criticalSites = [...new Set(deviceData.filter(d => d.deviceName.match(/PDC|BDC/)).map(d => {
                const match = d.deviceName.match(/^([A-Z]{2,4})-(?:PDC|BDC)/);
                return match ? match[1] : null;
            }).filter(Boolean))].length;

            const insights = [
                {
                    icon: '🏢',
                    title: 'Primary Data Centers',
                    value: pdcDevices.length,
                    description: 'Devices in PDC sites with high availability requirements',
                    class: 'success'
                },
                {
                    icon: '🔄',
                    title: 'Backup Data Centers',
                    value: bdcDevices.length,
                    description: 'Devices providing disaster recovery capabilities',
                    class: 'info'
                },
                {
                    icon: '⚠️',
                    title: 'Single Point of Failure',
                    value: noHADevices.length,
                    description: 'Devices without HA configuration - potential risk',
                    class: 'danger'
                },
                {
                    icon: '🌐',
                    title: 'Critical Sites',
                    value: criticalSites,
                    description: 'Unique data center locations across infrastructure',
                    class: 'primary'
                }
            ];

            const insightsHTML = insights.map(insight => `
                <div class="insight-card ${insight.class}">
                    <div class="insight-icon">${insight.icon}</div>
                    <div class="insight-title">${insight.title}</div>
                    <div class="insight-value">${insight.value}</div>
                    <div class="insight-description">${insight.description}</div>
                </div>
            `).join('');

            document.getElementById('insightsGrid').innerHTML = insightsHTML;
        }

        function generateSiteHealth() {
            const sites = {};

            deviceData.forEach(device => {
                const pdcMatch = device.deviceName.match(/^([A-Z]{2,4})-PDC/);
                const bdcMatch = device.deviceName.match(/^([A-Z]{2,4})-BDC/);

                if (pdcMatch) {
                    const siteName = pdcMatch[1];
                    if (!sites[siteName]) sites[siteName] = { pdc: 0, bdc: 0, pdcHA: 0, bdcHA: 0 };
                    sites[siteName].pdc++;
                    if (device.hasHA) sites[siteName].pdcHA++;
                }
                if (bdcMatch) {
                    const siteName = bdcMatch[1];
                    if (!sites[siteName]) sites[siteName] = { pdc: 0, bdc: 0, pdcHA: 0, bdcHA: 0 };
                    sites[siteName].bdc++;
                    if (device.hasHA) sites[siteName].bdcHA++;
                }
            });

            const siteHealthHTML = Object.entries(sites)
                .sort((a, b) => (b[1].pdc + b[1].bdc) - (a[1].pdc + a[1].bdc))
                .map(([siteName, counts]) => `
                    <div class="site-health-card">
                        <div class="site-icon pdc">🏢</div>
                        <div class="site-details">
                            <div class="site-name">${siteName} Data Center</div>
                            <div class="site-status">
                                PDC: ${counts.pdc} devices (${counts.pdcHA} HA) |
                                BDC: ${counts.bdc} devices (${counts.bdcHA} HA)
                            </div>
                        </div>
                    </div>
                `).join('');

            document.getElementById('siteHealthGrid').innerHTML = siteHealthHTML || '<p>No critical infrastructure sites detected</p>';
        }

        function createDataCenterChart() {
            const ctx = document.getElementById('dcChart');
            if (!ctx) return;

            const pdcCount = deviceData.filter(d => d.deviceName.includes('PDC')).length;
            const bdcCount = deviceData.filter(d => d.deviceName.includes('BDC')).length;
            const otherCount = deviceData.length - pdcCount - bdcCount;

            if (analyticsCharts.dcChart) analyticsCharts.dcChart.destroy();

            analyticsCharts.dcChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Primary DC (PDC)', 'Backup DC (BDC)', 'Other Sites'],
                    datasets: [{
                        data: [pdcCount, bdcCount, otherCount],
                        backgroundColor: ['#28a745', '#17a2b8', '#6c757d'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createHAChart() {
            const ctx = document.getElementById('haChart');
            if (!ctx) return;

            const haCount = deviceData.filter(d => d.hasHA).length;
            const standaloneCount = deviceData.length - haCount;

            if (analyticsCharts.haChart) analyticsCharts.haChart.destroy();

            analyticsCharts.haChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['HA Configured', 'Standalone'],
                    datasets: [{
                        data: [haCount, standaloneCount],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createRegionChart() {
            const ctx = document.getElementById('regionChart');
            if (!ctx) return;

            const usCount = deviceData.filter(d => d.region === 'US').length;
            const euCount = deviceData.filter(d => d.region === 'EU').length;

            if (analyticsCharts.regionChart) analyticsCharts.regionChart.destroy();

            analyticsCharts.regionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['United States', 'Europe'],
                    datasets: [{
                        label: 'Device Count',
                        data: [usCount, euCount],
                        backgroundColor: ['#667eea', '#764ba2'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createModelChart() {
            const ctx = document.getElementById('modelChart');
            if (!ctx) return;

            const modelCounts = {};
            deviceData.forEach(device => {
                modelCounts[device.model] = (modelCounts[device.model] || 0) + 1;
            });

            const sortedModels = Object.entries(modelCounts).sort((a, b) => b[1] - a[1]);

            if (analyticsCharts.modelChart) analyticsCharts.modelChart.destroy();

            analyticsCharts.modelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedModels.map(([model]) => model),
                    datasets: [{
                        label: 'Devices',
                        data: sortedModels.map(([, count]) => count),
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // View Toggle
        let currentView = 'table';

        function switchView(view) {
            currentView = view;

            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Toggle views
            if (view === 'table') {
                document.getElementById('tableView').style.display = 'block';
                document.getElementById('cardView').style.display = 'none';
            } else {
                document.getElementById('tableView').style.display = 'none';
                document.getElementById('cardView').style.display = 'grid';
                renderCardView();
            }
        }

        // Render Card View
        function renderCardView() {
            const cardView = document.getElementById('cardView');

            if (filteredData.length === 0) {
                cardView.innerHTML = '<div class="no-results">🔍 No devices found matching your search criteria.</div>';
                return;
            }

            const cards = filteredData.map(device => {
                const detectedVendor = detectVendorFromCSV(device);
                const detectedType = detectDeviceTypeFromCSV(device);

                return `
                <div class="device-card">
                    <div class="device-card-header">
                        <div class="device-card-title">${escapeHtml(device.deviceName)}</div>
                        <div class="device-card-region">${getRegionFlag(device.region)}</div>
                    </div>
                    <div class="device-card-body">
                        <div class="device-info-row">
                            <div class="device-info-label">Vendor</div>
                            <div class="device-info-value">
                                <span class="vendor-badge">${getVendorIcon(detectedVendor)} ${detectedVendor}</span>
                            </div>
                        </div>
                        <div class="device-info-row">
                            <div class="device-info-label">Type</div>
                            <div class="device-info-value">
                                <span class="type-badge">${getDeviceTypeIcon(detectedType)} ${detectedType}</span>
                            </div>
                        </div>
                        <div class="device-info-row">
                            <div class="device-info-label">Model</div>
                            <div class="device-info-value">
                                <span class="model-text">${escapeHtml(device.model) || 'Unknown'}</span>
                            </div>
                        </div>
                        <div class="device-info-row">
                            <div class="device-info-label">Primary Serial</div>
                            <div class="device-info-value">
                                <span class="serial-text">${escapeHtml(device.sn) || '-'}</span>
                                ${device.sn ? '<button class="copy-btn" onclick="copyToClipboard(\'' + escapeHtml(device.sn) + '\', event)">Copy</button>' : ''}
                            </div>
                        </div>
                        <div class="device-info-row">
                            <div class="device-info-label">HA Status</div>
                            <div class="device-info-value">
                                <span class="ha-indicator ${device.hasHA ? 'ha-yes' : 'ha-no'}">
                                    ${device.hasHA ? '✅ HA' : '⚠️ Standalone'}
                                </span>
                            </div>
                        </div>
                        ${device.sn_ha1 ? `
                        <div class="device-info-row">
                            <div class="device-info-label">HA Serial 1</div>
                            <div class="device-info-value">
                                <span class="serial-text">${escapeHtml(device.sn_ha1)}</span>
                                <button class="copy-btn" onclick="copyToClipboard('${escapeHtml(device.sn_ha1)}', event)">Copy</button>
                            </div>
                        </div>
                        ` : ''}
                        ${device.sn_ha2 ? `
                        <div class="device-info-row">
                            <div class="device-info-label">HA Serial 2</div>
                            <div class="device-info-value">
                                <span class="serial-text">${escapeHtml(device.sn_ha2)}</span>
                                <button class="copy-btn" onclick="copyToClipboard('${escapeHtml(device.sn_ha2)}', event)">Copy</button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            }).join('');

            cardView.innerHTML = cards;
        }

        // Export Menu Toggle
        function toggleExportMenu() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('show');
        }

        // Close export menu when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('exportDropdown');
            const exportBtn = document.querySelector('.export-menu-container');

            if (dropdown && !exportBtn.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // =====================================================
        // ENTERPRISE JSON EXPORT - COMPLETE DATA STRUCTURE
        // =====================================================
        function exportToJSON() {
            if (!filteredData || filteredData.length === 0) {
                showNotification('⚠️ No data available for export', 'error');
                return;
            }

            const now = new Date();

            try {
                // Safe data processing with validation
                const totalDevices = filteredData.length;

                // Build comprehensive JSON structure with validation
                const exportData = {
                    metadata: {
                        exportVersion: "3.0",
                        application: "NetAssets Enterprise",
                        generated: now.toISOString(),
                        generatedBy: window.location.hostname || 'localhost',
                        totalDevices: totalDevices,
                        exportFormat: "JSON",
                        dataIntegrity: "validated"
                },
                summary: {
                    statistics: {
                        totalDevices: totalDevices
                    },
                    vendorBreakdown: filteredData.reduce((acc, d) => {
                        const vendor = detectVendorFromCSV(d);
                        acc[vendor] = (acc[vendor] || 0) + 1;
                        return acc;
                    }, {}),
                    deviceTypeBreakdown: filteredData.reduce((acc, d) => {
                        const type = detectDeviceTypeFromCSV(d);
                        acc[type] = (acc[type] || 0) + 1;
                        return acc;
                    }, {}),
                    siteTypeBreakdown: filteredData.reduce((acc, d) => {
                        const site = d.siteType || 'Unknown';
                        acc[site] = (acc[site] || 0) + 1;
                        return acc;
                    }, {}),
                    regionBreakdown: filteredData.reduce((acc, d) => {
                        const region = d.region || 'Unknown';
                        acc[region] = (acc[region] || 0) + 1;
                        return acc;
                    }, {})
                },
                devices: filteredData.map(device => {
                    // Safe data extraction with defaults
                    return {
                        identity: {
                            deviceName: device.deviceName || 'UNKNOWN',
                            serialNumber: device.sn || device.serialNumber || '',
                            model: device.model || 'Unknown',
                            vendor: device.vendor || detectVendorFromCSV(device) || 'Unknown',
                            deviceType: device.deviceType || detectDeviceTypeFromCSV(device) || 'Unknown'
                        },
                        location: {
                            region: device.region || 'Unknown',
                            country: device.country || '',
                            state: device.state || '',
                            city: device.city || '',
                            siteType: device.siteType || 'General',
                            deviceRole: device.deviceRole || 'Network',
                            fullLocation: [device.city, device.state, device.country].filter(Boolean).join(', ') || ''
                        },
                        configuration: {
                            managementIP: device.ipAddress || device.managementIP || '',
                            firmwareVersion: device.firmwareVersion || device.firmware || ''
                        },
                        metadata: {
                            importDate: device.importDate || now.toISOString(),
                            lastUpdated: device.lastUpdated || device.importDate || now.toISOString()
                        }
                    };
                })
                };

                // Convert to JSON with error handling
                const json = JSON.stringify(exportData, null, 2);
                const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `NetAssets_Export_${now.toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification(`✅ Successfully exported ${filteredData.length} devices to JSON`, 'success');

                // Log export analytics
                console.log('📊 JSON Export Analytics:', {
                    devices: totalDevices,
                    fileSize: (json.length / 1024).toFixed(2) + ' KB',
                    timestamp: now.toISOString()
                });

                if (document.getElementById('exportDropdown')) {
                    document.getElementById('exportDropdown').classList.remove('show');
                }
            } catch (error) {
                console.error('JSON Export error:', error);
                showNotification('❌ JSON export failed. Please check console for details.', 'error');
            }
        }

        // Export to Markdown - Premium Documentation Format with Assessment
        function exportToMarkdown() {
            const now = new Date();

            // Calculate assessment statistics
            const assessmentData = filteredData.map(device => ({
                device: device,
                health: calculateDeviceHealth(device),
                risk: calculateRiskScore(device),
                compliance: calculateComplianceScore(device)
            }));

            const avgHealth = (assessmentData.reduce((sum, a) => sum + a.health.score, 0) / assessmentData.length).toFixed(1);
            const haCoverage = ((filteredData.filter(d => d.hasHA).length / filteredData.length) * 100).toFixed(1);
            const criticalRisks = assessmentData.filter(a => a.risk.level === 'Critical').length;
            const complianceRate = ((assessmentData.filter(a => a.compliance.status === 'Compliant').length / assessmentData.length) * 100).toFixed(1);

            // Build enhanced Markdown document
            let md = '# 📊 NetAssets Premium - Network Infrastructure Report\n\n';
            md += '> Enterprise Network Device Inventory with Comprehensive Assessment\n\n';

            // Metadata section
            md += '## 📋 Report Information\n\n';
            md += `- **Generated:** ${now.toLocaleString()}\n`;
            md += `- **Total Devices:** ${filteredData.length}\n`;
            md += `- **Report Type:** Premium Assessment Export\n`;
            md += `- **Version:** 2.0\n\n`;

            // Executive Summary
            md += '## 📈 Executive Summary\n\n';
            md += '### Key Metrics\n\n';
            md += '| Metric | Value | Status |\n';
            md += '|--------|-------|--------|\n';
            md += `| **Average Health Score** | ${avgHealth}/100 | ${avgHealth >= 80 ? '✅ Good' : avgHealth >= 60 ? '⚠️ Fair' : '❌ Poor'} |\n`;
            md += `| **HA Coverage** | ${haCoverage}% | ${haCoverage >= 80 ? '✅ Excellent' : haCoverage >= 60 ? '⚠️ Good' : '❌ Needs Improvement'} |\n`;
            md += `| **Compliance Rate** | ${complianceRate}% | ${complianceRate >= 90 ? '✅ Compliant' : complianceRate >= 70 ? '⚠️ Partial' : '❌ Non-Compliant'} |\n`;
            md += `| **Critical Risk Devices** | ${criticalRisks} | ${criticalRisks === 0 ? '✅ None' : criticalRisks <= 5 ? '⚠️ Manageable' : '❌ High'} |\n\n`;

            // Health Grade Distribution
            md += '### Health Grade Distribution\n\n';
            md += '```\n';
            ['A', 'B', 'C', 'D', 'F'].forEach(grade => {
                const count = assessmentData.filter(a => a.health.grade === grade).length;
                const percentage = ((count / assessmentData.length) * 100).toFixed(1);
                if (count > 0) {
                    const bar = '█'.repeat(Math.floor(percentage / 2));
                    md += `Grade ${grade}: ${bar} ${count} devices (${percentage}%)\n`;
                }
            });
            md += '```\n\n';

            // Risk Assessment Summary
            md += '### Risk Assessment Summary\n\n';
            const riskLevels = ['Critical', 'High', 'Medium', 'Low', 'Minimal'];
            riskLevels.forEach(level => {
                const count = assessmentData.filter(a => a.risk.level === level).length;
                if (count > 0) {
                    const emoji = level === 'Critical' ? '🔴' : level === 'High' ? '🟠' : level === 'Medium' ? '🟡' : level === 'Low' ? '🔵' : '🟢';
                    md += `- ${emoji} **${level} Risk:** ${count} devices\n`;
                }
            });
            md += '\n';

            // Critical Devices Section
            if (criticalRisks > 0) {
                md += '## ⚠️ Critical Risk Devices (Immediate Attention Required)\n\n';
                md += '| Device | Site | Health | Risk Factors | Recommended Action |\n';
                md += '|--------|------|--------|--------------|--------------------|\n';

                assessmentData
                    .filter(a => a.risk.level === 'Critical')
                    .slice(0, 10)
                    .forEach(a => {
                        const riskFactors = a.risk.factors.map(f => f.type).join(', ');
                        const action = a.risk.mitigation[0]?.action || 'Review required';
                        md += `| **${a.device.deviceName}** | ${a.device.siteType || 'Unknown'} | ${a.health.grade} (${a.health.score}) | ${riskFactors} | ${action} |\n`;
                    });
                md += '\n';
            }

            // Main Device Inventory Table
            md += '## 📦 Device Inventory with Assessment\n\n';
            md += '| Region | Device | Vendor | Model | Health | Risk | Compliance | HA Status | Serial |\n';
            md += '|--------|--------|--------|-------|--------|------|------------|-----------|--------|\n';

            assessmentData.forEach(({ device, health, risk, compliance }) => {
                const region = getRegionFlag(device.region) + ' ' + (device.region || 'N/A');
                const vendor = detectVendorFromCSV(device);
                const haStatus = device.hasHA ? '✅ HA' : '⚠️ Solo';
                const healthBadge = `${health.grade}(${health.score})`;
                const riskBadge = risk.level;
                const complianceBadge = compliance.score + '%';

                md += `| ${region} | **${device.deviceName || 'N/A'}** | ${vendor} | ${device.model || 'Unknown'} | ${healthBadge} | ${riskBadge} | ${complianceBadge} | ${haStatus} | \`${device.sn || 'N/A'}\` |\n`;
            });
            md += '\n';

            // Vendor Distribution
            md += '## 🏢 Vendor Distribution\n\n';
            const vendorCounts = {};
            filteredData.forEach(device => {
                const vendor = detectVendorFromCSV(device);
                vendorCounts[vendor] = (vendorCounts[vendor] || 0) + 1;
            });

            Object.entries(vendorCounts)
                .sort((a, b) => b[1] - a[1])
                .forEach(([vendor, count]) => {
                    const percentage = ((count / filteredData.length) * 100).toFixed(1);
                    md += `- **${vendor}:** ${count} devices (${percentage}%)\n`;
                });
            md += '\n';

            // Recommendations
            md += '## 💡 Recommendations\n\n';
            md += '### Immediate Actions (Priority: Critical)\n\n';

            if (criticalRisks > 0) {
                md += `1. **Address ${criticalRisks} critical risk devices** - These devices pose immediate risk to infrastructure stability\n`;
            }

            const nonCompliant = assessmentData.filter(a => a.compliance.status === 'Non-Compliant').length;
            if (nonCompliant > 0) {
                md += `2. **Remediate ${nonCompliant} non-compliant devices** - Bring devices into compliance with security policies\n`;
            }

            const noHA = filteredData.filter(d => !d.hasHA && (d.siteType === 'PDC' || d.siteType === 'BDC')).length;
            if (noHA > 0) {
                md += `3. **Configure HA for ${noHA} critical site devices** - Eliminate single points of failure\n`;
            }
            md += '\n';

            md += '### Strategic Improvements\n\n';
            md += '- Implement automated compliance monitoring\n';
            md += '- Develop hardware refresh schedule for aging devices\n';
            md += '- Standardize configuration templates across regions\n';
            md += '- Establish vendor diversity strategy\n\n';

            // Footer
            md += '---\n\n';
            md += '*Generated by NetAssets™ Premium - Enterprise Network Management Solution*\n';
            md += `*Report Date: ${now.toISOString()}*\n`;
            md += '*Classification: Confidential*\n';

            const blob = new Blob([md], { type: 'text/markdown' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `NetAssets_Premium_Report_${now.toISOString().split('T')[0]}.md`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification(`✅ Exported ${filteredData.length} devices to Premium Markdown with full assessment`);
            document.getElementById('exportDropdown').classList.remove('show');
        }

        // Export to Formatted Text - Premium NOC Operations Report
        function exportToFormattedText() {
            const now = new Date();

            // Calculate assessment statistics
            const assessmentData = filteredData.map(device => ({
                device: device,
                health: calculateDeviceHealth(device),
                risk: calculateRiskScore(device),
                compliance: calculateComplianceScore(device)
            }));

            const avgHealth = (assessmentData.reduce((sum, a) => sum + a.health.score, 0) / assessmentData.length).toFixed(1);
            const criticalRisks = assessmentData.filter(a => a.risk.level === 'Critical').length;
            const haDevices = filteredData.filter(d => d.hasHA).length;
            const haCoverage = ((haDevices / filteredData.length) * 100).toFixed(1);

            let text = '╔═══════════════════════════════════════════════════════════════════════════════╗\n';
            text += '║            NETASSETS™ PREMIUM - NETWORK OPERATIONS CENTER REPORT             ║\n';
            text += '╚═══════════════════════════════════════════════════════════════════════════════╝\n\n';

            text += `┌─ REPORT INFORMATION ──────────────────────────────────────────────────────────┐\n`;
            text += `│  Generated: ${now.toLocaleString().padEnd(64)} │\n`;
            text += `│  System: NetAssets Premium v2.0                                               │\n`;
            text += `│  Classification: CONFIDENTIAL                                                 │\n`;
            text += `└────────────────────────────────────────────────────────────────────────────────┘\n\n`;

            // Executive Summary Section
            text += '┌─ EXECUTIVE SUMMARY ────────────────────────────────────────────────────────────┐\n';
            text += `│  Total Devices:        ${String(filteredData.length).padEnd(55)} │\n`;
            text += `│  Average Health:       ${(avgHealth + '/100').padEnd(55)} │\n`;
            text += `│  HA Coverage:          ${(haCoverage + '%').padEnd(55)} │\n`;
            text += `│  Critical Risks:       ${String(criticalRisks).padEnd(55)} │\n`;
            text += '└────────────────────────────────────────────────────────────────────────────────┘\n\n';

            // Health Grade Distribution
            text += '┌─ HEALTH ASSESSMENT DISTRIBUTION ───────────────────────────────────────────────┐\n';
            ['A', 'B', 'C', 'D', 'F'].forEach(grade => {
                const count = assessmentData.filter(a => a.health.grade === grade).length;
                const percentage = ((count / assessmentData.length) * 100).toFixed(1);
                if (count > 0) {
                    const bar = '█'.repeat(Math.floor(percentage / 2)) + '░'.repeat(50 - Math.floor(percentage / 2));
                    const gradeLineText = `Grade ${grade}: [${bar}] ${String(count).padStart(3)} (${percentage}%)`;
                    text += `│  ${gradeLineText}`.padEnd(81) + '│\n';
                }
            });
            text += '└────────────────────────────────────────────────────────────────────────────────┘\n\n';

            // Critical Risk Devices Alert
            if (criticalRisks > 0) {
                text += '╔═══════════════════════════════════════════════════════════════════════════════╗\n';
                text += '║  ⚠️  CRITICAL RISK ALERT - IMMEDIATE ATTENTION REQUIRED                       ║\n';
                text += '╠═══════════════════════════════════════════════════════════════════════════════╣\n';

                assessmentData
                    .filter(a => a.risk.level === 'Critical')
                    .slice(0, 5)
                    .forEach((a, idx) => {
                        const deviceName = a.device.deviceName.padEnd(25);
                        const healthScore = String(a.health.score).padStart(3);
                        const riskType = a.risk.factors[0]?.type || 'Multiple risks';
                        const criticalDeviceText = `[${idx + 1}] ${deviceName} │ Health: ${healthScore}/100 │ ${riskType}`;
                        text += `║  ${criticalDeviceText}`.padEnd(81) + '║\n';
                    });
                text += '╚═══════════════════════════════════════════════════════════════════════════════╝\n\n';
            }

            // Device Inventory by Region
            const regionGroups = {};
            assessmentData.forEach(({ device, health, risk, compliance }) => {
                const region = device.region || 'Unknown';
                if (!regionGroups[region]) regionGroups[region] = [];
                regionGroups[region].push({ device, health, risk, compliance });
            });

            Object.keys(regionGroups).sort().forEach(region => {
                const regionDevices = regionGroups[region];
                const regionHealth = (regionDevices.reduce((sum, d) => sum + d.health.score, 0) / regionDevices.length).toFixed(1);

                text += `\n╔══════════════════════════════════════════════════════════════════════════════╗\n`;
                text += `║  REGION: ${region.padEnd(30)} │ Devices: ${String(regionDevices.length).padStart(3)} │ Avg Health: ${regionHealth.padStart(5)}/100  ║\n`;
                text += `╚══════════════════════════════════════════════════════════════════════════════╝\n\n`;

                regionDevices.forEach((data, idx) => {
                    const { device, health, risk, compliance } = data;
                    const vendor = detectVendorFromCSV(device);
                    const deviceType = detectDeviceTypeFromCSV(device);

                    text += `┌─[${String(idx + 1).padStart(3)}]─ ${device.deviceName} ${'─'.repeat(Math.max(0, 56 - device.deviceName.length))}┐\n`;
                    text += `│  Vendor/Type:       ${vendor} / ${deviceType}`.padEnd(81) + '│\n';
                    text += `│  Model:             ${(device.model || 'Unknown').padEnd(57)} │\n`;
                    text += `│  Serial Number:     ${(device.sn || 'N/A').padEnd(57)} │\n`;
                    text += `│  Site/Role:         ${device.siteType || 'Other'} / ${device.deviceRole || 'General'}`.padEnd(81) + '│\n';
                    const haStatusText = device.hasHA ? '✅ HA Configured' : '⚠️  Standalone';
                    text += `│  HA Status:         ${haStatusText}`.padEnd(81) + '│\n';

                    if (device.sn_ha1) {
                        text += `│  HA Serial 1:       ${device.sn_ha1.padEnd(57)} │\n`;
                    }
                    if (device.sn_ha2) {
                        text += `│  HA Serial 2:       ${device.sn_ha2.padEnd(57)} │\n`;
                    }

                    // Assessment Summary
                    text += '│' + '─'.repeat(79) + '│\n';
                    const assessmentText = `Health: ${health.grade} (${String(health.score).padStart(3)}/100) | Risk: ${risk.level.padEnd(8)} | Compliance: ${String(compliance.score).padStart(3)}%`;
                    text += `│  ASSESSMENT:        ${assessmentText}`.padEnd(81) + '│\n';

                    // Recommendations if critical
                    if (risk.level === 'Critical' || health.grade === 'F') {
                        const actionText = health.recommendations[0] || 'Review required';
                        text += `│  ⚠️ ACTION:          ${actionText.padEnd(55)} │\n`;
                    }

                    text += '└' + '─'.repeat(79) + '┘\n\n';
                });
            });

            // Summary Statistics
            text += '\n╔═══════════════════════════════════════════════════════════════════════════════╗\n';
            text += '║                            INFRASTRUCTURE SUMMARY                             ║\n';
            text += '╠═══════════════════════════════════════════════════════════════════════════════╣\n';

            // Vendor Distribution
            const vendorCounts = {};
            filteredData.forEach(device => {
                const vendor = detectVendorFromCSV(device);
                vendorCounts[vendor] = (vendorCounts[vendor] || 0) + 1;
            });

            text += '║  VENDOR DISTRIBUTION:                                                         ║\n';
            Object.entries(vendorCounts)
                .sort((a, b) => b[1] - a[1])
                .forEach(([vendor, count]) => {
                    const percentage = ((count / filteredData.length) * 100).toFixed(1);
                    const vendorPadded = vendor.padEnd(20);
                    const countPadded = String(count).padStart(4);
                    const vendorLineText = `• ${vendorPadded} ${countPadded} devices (${percentage}%)`;
                    text += `║    ${vendorLineText}`.padEnd(79) + '║\n';
                });

            text += '╠═══════════════════════════════════════════════════════════════════════════════╣\n';
            text += '║  RECOMMENDATIONS:                                                             ║\n';

            if (criticalRisks > 0) {
                text += `║    1. Address ${criticalRisks} critical risk devices immediately`.padEnd(81) + '║\n';
            }
            if (haDevices < filteredData.length * 0.8) {
                text += '║    2. Increase HA coverage to 80% or higher for resilience'.padEnd(81) + '║\n';
            }
            if (avgHealth < 80) {
                text += '║    3. Implement device refresh program to improve health scores'.padEnd(81) + '║\n';
            }

            text += '╚═══════════════════════════════════════════════════════════════════════════════╝\n\n';

            text += '─'.repeat(82) + '\n';
            text += `Generated by NetAssets™ Premium | ${now.toISOString()} | END OF REPORT\n`;
            text += '─'.repeat(82) + '\n';

            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `NetAssets_NOC_Report_${now.toISOString().split('T')[0]}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification(`✅ Exported ${filteredData.length} devices to Premium NOC Operations Report`);
            document.getElementById('exportDropdown').classList.remove('show');
        }

        // PROFESSIONAL NOC TECHNICAL REPORT - OPERATIONS-GRADE WITH FULL VALIDATION
        function exportToExcelNOC() {
            // Validate data first
            if (!filteredData || filteredData.length === 0) {
                showNotification('⚠️ No data available for NOC report', 'error');
                return;
            }

            const now = new Date();
            const timestamp = now.toLocaleString();
            const date = now.toISOString().split('T')[0];
            const reportId = `NOC-${Math.random().toString(36).substr(2, 9).toUpperCase()}`;

            // Initialize statistics with proper validation
            const totalDevices = filteredData.length;
            const vendorStats = {};
            const typeStats = {};
            const siteStats = {};
            const regionStats = {};
            const roleStats = {};

            // Calculate assessment metrics with error handling
            let totalHealthScore = 0;
            let criticalRiskCount = 0;
            let nonCompliantCount = 0;
            let healthGrades = { A: 0, B: 0, C: 0, D: 0, F: 0, 'N/A': 0 };
            let riskLevels = { Critical: 0, High: 0, Medium: 0, Low: 0, Minimal: 0, Unknown: 0 };

            // Process devices with comprehensive error handling
            const processedDevices = filteredData.map(device => {
                try {
                    // Get vendor with proper detection
                    const vendor = device.vendor || detectVendorFromCSV(device) || 'Unknown';
                    const deviceType = device.deviceType || device.type || detectDeviceTypeFromCSV(device) || 'Unknown';

                    // Update statistics
                    vendorStats[vendor] = (vendorStats[vendor] || 0) + 1;
                    typeStats[deviceType] = (typeStats[deviceType] || 0) + 1;
                    siteStats[device.siteType || 'Other'] = (siteStats[device.siteType || 'Other'] || 0) + 1;
                    regionStats[device.region || 'Unknown'] = (regionStats[device.region || 'Unknown'] || 0) + 1;
                    roleStats[device.deviceRole || device.role || 'General'] = (roleStats[device.deviceRole || device.role || 'General'] || 0) + 1;

                    // Calculate assessment metrics safely
                    const health = calculateDeviceHealth(device) || { score: 0, grade: 'N/A' };
                    const risk = calculateRiskScore(device) || { score: 0, level: 'Unknown' };
                    const compliance = calculateComplianceScore(device) || { score: 0, status: 'Unknown' };

                    totalHealthScore += health.score;
                    healthGrades[health.grade] = (healthGrades[health.grade] || 0) + 1;
                    riskLevels[risk.level] = (riskLevels[risk.level] || 0) + 1;

                    if (risk.level === 'Critical') criticalRiskCount++;
                    if (compliance.status === 'Non-Compliant') nonCompliantCount++;

                    return {
                        device: device,
                        vendor: vendor,
                        deviceType: deviceType,
                        health: health,
                        risk: risk,
                        compliance: compliance
                    };
                } catch (err) {
                    console.error(`Error processing device ${device.deviceName}:`, err);
                    return {
                        device: device,
                        vendor: 'Unknown',
                        deviceType: 'Unknown',
                        health: { score: 0, grade: 'N/A' },
                        risk: { score: 0, level: 'Unknown' },
                        compliance: { score: 0, status: 'Unknown' }
                    };
                }
            });

            // Calculate accurate statistics
            const haDevices = filteredData.filter(d => d.haStatus && d.haStatus !== 'standalone').length;
            const avgHealthScore = totalDevices > 0 ? (totalHealthScore / totalDevices).toFixed(1) : 0;
            const complianceRate = totalDevices > 0 ? (((totalDevices - nonCompliantCount) / totalDevices) * 100).toFixed(1) : 0;
            const dataCenters = filteredData.filter(d => d.siteType && ['PDC', 'BDC', 'DC'].includes(d.siteType)).length;
            const missingSerials = filteredData.filter(d => !d.sn || d.sn === 'N/A').length;
            const missingIPs = filteredData.filter(d => !d.ipAddress || d.ipAddress === 'Not Configured').length;

            // Generate professional NOC technical report
            let html = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOC Technical Operations Report - ${reportId}</title>
    <style>
        @page { size: landscape; margin: 10mm; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 11pt;
            line-height: 1.4;
            color: #1a1a1a;
            background: #f0f0f0;
            padding: 10px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2c3e50 100%);
            color: #00ff00;
            padding: 25px;
            border-bottom: 3px solid #00ff00;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 100%;
            background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,255,0,0.1) 10px, rgba(0,255,0,0.1) 20px);
        }
        .header h1 {
            margin: 0;
            font-size: 24pt;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0,255,0,0.5);
        }
        .header .subtitle {
            margin: 8px 0;
            font-size: 11pt;
            opacity: 0.9;
            font-family: monospace;
        }
        .header .report-id {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 10pt;
            background: rgba(0,255,0,0.2);
            padding: 5px 10px;
            border: 1px solid #00ff00;
            border-radius: 3px;
        }
        .alert-box {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: white;
            padding: 20px;
            margin: 20px;
            border: 2px solid #ff0000;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(255,0,0,0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }
        .alert-box h3 {
            margin: 0 0 10px 0;
            font-size: 16pt;
            text-transform: uppercase;
        }
        .stats-container {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-box.critical {
            border-color: #ff0000;
            background: #fff5f5;
        }
        .stat-box.warning {
            border-color: #ff9800;
            background: #fff8e1;
        }
        .stat-box.success {
            border-color: #00c853;
            background: #f1f8e9;
        }
        .stat-label {
            font-size: 10pt;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 22pt;
            font-weight: bold;
            color: #1a1a1a;
        }
        .stat-detail {
            font-size: 9pt;
            color: #999;
            margin-top: 5px;
        }
        .metrics-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
            background: white;
        }
        .metrics-table td {
            padding: 10px;
            border: 1px solid #ddd;
            font-size: 10pt;
        }
        .metrics-table .label {
            font-weight: bold;
            background: #f0f0f0;
            width: 30%;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
            margin: 20px 0;
        }
        .data-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid #1a252f;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-table td {
            padding: 8px;
            border: 1px solid #ddd;
            background: white;
        }
        .data-table tr:nth-child(even) td {
            background: #f8f9fa;
        }
        .data-table tr:hover td {
            background: #e3f2fd;
        }
        .ha-active {
            background: #c8e6c9;
            color: #1b5e20;
            font-weight: bold;
            text-align: center;
        }
        .ha-standalone {
            background: #fff3e0;
            color: #e65100;
            text-align: center;
        }
        .health-a { background: #4caf50; color: white; }
        .health-b { background: #8bc34a; color: white; }
        .health-c { background: #ffc107; color: #333; }
        .health-d { background: #ff9800; color: white; }
        .health-f { background: #f44336; color: white; }
        .risk-critical { background: #b71c1c; color: white; }
        .risk-high { background: #ff6f00; color: white; }
        .risk-medium { background: #ffd600; color: #333; }
        .risk-low { background: #64b5f6; color: white; }
        .risk-minimal { background: #81c784; color: white; }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 9pt;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        code {
            background: #263238;
            color: #00ff00;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', monospace;
            font-size: 9pt;
        }
        .footer {
            background: #1a1a1a;
            color: #888;
            padding: 20px;
            text-align: center;
            font-size: 9pt;
            border-top: 3px solid #00ff00;
        }
        .footer strong {
            color: #00ff00;
        }
        .quality-bar {
            width: 100%;
            height: 15px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }
        .quality-fill {
            height: 100%;
            background: linear-gradient(90deg, #00c853 0%, #00ff00 100%);
        }
        @media print {
            body { background: white; }
            .container { box-shadow: none; }
            .header { background: #1a1a1a !important; -webkit-print-color-adjust: exact; }
            .data-table th { background: #2c3e50 !important; -webkit-print-color-adjust: exact; }
            .alert-box { animation: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="report-id">Report ID: ${reportId}</div>
            <h1>🔧 NOC TECHNICAL OPERATIONS REPORT</h1>
            <div class="subtitle">Generated: ${timestamp} | Format: Technical Operations</div>
            <div class="subtitle">Total Infrastructure: ${totalDevices} Devices | ${Object.keys(vendorStats).length} Vendors | ${Object.keys(regionStats).length} Regions</div>
        </div>

        ${criticalRiskCount > 0 ? `
        <div class="alert-box">
            <h3>⚠️ CRITICAL INFRASTRUCTURE ALERT</h3>
            <p><strong>${criticalRiskCount}</strong> devices in CRITICAL state requiring IMMEDIATE intervention</p>
            <p>Priority action required for infrastructure stability and security compliance</p>
        </div>` : ''}

        <div class="stats-container">
            <div class="stats-grid">
                <div class="stat-box ${avgHealthScore >= 80 ? 'success' : avgHealthScore >= 60 ? 'warning' : 'critical'}">
                    <div class="stat-label">Infrastructure Health</div>
                    <div class="stat-value">${avgHealthScore}%</div>
                    <div class="stat-detail">Average across all devices</div>
                </div>
                <div class="stat-box ${haDevices >= totalDevices * 0.8 ? 'success' : haDevices >= totalDevices * 0.5 ? 'warning' : 'critical'}">
                    <div class="stat-label">HA Coverage</div>
                    <div class="stat-value">${Math.round((haDevices/totalDevices)*100)}%</div>
                    <div class="stat-detail">${haDevices}/${totalDevices} devices</div>
                </div>
                <div class="stat-box ${complianceRate >= 90 ? 'success' : complianceRate >= 70 ? 'warning' : 'critical'}">
                    <div class="stat-label">Compliance Rate</div>
                    <div class="stat-value">${complianceRate}%</div>
                    <div class="stat-detail">${totalDevices - nonCompliantCount} compliant</div>
                </div>
                <div class="stat-box ${criticalRiskCount === 0 ? 'success' : criticalRiskCount <= 5 ? 'warning' : 'critical'}">
                    <div class="stat-label">Critical Risk</div>
                    <div class="stat-value">${criticalRiskCount}</div>
                    <div class="stat-detail">Devices at critical risk</div>
                </div>
            </div>

            <table class="metrics-table">
                <tr>
                    <td class="label">Health Grade Distribution:</td>
                    <td>${Object.entries(healthGrades).filter(([g,c]) => c > 0).map(([g, c]) => `<span class="badge health-${g.toLowerCase()}">${g}: ${c}</span>`).join(' ')}</td>
                </tr>
                <tr>
                    <td class="label">Risk Level Distribution:</td>
                    <td>${Object.entries(riskLevels).filter(([l,c]) => c > 0).map(([l, c]) => `<span class="badge risk-${l.toLowerCase()}">${l}: ${c}</span>`).join(' ')}</td>
                </tr>
                <tr>
                    <td class="label">Vendor Distribution:</td>
                    <td>${Object.entries(vendorStats).sort((a,b) => b[1] - a[1]).map(([v, c]) => `<strong>${v}:</strong> ${c}`).join(' | ')}</td>
                </tr>
                <tr>
                    <td class="label">Regional Distribution:</td>
                    <td>${Object.entries(regionStats).sort((a,b) => b[1] - a[1]).map(([r, c]) => `<strong>${r}:</strong> ${c}`).join(' | ')}</td>
                </tr>
                <tr>
                    <td class="label">Site Type Distribution:</td>
                    <td>${Object.entries(siteStats).sort((a,b) => b[1] - a[1]).map(([s, c]) => `<strong>${s}:</strong> ${c}`).join(' | ')}</td>
                </tr>
                <tr>
                    <td class="label">Device Role Distribution:</td>
                    <td>${Object.entries(roleStats).sort((a,b) => b[1] - a[1]).slice(0, 5).map(([r, c]) => `<strong>${r}:</strong> ${c}`).join(' | ')}</td>
                </tr>
                <tr>
                    <td class="label">Data Quality Metrics:</td>
                    <td>
                        Serial Coverage: <strong>${Math.round(((totalDevices - missingSerials) / totalDevices) * 100)}%</strong> |
                        IP Coverage: <strong>${Math.round(((totalDevices - missingIPs) / totalDevices) * 100)}%</strong> |
                        Data Centers: <strong>${dataCenters}</strong>
                    </td>
                </tr>
            </table>
        </div>

        <div style="padding: 0 20px;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">#</th>
                        <th style="width: 60px;">Region</th>
                        <th>Device Name</th>
                        <th>IP Address</th>
                        <th>Vendor</th>
                        <th>Type</th>
                        <th>Model</th>
                        <th>Site</th>
                        <th>Role</th>
                        <th>Serial Number</th>
                        <th>HA Status</th>
                        <th style="width: 80px;">Health</th>
                        <th style="width: 80px;">Risk</th>
                        <th style="width: 80px;">Compliance</th>
                    </tr>
                </thead>
                <tbody>`;

            // Generate table rows with accurate data
            processedDevices.forEach((item, index) => {
                const device = item.device;
                const vendorClass = `vendor-${item.vendor.toLowerCase().replace(/\s+/g, '')}`;
                const haClass = device.haStatus && device.haStatus !== 'standalone' ? 'ha-active' : 'ha-standalone';
                const haText = device.haStatus && device.haStatus !== 'standalone' ? device.haStatus.toUpperCase() : 'STANDALONE';

                // Location handling
                const location = device.location || device.site ||
                                [device.city, device.state].filter(Boolean).join(', ') ||
                                device.country || '-';

                // Color coding for metrics
                const healthClass = `health-${item.health.grade.toLowerCase()}`;
                const riskClass = `risk-${item.risk.level.toLowerCase().replace(/\s+/g, '')}`;
                const complianceColor = item.compliance.status === 'Compliant' ? '#00c853' :
                                       item.compliance.status === 'Non-Compliant' ? '#ff0000' : '#ff9800';

                html += `
                <tr>
                    <td style="text-align: center;">${index + 1}</td>
                    <td style="text-align: center;"><strong>${device.region || 'N/A'}</strong></td>
                    <td><strong style="color: #1a1a1a;">${device.deviceName}</strong></td>
                    <td><code>${device.ipAddress || 'Not Configured'}</code></td>
                    <td class="${vendorClass}">${item.vendor}</td>
                    <td>${item.deviceType}</td>
                    <td>${device.model || device.series || 'Unknown'}</td>
                    <td>${device.siteType || 'Other'}</td>
                    <td>${device.deviceRole || device.role || 'General'}</td>
                    <td><code>${device.sn || device.serialNumber || 'N/A'}</code></td>
                    <td class="${haClass}">${haText}</td>
                    <td style="text-align: center;">
                        <span class="badge ${healthClass}">${item.health.grade} (${item.health.score})</span>
                    </td>
                    <td style="text-align: center;">
                        <span class="badge ${riskClass}">${item.risk.level}</span>
                    </td>
                    <td style="text-align: center; font-weight: bold; color: ${complianceColor}">
                        ${item.compliance.score}%
                    </td>
                </tr>`;
            });

            html += `
                </tbody>
            </table>
        </div>

        <div style="padding: 20px;">
            <h3 style="color: #1a1a1a; margin-bottom: 10px;">NOC OPERATIONAL NOTES</h3>
            <div style="background: #f0f0f0; padding: 15px; border-left: 4px solid #00ff00; font-family: monospace; font-size: 10pt;">
                <p><strong>PRIORITY ACTIONS:</strong></p>
                <ul style="margin: 10px 0 10px 20px;">
                    ${criticalRiskCount > 0 ? `<li>Address ${criticalRiskCount} critical risk devices immediately</li>` : ''}
                    ${nonCompliantCount > 0 ? `<li>Resolve ${nonCompliantCount} compliance violations</li>` : ''}
                    ${missingSerials > totalDevices * 0.2 ? `<li>Update ${missingSerials} missing serial numbers</li>` : ''}
                    ${haDevices < totalDevices * 0.5 ? `<li>Improve HA coverage (currently ${Math.round((haDevices/totalDevices)*100)}%)</li>` : ''}
                    ${avgHealthScore < 70 ? `<li>Infrastructure health below threshold (${avgHealthScore}%)</li>` : ''}
                </ul>
                <p style="margin-top: 10px;"><strong>DATA QUALITY:</strong></p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                    <div>
                        Serial Number Coverage: ${Math.round(((totalDevices - missingSerials) / totalDevices) * 100)}%
                        <div class="quality-bar">
                            <div class="quality-fill" style="width: ${((totalDevices - missingSerials) / totalDevices) * 100}%"></div>
                        </div>
                    </div>
                    <div>
                        IP Address Coverage: ${Math.round(((totalDevices - missingIPs) / totalDevices) * 100)}%
                        <div class="quality-bar">
                            <div class="quality-fill" style="width: ${((totalDevices - missingIPs) / totalDevices) * 100}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <strong>NetAssets NOC Management System v2.1</strong><br>
            Technical Operations Report Generated: ${timestamp}<br>
            Report ID: ${reportId} | Total Records: ${totalDevices} | Processing Time: ${Date.now() - now.getTime()}ms<br>
            <span style="color: #ff0000;">CONFIDENTIAL - FOR NOC USE ONLY</span>
        </div>
    </div>
</body>
</html>`;

            // Create download with proper encoding
            const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `NetAssets_NOC_Technical_${date}_${reportId}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            // Log export for audit trail
            console.log('NOC Technical Export:', {
                timestamp: now.toISOString(),
                reportId: reportId,
                devices: totalDevices,
                criticalDevices: criticalRiskCount,
                avgHealth: avgHealthScore,
                haConverage: `${Math.round((haDevices/totalDevices)*100)}%`,
                compliance: `${complianceRate}%`,
                dataQuality: {
                    serialCoverage: `${Math.round(((totalDevices - missingSerials) / totalDevices) * 100)}%`,
                    ipCoverage: `${Math.round(((totalDevices - missingIPs) / totalDevices) * 100)}%`
                }
            });

            showNotification(`✅ NOC Technical Report generated for ${totalDevices} devices (ID: ${reportId})`, 'success');
            document.getElementById('exportDropdown').classList.remove('show');
        }

        // Export to Excel - Corporate Aesthetic Template with Premium Assessment
        function exportToExcelCorporate() {
            const now = new Date();
            const timestamp = now.toLocaleString();
            const date = now.toISOString().split('T')[0];

            // Calculate enhanced statistics with assessments
            const totalDevices = filteredData.length;
            const haDevices = filteredData.filter(d => d.hasHA).length;
            const haCoverage = ((haDevices/totalDevices)*100).toFixed(1);

            // Calculate assessment metrics
            let totalHealthScore = 0;
            let criticalRiskDevices = 0;
            let nonCompliantDevices = 0;
            let healthGrades = { A: 0, B: 0, C: 0, D: 0, F: 0 };
            let riskLevels = { Critical: 0, High: 0, Medium: 0, Low: 0, Minimal: 0 };

            filteredData.forEach(device => {
                const health = calculateDeviceHealth(device);
                const risk = calculateRiskScore(device);
                const compliance = calculateComplianceScore(device);

                totalHealthScore += health.score;
                healthGrades[health.grade]++;
                riskLevels[risk.level]++;

                if (risk.level === 'Critical') criticalRiskDevices++;
                if (compliance.status === 'Non-Compliant') nonCompliantDevices++;
            });

            const avgHealthScore = totalDevices > 0 ? (totalHealthScore / totalDevices).toFixed(1) : 0;
            const complianceRate = totalDevices > 0 ? (((totalDevices - nonCompliantDevices) / totalDevices) * 100).toFixed(1) : 0;

            let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Network Infrastructure Asset Report</title>
    <style>
        @page { margin: 0.75in; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 10pt;
            color: #333;
            line-height: 1.4;
        }
        .header-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            margin: -10px -10px 30px -10px;
            border-radius: 0 0 15px 15px;
        }
        .header-banner h1 {
            margin: 0 0 10px 0;
            font-size: 24pt;
            font-weight: 300;
            letter-spacing: 1px;
        }
        .header-banner .tagline {
            font-size: 11pt;
            opacity: 0.95;
            font-weight: 300;
        }
        .executive-summary {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        .executive-summary h2 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 14pt;
            font-weight: 600;
        }
        .kpi-grid {
            display: table;
            width: 100%;
            margin-top: 15px;
        }
        .kpi-item {
            display: table-cell;
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin: 0 10px;
        }
        .kpi-value {
            font-size: 28pt;
            font-weight: 700;
            color: #667eea;
            line-height: 1;
        }
        .kpi-label {
            font-size: 9pt;
            color: #6c757d;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 9.5pt;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 9pt;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-right: 1px solid rgba(255,255,255,0.2);
        }
        th:last-child { border-right: none; }
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
        }
        tbody tr:nth-child(even) {
            background: #f8f9fa;
        }
        tbody tr:hover {
            background: #e7f1ff;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 8pt;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-ha {
            background: #d4edda;
            color: #155724;
        }
        .status-standalone {
            background: #fff3cd;
            color: #856404;
        }
        .vendor-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 8.5pt;
            font-weight: 500;
        }
        .vendor-cisco { background: #cfe2ff; color: #004085; }
        .vendor-fortinet { background: #f8d7da; color: #721c24; }
        .vendor-juniper { background: #d1e7dd; color: #0f5132; }
        .vendor-paloalto { background: #fff3cd; color: #856404; }
        .vendor-a10 { background: #d1ecf1; color: #0c5460; }
        .vendor-apc { background: #e2e3e5; color: #383d41; }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            text-align: center;
            font-size: 8.5pt;
            color: #6c757d;
        }
        .footer-logo {
            font-size: 11pt;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="header-banner">
        <h1>📊 Network Infrastructure Asset Report</h1>
        <div class="tagline">Comprehensive Overview of Network Assets & High Availability Status</div>
    </div>

    <div class="executive-summary">
        <h2>Executive Summary</h2>
        <div style="margin-bottom: 15px; color: #495057;">
            This premium assessment report provides a comprehensive analysis of network infrastructure assets
            with health scoring, risk assessment, and compliance evaluation across all regions.
        </div>
        <div class="kpi-grid">
            <div class="kpi-item">
                <div class="kpi-value">${totalDevices}</div>
                <div class="kpi-label">Total Assets</div>
            </div>
            <div class="kpi-item" style="margin: 0 10px;">
                <div class="kpi-value">${avgHealthScore}</div>
                <div class="kpi-label">Avg Health Score</div>
            </div>
            <div class="kpi-item">
                <div class="kpi-value">${haCoverage}%</div>
                <div class="kpi-label">HA Coverage</div>
            </div>
            <div class="kpi-item" style="margin: 0 10px;">
                <div class="kpi-value">${complianceRate}%</div>
                <div class="kpi-label">Compliance Rate</div>
            </div>
        </div>
    </div>

    <div class="assessment-summary" style="background: #fff3cd; border-left: 4px solid #f59e0b; padding: 20px; margin-bottom: 30px; border-radius: 5px;">
        <h2 style="margin: 0 0 15px 0; color: #f59e0b; font-size: 14pt; font-weight: 600;">Risk & Health Assessment</h2>
        <div style="display: table; width: 100%;">
            <div style="display: table-cell; width: 50%;">
                <strong>Health Grade Distribution:</strong><br>
                ${Object.entries(healthGrades).map(([grade, count]) =>
                    count > 0 ? `Grade ${grade}: ${count} devices (${((count/totalDevices)*100).toFixed(1)}%)<br>` : ''
                ).join('')}
            </div>
            <div style="display: table-cell; width: 50%;">
                <strong>Risk Level Distribution:</strong><br>
                ${Object.entries(riskLevels).map(([level, count]) =>
                    count > 0 ? `${level}: ${count} devices (${((count/totalDevices)*100).toFixed(1)}%)<br>` : ''
                ).join('')}
                ${criticalRiskDevices > 0 ? `<span style="color: #dc3545; font-weight: bold;">⚠️ ${criticalRiskDevices} devices require immediate attention</span>` : ''}
            </div>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 3%;">#</th>
                <th style="width: 6%;">Region</th>
                <th style="width: 12%;">Device Name</th>
                <th style="width: 8%;">Vendor</th>
                <th style="width: 8%;">Type</th>
                <th style="width: 10%;">Model</th>
                <th style="width: 6%;">Site</th>
                <th style="width: 8%;">Role</th>
                <th style="width: 10%;">Serial Number</th>
                <th style="width: 9%;">HA Status</th>
                <th style="width: 7%;">Health</th>
                <th style="width: 7%;">Risk</th>
                <th style="width: 6%;">Compliance</th>
            </tr>
        </thead>
        <tbody>`;

            filteredData.forEach((device, index) => {
                const vendor = detectVendorFromCSV(device);
                const deviceType = detectDeviceTypeFromCSV(device);
                const vendorClass = `vendor-${vendor.toLowerCase().replace(/\s+/g, '')}`;
                const statusClass = device.hasHA ? 'status-ha' : 'status-standalone';
                const statusText = device.hasHA ? '✓ HA' : 'Solo';

                // Calculate assessments for each device
                const health = calculateDeviceHealth(device);
                const risk = calculateRiskScore(device);
                const compliance = calculateComplianceScore(device);

                // Define color styles for health grades
                const gradeColors = {
                    'A': '#28a745',
                    'B': '#17a2b8',
                    'C': '#ffc107',
                    'D': '#fd7e14',
                    'F': '#dc3545'
                };

                // Define color styles for risk levels
                const riskColors = {
                    'Critical': '#dc3545',
                    'High': '#fd7e14',
                    'Medium': '#ffc107',
                    'Low': '#17a2b8',
                    'Minimal': '#28a745'
                };

                html += `
            <tr>
                <td style="color: #6c757d; font-weight: 600;">${index + 1}</td>
                <td style="font-weight: 500;">${device.region || 'Unknown'}</td>
                <td style="font-weight: 600; color: #212529;">${device.deviceName}</td>
                <td><span class="vendor-badge ${vendorClass}">${vendor}</span></td>
                <td style="color: #495057;">${deviceType}</td>
                <td style="font-family: 'Courier New', monospace; font-size: 8.5pt;">${device.model || 'Unknown'}</td>
                <td style="color: #6c757d;">${device.siteType || 'Other'}</td>
                <td style="color: #495057; font-size: 8.5pt;">${device.deviceRole || 'General'}</td>
                <td style="font-family: 'Courier New', monospace; font-size: 8pt; color: #495057;">${device.sn || 'N/A'}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td style="text-align: center; font-weight: bold; color: ${gradeColors[health.grade]};">${health.grade} (${health.score})</td>
                <td style="text-align: center; font-weight: bold; color: ${riskColors[risk.level]};">${risk.level}</td>
                <td style="text-align: center; font-weight: bold; color: ${compliance.score >= 80 ? '#28a745' : compliance.score >= 60 ? '#ffc107' : '#dc3545'};">${compliance.score}%</td>
            </tr>`;
            });

            html += `
        </tbody>
    </table>

    <div class="footer">
        <div class="footer-logo">NetAssets™ Inventory Management</div>
        <div>Report Generated: ${timestamp} • Document Classification: Confidential</div>
        <div style="margin-top: 5px;">© ${now.getFullYear()} Network Operations • All Rights Reserved</div>
    </div>
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `NetAssets_Executive_Report_${date}.html`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification(`✅ Exported ${filteredData.length} devices to Executive Report`);
            document.getElementById('exportDropdown').classList.remove('show');
        }

        // Export Network Infrastructure Asset Report - Editable Excel Format with Hierarchy
        function exportInfrastructureAssetExcel() {
            // Validate data first
            if (!filteredData || filteredData.length === 0) {
                showNotification('⚠️ No data available for export', 'error');
                return;
            }

            const now = new Date();
            const timestamp = now.toLocaleString();
            const date = now.toISOString().split('T')[0];

            // 🔗 Build parent-child relationships for HA devices
            const deviceMap = new Map();
            const childDevices = new Set();

            // First pass: index all devices by serial number
            filteredData.forEach(device => {
                if (device.sn) {
                    deviceMap.set(device.sn.toLowerCase().trim(), device);
                }
            });

            // Second pass: identify child devices (HA secondaries)
            filteredData.forEach(device => {
                if (device.hasHA) {
                    // Mark HA serials as children if they exist as separate devices
                    if (device.sn_ha1) {
                        const haSerial = device.sn_ha1.toLowerCase().trim();
                        if (deviceMap.has(haSerial)) {
                            childDevices.add(haSerial);
                        }
                    }
                    if (device.sn_ha2) {
                        const haSerial = device.sn_ha2.toLowerCase().trim();
                        if (deviceMap.has(haSerial)) {
                            childDevices.add(haSerial);
                        }
                    }
                }
            });

            // Organize devices: parents first, then their children
            const organizedDevices = [];
            const processedSerials = new Set();

            filteredData.forEach((device, idx) => {
                const deviceSerial = device.sn ? device.sn.toLowerCase().trim() : '';

                // Create unique identifier: use serial if available, otherwise use device name + index
                const uniqueId = deviceSerial || `${device.deviceName || 'unknown'}_${idx}`;

                // Skip if already processed or if it's a child device (will be added with parent)
                // Only check childDevices if we have a valid serial number
                if (processedSerials.has(uniqueId) || (deviceSerial && childDevices.has(deviceSerial))) {
                    return;
                }

                // Add parent device
                organizedDevices.push({
                    device: device,
                    isChild: false,
                    parentDevice: null
                });
                processedSerials.add(uniqueId);

                // Add child devices if HA configured
                if (device.hasHA) {
                    if (device.sn_ha1) {
                        const ha1Serial = device.sn_ha1.toLowerCase().trim();
                        if (deviceMap.has(ha1Serial) && !processedSerials.has(ha1Serial)) {
                            organizedDevices.push({
                                device: deviceMap.get(ha1Serial),
                                isChild: true,
                                parentDevice: device.deviceName
                            });
                            processedSerials.add(ha1Serial);
                        }
                    }
                    if (device.sn_ha2) {
                        const ha2Serial = device.sn_ha2.toLowerCase().trim();
                        if (deviceMap.has(ha2Serial) && !processedSerials.has(ha2Serial)) {
                            organizedDevices.push({
                                device: deviceMap.get(ha2Serial),
                                isChild: true,
                                parentDevice: device.deviceName
                            });
                            processedSerials.add(ha2Serial);
                        }
                    }
                }
            });

            const haDevicesCount = filteredData.filter(d => d.hasHA).length;
            const childDevicesCount = childDevices.size;

            // Generate editable Excel-compatible HTML
            let html = `
<html xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:x="urn:schemas-microsoft-com:office:excel"
      xmlns="http://www.w3.org/TR/REC-html40">
<head>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">
    <title>Network Infrastructure Asset Report</title>
    <style>
        body { font-family: Calibri, Arial, sans-serif; }
        table { border-collapse: collapse; width: 100%; }
        th {
            background-color: #4472C4;
            color: white;
            font-weight: bold;
            padding: 8px;
            border: 1px solid #2F5597;
            text-align: left;
        }
        td {
            padding: 6px 8px;
            border: 1px solid #D0D0D0;
            text-align: left;
        }
        .child-row td {
            background-color: #E7E6E6;
            padding-left: 20px;
        }
        .parent-row {
            background-color: #F2F2F2;
            font-weight: 600;
        }
        tr:hover { background-color: #DDEEFF; }
        .header-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #F8F9FA;
            border-left: 4px solid #4472C4;
        }
        .header-section h1 {
            color: #2F5597;
            margin: 0 0 5px 0;
            font-size: 18pt;
        }
        .header-section p {
            margin: 3px 0;
            color: #666;
            font-size: 10pt;
        }
    </style>
</head>
<body>
    <div class="header-section">
        <h1>Network Infrastructure Asset Report</h1>
        <p><strong>Generated:</strong> ${timestamp}</p>
        <p><strong>Total Devices:</strong> ${filteredData.length} (${organizedDevices.length} shown in report, ${childDevicesCount} as HA children)</p>
        <p><strong>Report Type:</strong> Hierarchical Asset Inventory with Parent-Child Relationships</p>
    </div>

    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Region</th>
                <th>Device Name</th>
                <th>Vendor</th>
                <th>Type</th>
                <th>Model</th>
                <th>Site</th>
                <th>Role</th>
                <th>Serial Number</th>
            </tr>
        </thead>
        <tbody>
`;

            // Add device rows with hierarchy
            organizedDevices.forEach((item, index) => {
                const device = item.device;

                // Clean and accurate data extraction
                const vendor = device.vendor || detectVendorFromCSV(device) || '';
                const deviceType = device.deviceType || device.type || detectDeviceTypeFromCSV(device) || '';

                // Fix region: use device.region or extract from tenant
                let region = device.region || '';
                if (!region && device.tenant && device.tenant !== 'Default Tenant') {
                    region = extractStateFromTenant(device.tenant);
                }
                if (!region || region === 'Unknown') region = '';

                const deviceName = device.deviceName || device.name || '';
                const model = device.model || device.modelName || '';
                const site = device.siteType || device.site || '';
                const role = device.deviceRole || device.role || '';

                // Clean serial number - remove N/A, empty strings, etc
                let serialNumber = device.sn || device.serialNumber || '';
                if (serialNumber && (serialNumber.toUpperCase() === 'N/A' || serialNumber.toUpperCase() === 'NA')) {
                    serialNumber = '';
                }

                const rowClass = item.isChild ? 'child-row' : (device.hasHA ? 'parent-row' : '');
                const displayName = item.isChild ? `  ↳ ${deviceName}` : deviceName;

                html += `
            <tr class="${rowClass}">
                <td>${index + 1}</td>
                <td>${region}</td>
                <td>${displayName}</td>
                <td>${vendor}</td>
                <td>${deviceType}</td>
                <td>${model}</td>
                <td>${site}</td>
                <td>${role}</td>
                <td>${serialNumber}</td>
            </tr>
`;
            });

            html += `
        </tbody>
    </table>

    <div style="margin-top: 20px; padding: 10px; background-color: #F8F9FA; border-top: 2px solid #4472C4; font-size: 9pt; color: #666;">
        <p><strong>Note:</strong> This spreadsheet is fully editable in Microsoft Excel, LibreOffice Calc, or Google Sheets.</p>
        <p><strong>Columns:</strong> # | Region | Device Name | Vendor | Type | Model | Site | Role | Serial Number</p>
        <p><strong>Hierarchy:</strong> HA primary devices shown with bold text, child/secondary devices indented below their parent.</p>
        <p>Generated by NetAssets Management System | Report Date: ${date}</p>
    </div>
</body>
</html>
`;

            // Create and download the Excel file
            const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Network_Infrastructure_Asset_Report_${date}.xls`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showNotification(`✅ Exported ${filteredData.length} devices with hierarchy (${haDevicesCount} HA pairs)`, 'success');

            // Close both dropdown and modal if they exist
            if (document.getElementById('exportDropdown')) {
                document.getElementById('exportDropdown').classList.remove('show');
            }
            if (document.getElementById('exportModal')) {
                document.getElementById('exportModal').style.display = 'none';
            }
        }

        // Export Technical Assessment Report - Premium Detailed Analysis
        function exportTechnicalAssessment() {
            const now = new Date();
            const timestamp = now.toLocaleString();
            const date = now.toISOString().split('T')[0];

            // Perform comprehensive assessment
            const assessmentData = [];
            let criticalDevices = [];
            let highRiskDevices = [];
            let nonCompliantDevices = [];

            filteredData.forEach(device => {
                const health = calculateDeviceHealth(device);
                const risk = calculateRiskScore(device);
                const compliance = calculateComplianceScore(device);

                const assessment = {
                    device: device,
                    health: health,
                    risk: risk,
                    compliance: compliance
                };

                assessmentData.push(assessment);

                if (risk.level === 'Critical') criticalDevices.push(assessment);
                if (risk.level === 'High') highRiskDevices.push(assessment);
                if (compliance.status === 'Non-Compliant') nonCompliantDevices.push(assessment);
            });

            // Generate detailed HTML report
            let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Technical Infrastructure Assessment Report</title>
    <style>
        @page { margin: 0.5in; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 10pt; color: #333; line-height: 1.5; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 40px; margin: -20px -20px 30px; }
        .header h1 { margin: 0; font-size: 26pt; font-weight: 300; }
        .header .subtitle { font-size: 12pt; opacity: 0.9; margin-top: 10px; }
        .toc { background: #f8f9fa; padding: 20px; margin-bottom: 30px; border-left: 4px solid #1e3c72; }
        .toc h2 { color: #1e3c72; margin-bottom: 15px; }
        .toc ul { list-style: none; padding: 0; }
        .toc li { padding: 5px 0; }
        .toc a { color: #2a5298; text-decoration: none; }
        .section { margin-bottom: 40px; page-break-inside: avoid; }
        .section h2 { color: #1e3c72; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
        .metric-grid { display: table; width: 100%; margin: 20px 0; }
        .metric-box { display: table-cell; padding: 20px; background: #f8f9fa; border: 1px solid #dee2e6; text-align: center; }
        .metric-value { font-size: 32pt; font-weight: bold; color: #1e3c72; }
        .metric-label { color: #6c757d; text-transform: uppercase; font-size: 9pt; margin-top: 5px; }
        .alert { padding: 15px; margin: 20px 0; border-radius: 5px; }
        .alert-critical { background: #f8d7da; border-left: 4px solid #dc3545; color: #721c24; }
        .alert-warning { background: #fff3cd; border-left: 4px solid #ffc107; color: #856404; }
        .alert-info { background: #d1ecf1; border-left: 4px solid #17a2b8; color: #0c5460; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #1e3c72; color: white; padding: 10px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #dee2e6; }
        tr:hover { background: #f8f9fa; }
        .risk-critical { color: #dc3545; font-weight: bold; }
        .risk-high { color: #fd7e14; font-weight: bold; }
        .risk-medium { color: #ffc107; }
        .risk-low { color: #17a2b8; }
        .risk-minimal { color: #28a745; }
        .recommendation { background: #e7f4ff; border-left: 4px solid #17a2b8; padding: 15px; margin: 15px 0; }
        .footer { margin-top: 50px; padding-top: 20px; border-top: 2px solid #dee2e6; text-align: center; color: #6c757d; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎯 Technical Infrastructure Assessment Report</h1>
        <div class="subtitle">Comprehensive Risk, Health & Compliance Analysis</div>
        <div style="margin-top: 20px; font-size: 11pt;">Generated: ${timestamp}</div>
    </div>

    <div class="toc">
        <h2>Table of Contents</h2>
        <ul>
            <li>1. <a href="#summary">Executive Summary</a></li>
            <li>2. <a href="#metrics">Key Performance Metrics</a></li>
            <li>3. <a href="#critical">Critical Risk Devices</a></li>
            <li>4. <a href="#compliance">Compliance Assessment</a></li>
            <li>5. <a href="#health">Infrastructure Health Analysis</a></li>
            <li>6. <a href="#recommendations">Strategic Recommendations</a></li>
            <li>7. <a href="#detailed">Detailed Device Assessment</a></li>
        </ul>
    </div>

    <div class="section" id="summary">
        <h2>1. Executive Summary</h2>
        <p>This technical assessment provides a comprehensive analysis of ${filteredData.length} network devices across the infrastructure.
        The assessment evaluates device health, risk exposure, and compliance status to identify critical vulnerabilities and optimization opportunities.</p>

        ${criticalDevices.length > 0 ? `
        <div class="alert alert-critical">
            <strong>⚠️ Critical Alert:</strong> ${criticalDevices.length} devices identified with critical risk levels requiring immediate attention.
        </div>` : ''}

        ${nonCompliantDevices.length > 0 ? `
        <div class="alert alert-warning">
            <strong>📋 Compliance Notice:</strong> ${nonCompliantDevices.length} devices are non-compliant with policy requirements.
        </div>` : ''}
    </div>

    <div class="section" id="metrics">
        <h2>2. Key Performance Metrics</h2>
        <div class="metric-grid">
            <div class="metric-box">
                <div class="metric-value">${assessmentData.reduce((sum, a) => sum + a.health.score, 0) / assessmentData.length || 0}</div>
                <div class="metric-label">Avg Health Score</div>
            </div>
            <div class="metric-box">
                <div class="metric-value">${criticalDevices.length}</div>
                <div class="metric-label">Critical Risks</div>
            </div>
            <div class="metric-box">
                <div class="metric-value">${((assessmentData.filter(a => a.compliance.status === 'Compliant').length / assessmentData.length) * 100).toFixed(0)}%</div>
                <div class="metric-label">Compliance Rate</div>
            </div>
            <div class="metric-box">
                <div class="metric-value">${assessmentData.filter(a => a.device.hasHA).length}</div>
                <div class="metric-label">HA Protected</div>
            </div>
        </div>
    </div>

    <div class="section" id="critical">
        <h2>3. Critical Risk Devices</h2>
        ${criticalDevices.length > 0 ? `
        <table>
            <thead>
                <tr>
                    <th>Device Name</th>
                    <th>Site</th>
                    <th>Risk Factors</th>
                    <th>Health Score</th>
                    <th>Recommended Action</th>
                </tr>
            </thead>
            <tbody>
                ${criticalDevices.map(a => `
                <tr>
                    <td><strong>${a.device.deviceName}</strong></td>
                    <td>${a.device.siteType || 'Unknown'}</td>
                    <td>${a.risk.factors.map(f => f.description).join(', ')}</td>
                    <td class="risk-${a.risk.level.toLowerCase()}">${a.health.score}/100</td>
                    <td>${a.risk.mitigation[0] ? a.risk.mitigation[0].action : 'Review required'}</td>
                </tr>`).join('')}
            </tbody>
        </table>` : '<p>No critical risk devices identified.</p>'}
    </div>

    <div class="section" id="compliance">
        <h2>4. Compliance Assessment</h2>
        ${nonCompliantDevices.length > 0 ? `
        <table>
            <thead>
                <tr>
                    <th>Device Name</th>
                    <th>Compliance Score</th>
                    <th>Violations</th>
                    <th>Remediation Priority</th>
                </tr>
            </thead>
            <tbody>
                ${nonCompliantDevices.slice(0, 10).map(a => `
                <tr>
                    <td><strong>${a.device.deviceName}</strong></td>
                    <td>${a.compliance.score}%</td>
                    <td>${a.compliance.violations.map(v => v.description).join('; ')}</td>
                    <td>${a.compliance.violations[0] ? a.compliance.violations[0].severity : 'Low'}</td>
                </tr>`).join('')}
            </tbody>
        </table>` : '<p>All devices are compliant with policy requirements.</p>'}
    </div>

    <div class="section" id="health">
        <h2>5. Infrastructure Health Analysis</h2>
        <div class="recommendation">
            <h3>Health Grade Distribution</h3>
            ${['A', 'B', 'C', 'D', 'F'].map(grade => {
                const count = assessmentData.filter(a => a.health.grade === grade).length;
                const percentage = ((count / assessmentData.length) * 100).toFixed(1);
                return count > 0 ? `<div>Grade ${grade}: ${count} devices (${percentage}%)</div>` : '';
            }).join('')}
        </div>

        <div class="recommendation">
            <h3>Top Health Issues</h3>
            <ul>
                ${assessmentData.flatMap(a => a.health.details)
                    .reduce((acc, d) => {
                        const existing = acc.find(x => x.category === d.category);
                        if (existing) existing.count++;
                        else acc.push({ ...d, count: 1 });
                        return acc;
                    }, [])
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5)
                    .map(issue => `<li>${issue.category}: ${issue.count} devices affected</li>`)
                    .join('')}
            </ul>
        </div>
    </div>

    <div class="section" id="recommendations">
        <h2>6. Strategic Recommendations</h2>
        <div class="recommendation">
            <h3>Immediate Actions (0-30 days)</h3>
            <ul>
                ${criticalDevices.length > 0 ? '<li>Address critical risk devices immediately</li>' : ''}
                ${nonCompliantDevices.length > 0 ? '<li>Remediate compliance violations</li>' : ''}
                ${assessmentData.filter(a => !a.device.hasHA && (a.device.siteType === 'PDC' || a.device.siteType === 'BDC')).length > 0 ?
                    '<li>Implement HA for critical site devices</li>' : ''}
                <li>Review and update device configurations</li>
            </ul>
        </div>

        <div class="recommendation">
            <h3>Short-term Actions (30-90 days)</h3>
            <ul>
                <li>Plan hardware refresh for aging devices</li>
                <li>Standardize configuration templates</li>
                <li>Implement automated compliance monitoring</li>
            </ul>
        </div>

        <div class="recommendation">
            <h3>Long-term Strategy (90+ days)</h3>
            <ul>
                <li>Develop comprehensive lifecycle management plan</li>
                <li>Implement predictive maintenance program</li>
                <li>Establish vendor diversity strategy</li>
            </ul>
        </div>
    </div>

    <div class="footer">
        <strong>NetAssets™ Technical Assessment</strong><br>
        Generated: ${timestamp} | Classification: Confidential<br>
        © ${now.getFullYear()} Network Operations - All Rights Reserved
    </div>
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Technical_Assessment_${date}.html`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification(`✅ Technical Assessment Report generated for ${filteredData.length} devices`);
            document.getElementById('exportDropdown').classList.remove('show');
        }

        // Export Compliance Report
        function exportComplianceReport() {
            const now = new Date();
            const timestamp = now.toLocaleString();
            const date = now.toISOString().split('T')[0];

            // Analyze compliance across all devices
            const complianceData = filteredData.map(device => ({
                device: device,
                compliance: calculateComplianceScore(device),
                health: calculateDeviceHealth(device),
                risk: calculateRiskScore(device)
            }));

            const compliantDevices = complianceData.filter(d => d.compliance.status === 'Compliant');
            const partiallyCompliant = complianceData.filter(d => d.compliance.status === 'Partially Compliant');
            const nonCompliant = complianceData.filter(d => d.compliance.status === 'Non-Compliant');

            // Generate compliance report HTML
            let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Network Infrastructure Compliance Audit Report</title>
    <style>
        @page { margin: 0.75in; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 10pt; color: #333; }
        .header { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 30px; margin: -10px -10px 30px; }
        .header h1 { margin: 0; font-size: 24pt; }
        .compliance-summary { background: #d4edda; border-left: 4px solid #28a745; padding: 20px; margin-bottom: 30px; }
        .violation-box { background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 15px 0; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #28a745; color: white; padding: 10px; }
        td { padding: 8px; border-bottom: 1px solid #dee2e6; }
        .compliant { color: #28a745; font-weight: bold; }
        .partial { color: #ffc107; font-weight: bold; }
        .non-compliant { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>✅ Compliance Audit Report</h1>
        <div>Infrastructure Policy Compliance Assessment</div>
    </div>

    <div class="compliance-summary">
        <h2>Compliance Overview</h2>
        <div>Total Devices Audited: ${filteredData.length}</div>
        <div>Compliant: ${compliantDevices.length} (${((compliantDevices.length/filteredData.length)*100).toFixed(1)}%)</div>
        <div>Partially Compliant: ${partiallyCompliant.length} (${((partiallyCompliant.length/filteredData.length)*100).toFixed(1)}%)</div>
        <div>Non-Compliant: ${nonCompliant.length} (${((nonCompliant.length/filteredData.length)*100).toFixed(1)}%)</div>
    </div>

    ${nonCompliant.length > 0 ? `
    <h2>Non-Compliant Devices</h2>
    <table>
        <thead>
            <tr>
                <th>Device</th>
                <th>Score</th>
                <th>Violations</th>
                <th>Priority</th>
            </tr>
        </thead>
        <tbody>
            ${nonCompliant.map(d => `
            <tr>
                <td>${d.device.deviceName}</td>
                <td class="non-compliant">${d.compliance.score}%</td>
                <td>${d.compliance.violations.map(v => v.description).join('; ')}</td>
                <td>${d.compliance.violations[0]?.severity || 'Low'}</td>
            </tr>`).join('')}
        </tbody>
    </table>` : ''}

    <div style="margin-top: 40px; text-align: center; color: #6c757d;">
        Report Generated: ${timestamp}<br>
        NetAssets™ Compliance Management
    </div>
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Compliance_Report_${date}.html`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification(`✅ Compliance Report generated for ${filteredData.length} devices`);
            document.getElementById('exportDropdown').classList.remove('show');
        }

        // =====================================================
        // ENTERPRISE EXPORT SYSTEM - $500M App Quality
        // =====================================================

        let selectedExportFormat = 'csv';
        let exportScope = 'all';

        // Open Export Modal
        function openExportModal() {
            const modal = document.getElementById('exportModal');
            if (modal) {
                modal.classList.add('show');
                updateExportCounts();
                updateExportPreview();
            }
        }

        // Close Export Modal
        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            if (modal) {
                modal.classList.remove('show');
                // Reset selections
                document.querySelectorAll('.export-option-card').forEach(card => {
                    card.classList.remove('selected');
                });
                selectedExportFormat = 'csv';
            }
        }

        // Update export counts in modal
        function updateExportCounts() {
            const allCount = document.querySelector('input[value="all"] + span');
            const filteredCount = document.querySelector('input[value="filtered"] + span');
            const selectedCount = document.querySelector('input[value="selected"] + span');

            if (allCount) allCount.textContent = `All devices (${deviceData.length} total)`;
            if (filteredCount) filteredCount.textContent = `Currently filtered (${filteredData.length} devices)`;
            if (selectedCount) selectedCount.textContent = `Selected devices (${selectedRows.size} selected)`;
        }

        // Select export format
        function selectExportFormat(format) {
            if (format === 'powerpoint') {
                showNotification('📺 PowerPoint export coming in next release!', 'info');
                return;
            }

            selectedExportFormat = format;

            // Update UI
            document.querySelectorAll('.export-option-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Update preview
            updateExportPreview();

            // Update button text
            const btn = document.getElementById('exportExecuteBtn');
            if (btn) {
                const formatNames = {
                    csv: 'CSV',
                    json: 'JSON',
                    pdf: 'PDF Report',
                    executive: 'Executive Report',
                    technical: 'Technical Report',
                    compliance: 'Compliance Report',
                    markdown: 'Markdown'
                };
                btn.textContent = `Export as ${formatNames[format] || format.toUpperCase()}`;
            }
        }

        // Update export preview
        function updateExportPreview() {
            const preview = document.getElementById('exportPreview');
            if (!preview) return;

            const scope = document.querySelector('input[name="exportScope"]:checked')?.value || 'all';
            const template = document.getElementById('exportTemplate')?.value || 'standard';

            let dataToPreview = [];
            if (scope === 'all') {
                dataToPreview = deviceData.slice(0, 3);
            } else if (scope === 'filtered') {
                dataToPreview = filteredData.slice(0, 3);
            } else if (scope === 'selected') {
                dataToPreview = Array.from(selectedRows).slice(0, 3).map(idx => deviceData[idx]);
            }

            if (dataToPreview.length === 0) {
                preview.textContent = 'No data available for preview';
                return;
            }

            let previewContent = '';

            switch (selectedExportFormat) {
                case 'csv':
                    previewContent = 'Device Name,Vendor,Model,Serial Number,Region\n';
                    dataToPreview.forEach(d => {
                        previewContent += `${d.deviceName},${d.vendor},${d.model},${d.sn || 'N/A'},${d.region || 'Unknown'}\n`;
                    });
                    break;

                case 'json':
                    const jsonPreview = dataToPreview.map(d => ({
                        deviceName: d.deviceName,
                        vendor: d.vendor,
                        model: d.model,
                        status: d.status || 'OK'
                    }));
                    previewContent = JSON.stringify(jsonPreview, null, 2);
                    break;

                case 'executive':
                case 'technical':
                case 'compliance':
                case 'pdf':
                    previewContent = `${selectedExportFormat.toUpperCase()} REPORT PREVIEW\n`;
                    previewContent += `━━━━━━━━━━━━━━━━━━━━━━━━\n`;
                    previewContent += `Template: ${template}\n`;
                    previewContent += `Devices: ${dataToPreview.length} of ${scope === 'all' ? deviceData.length : scope === 'filtered' ? filteredData.length : selectedRows.size}\n`;
                    previewContent += `\nSample Data:\n`;
                    dataToPreview.forEach(d => {
                        previewContent += `• ${d.deviceName} - ${d.vendor} ${d.model}\n`;
                    });
                    break;

                case 'markdown':
                    previewContent = '# Network Inventory Export\n\n';
                    previewContent += '| Device | Vendor | Model |\n';
                    previewContent += '|--------|--------|-------|\n';
                    dataToPreview.forEach(d => {
                        previewContent += `| ${d.deviceName} | ${d.vendor} | ${d.model} |\n`;
                    });
                    break;

                case 'asset-inventory':
                    previewContent = 'ASSET INVENTORY EXCEL EXPORT PREVIEW\n';
                    previewContent += '━━━━━━━━━━━━━━━━━━━━━━━━\n';
                    previewContent += 'Format: Editable Excel (.xls)\n';
                    previewContent += `Devices: ${dataToPreview.length}\n\n`;
                    previewContent += 'Columns: # | Region | Device Name | Vendor | Type | Model | Site | Role | Serial Number\n\n';
                    previewContent += 'Sample Data:\n';
                    dataToPreview.slice(0, 3).forEach((d, i) => {
                        // Use same region logic as export
                        let region = d.region || '';
                        if (!region && d.tenant && d.tenant !== 'Default Tenant') {
                            region = extractStateFromTenant(d.tenant);
                        }
                        if (!region || region === 'Unknown') region = '';

                        previewContent += `${i+1}. ${region || '[empty]'} | ${d.deviceName} | ${d.vendor || '[empty]'} | ${d.deviceType || '[empty]'} | ${d.model || '[empty]'}\n`;
                    });
                    break;

                default:
                    previewContent = 'Select a format to see preview...';
            }

            preview.textContent = previewContent;
        }

        // Execute export
        function executeExport() {
            const scope = document.querySelector('input[name="exportScope"]:checked')?.value || 'all';
            const template = document.getElementById('exportTemplate')?.value || 'standard';

            // Determine data to export
            let dataToExport = [];
            if (scope === 'all') {
                dataToExport = deviceData;
            } else if (scope === 'filtered') {
                dataToExport = filteredData;
            } else if (scope === 'selected') {
                if (selectedRows.size === 0) {
                    showNotification('⚠️ No devices selected for export', 'warning');
                    return;
                }
                dataToExport = Array.from(selectedRows).map(idx => deviceData[idx]);
            }

            if (dataToExport.length === 0) {
                showNotification('⚠️ No data to export', 'warning');
                return;
            }

            // Store original filteredData temporarily
            const originalFiltered = filteredData;
            filteredData = dataToExport;

            // Execute export based on format
            try {
                switch (selectedExportFormat) {
                    case 'csv':
                        exportToCSV();
                        break;
                    case 'json':
                        exportToJSON();
                        break;
                    case 'executive':
                        exportToExcelCorporate();
                        break;
                    case 'technical':
                        exportTechnicalAssessment();
                        break;
                    case 'compliance':
                        exportComplianceReport();
                        break;
                    case 'markdown':
                        exportToMarkdown();
                        break;
                    case 'asset-inventory':
                        exportInfrastructureAssetExcel();
                        break;
                    case 'pdf':
                        // Generate premium PDF report
                        generatePDFReport(dataToExport, template);
                        break;
                    default:
                        showNotification(`⚠️ Export format ${selectedExportFormat} not yet implemented`, 'warning');
                }

                // Log export analytics
                console.log(`📊 Export Analytics:`, {
                    format: selectedExportFormat,
                    scope: scope,
                    template: template,
                    deviceCount: dataToExport.length,
                    timestamp: new Date().toISOString()
                });

            } finally {
                // Restore original filteredData
                filteredData = originalFiltered;
                closeExportModal();
            }
        }

        // Quick export functions
        function quickExport(format) {
            selectedExportFormat = format;

            if (format === 'pdf') {
                generatePDFReport(filteredData, 'standard');
            } else if (format === 'csv') {
                exportToCSV();
            }
        }

        // PROFESSIONAL PDF EXPORT - ENTERPRISE GRADE WITH FULL DATA VALIDATION
        function generatePDFReport(data, template) {
            // Validate data first
            if (!data || data.length === 0) {
                showNotification('⚠️ No data available for PDF export', 'error');
                return;
            }

            const now = new Date();

            // Process and validate each device with error handling
            const processedData = data.map(device => {
                try {
                    // Calculate health score safely
                    const health = calculateDeviceHealth(device) || { score: 0, grade: 'N/A' };
                    const risk = calculateRiskScore(device) || { score: 0, level: 'Unknown' };

                    return {
                        // Core fields with validation
                        deviceName: device.deviceName || 'Unknown Device',
                        vendor: device.vendor || 'Unknown',
                        model: device.model || device.series || 'N/A',
                        deviceType: device.deviceType || device.type || 'Unknown',

                        // Location data with fallbacks
                        region: device.region || 'Unknown',
                        location: device.location || device.site || 'N/A',
                        country: device.country || 'N/A',
                        siteType: device.siteType || 'N/A',

                        // Technical data
                        ipAddress: device.ipAddress || 'Not Configured',
                        sn: device.sn || device.serialNumber || 'N/A',
                        secondarySN: device.secondarySN || '',
                        deviceRole: device.deviceRole || device.role || 'N/A',

                        // Status and health
                        haStatus: device.haStatus || 'standalone',
                        healthScore: health.score,
                        healthGrade: health.grade,
                        riskScore: risk.score,
                        riskLevel: risk.level,

                        // Compliance
                        compliance: device.compliance || { status: 'Unknown', score: 0 },
                        lastUpdated: device.lastUpdated || now.toISOString()
                    };
                } catch (err) {
                    console.error(`Error processing device ${device.deviceName}:`, err);
                    return {
                        ...device,
                        healthScore: 0,
                        healthGrade: 'Error',
                        riskScore: 0,
                        riskLevel: 'Unknown'
                    };
                }
            });

            // Calculate accurate statistics
            const stats = {
                totalDevices: processedData.length,
                haConfigured: processedData.filter(d => d.haStatus && d.haStatus !== 'standalone').length,
                uniqueVendors: [...new Set(processedData.map(d => d.vendor).filter(v => v && v !== 'Unknown'))].length,
                healthyDevices: processedData.filter(d => d.healthScore >= 80).length,
                criticalDevices: processedData.filter(d => d.riskLevel === 'Critical').length,
                highRiskDevices: processedData.filter(d => d.riskLevel === 'High').length,
                compliantDevices: processedData.filter(d => d.compliance && d.compliance.status === 'Compliant').length,
                regions: [...new Set(processedData.map(d => d.region).filter(r => r && r !== 'Unknown'))],
                avgHealthScore: Math.round(processedData.reduce((sum, d) => sum + (d.healthScore || 0), 0) / processedData.length),
                dataCenters: processedData.filter(d => d.siteType && ['PDC', 'BDC', 'DC'].includes(d.siteType)).length
            };

            // Generate professional HTML report with accurate data
            const html = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Network Infrastructure Report - ${now.toLocaleDateString()}</title>
                <style>
                    @page {
                        size: A4;
                        margin: 15mm;
                        @bottom-right {
                            content: "Page " counter(page) " of " counter(pages);
                        }
                    }
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    body {
                        font-family: 'Segoe UI', 'Arial', sans-serif;
                        line-height: 1.6;
                        color: #1a1a1a;
                        background: white;
                        padding: 20px;
                        max-width: 210mm;
                        margin: 0 auto;
                    }
                    .header {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 40px 30px;
                        border-radius: 8px;
                        margin-bottom: 30px;
                        page-break-inside: avoid;
                        position: relative;
                        overflow: hidden;
                    }
                    .header::before {
                        content: '';
                        position: absolute;
                        top: -50%;
                        right: -10%;
                        width: 300px;
                        height: 300px;
                        background: rgba(255,255,255,0.1);
                        border-radius: 50%;
                    }
                    h1 {
                        font-size: 2.5em;
                        font-weight: 300;
                        margin-bottom: 10px;
                        position: relative;
                        z-index: 1;
                    }
                    h2 {
                        color: #334155;
                        font-size: 1.8em;
                        margin: 30px 0 20px 0;
                        padding-bottom: 10px;
                        border-bottom: 2px solid #e2e8f0;
                        page-break-after: avoid;
                    }
                    h3 {
                        color: #475569;
                        font-size: 1.3em;
                        margin: 20px 0 15px 0;
                    }
                    .subtitle {
                        font-size: 1.2em;
                        opacity: 0.95;
                        margin-bottom: 15px;
                        position: relative;
                        z-index: 1;
                    }
                    .metadata {
                        font-size: 0.95em;
                        opacity: 0.9;
                        position: relative;
                        z-index: 1;
                    }
                    .executive-summary {
                        background: #f8fafc;
                        padding: 25px;
                        border-radius: 8px;
                        margin: 30px 0;
                        border-left: 4px solid #667eea;
                        page-break-inside: avoid;
                    }
                    .summary-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin: 30px 0;
                    }
                    .stat-card {
                        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                        padding: 25px;
                        border-radius: 8px;
                        border-left: 4px solid #667eea;
                        page-break-inside: avoid;
                        transition: transform 0.2s;
                    }
                    .stat-value {
                        font-size: 2.5em;
                        font-weight: 700;
                        color: #667eea;
                        margin-bottom: 5px;
                    }
                    .stat-label {
                        color: #64748b;
                        font-size: 0.95em;
                        font-weight: 500;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    .stat-detail {
                        color: #94a3b8;
                        font-size: 0.85em;
                        margin-top: 5px;
                    }
                    .risk-summary {
                        background: #fff;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 20px;
                        margin: 20px 0;
                        page-break-inside: avoid;
                    }
                    .risk-grid {
                        display: grid;
                        grid-template-columns: repeat(5, 1fr);
                        gap: 15px;
                        margin-top: 15px;
                    }
                    .risk-item {
                        text-align: center;
                        padding: 15px;
                        border-radius: 6px;
                        background: #f8fafc;
                    }
                    .risk-critical { background: #fee2e2; color: #991b1b; }
                    .risk-high { background: #fed7aa; color: #92400e; }
                    .risk-medium { background: #fef3c7; color: #78350f; }
                    .risk-low { background: #dbeafe; color: #1e40af; }
                    .risk-minimal { background: #d1fae5; color: #065f46; }
                    table {
                        width: 100%;
                        border-collapse: separate;
                        border-spacing: 0;
                        margin: 20px 0;
                        background: white;
                        border-radius: 8px;
                        overflow: hidden;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                        page-break-inside: auto;
                    }
                    thead {
                        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
                    }
                    th {
                        padding: 14px;
                        text-align: left;
                        font-weight: 600;
                        color: #334155;
                        font-size: 0.9em;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        border-bottom: 2px solid #cbd5e1;
                    }
                    td {
                        padding: 12px 14px;
                        border-bottom: 1px solid #e2e8f0;
                        color: #475569;
                        font-size: 0.95em;
                    }
                    tr:last-child td {
                        border-bottom: none;
                    }
                    tbody tr:hover {
                        background: #f8fafc;
                    }
                    tbody tr {
                        page-break-inside: avoid;
                    }
                    .badge {
                        display: inline-block;
                        padding: 3px 10px;
                        border-radius: 12px;
                        font-size: 0.85em;
                        font-weight: 600;
                        letter-spacing: 0.3px;
                    }
                    .badge-success {
                        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
                        color: #065f46;
                    }
                    .badge-warning {
                        background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
                        color: #92400e;
                    }
                    .badge-danger {
                        background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%);
                        color: #991b1b;
                    }
                    .badge-info {
                        background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
                        color: #1e40af;
                    }
                    .device-name {
                        font-weight: 600;
                        color: #1e293b;
                    }
                    .footer {
                        margin-top: 60px;
                        padding-top: 30px;
                        border-top: 2px solid #e2e8f0;
                        text-align: center;
                        color: #64748b;
                        font-size: 0.9em;
                        page-break-inside: avoid;
                    }
                    .footer-logo {
                        font-size: 1.2em;
                        font-weight: 600;
                        color: #667eea;
                        margin-bottom: 10px;
                    }
                    .charts-section {
                        margin: 30px 0;
                        page-break-inside: avoid;
                    }
                    .data-quality {
                        background: #fff;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 20px;
                        margin: 20px 0;
                    }
                    .quality-bar {
                        width: 100%;
                        height: 20px;
                        background: #e2e8f0;
                        border-radius: 10px;
                        overflow: hidden;
                        margin: 10px 0;
                    }
                    .quality-fill {
                        height: 100%;
                        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                        transition: width 0.3s;
                    }
                    @media print {
                        body {
                            padding: 0;
                        }
                        .header {
                            background: #667eea !important;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .stat-card {
                            background: #f8fafc !important;
                            -webkit-print-color-adjust: exact;
                        }
                        table {
                            box-shadow: none;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Network Infrastructure Report</h1>
                    <div class="subtitle">
                        ${template === 'executive' ? 'Executive Summary Report' :
                          template === 'technical' ? 'Technical Assessment Report' :
                          template === 'compliance' ? 'Compliance & Audit Report' :
                          'Comprehensive Infrastructure Analysis'}
                    </div>
                    <div class="metadata">
                        <strong>Generated:</strong> ${now.toLocaleString()} |
                        <strong>Total Devices:</strong> ${stats.totalDevices} |
                        <strong>Report ID:</strong> ${Math.random().toString(36).substr(2, 9).toUpperCase()}
                    </div>
                </div>

                ${template === 'executive' || template === 'standard' ? `
                <div class="executive-summary">
                    <h3>Executive Overview</h3>
                    <p>This report provides a comprehensive analysis of the network infrastructure containing
                    <strong>${stats.totalDevices}</strong> devices across <strong>${stats.regions.length}</strong> regions.
                    The overall infrastructure health score is <strong>${stats.avgHealthScore}%</strong> with
                    <strong>${stats.haConfigured}</strong> devices configured for high availability.</p>

                    <p style="margin-top: 15px;">Key findings indicate <strong>${stats.criticalDevices}</strong> devices
                    in critical state and <strong>${stats.highRiskDevices}</strong> in high-risk condition requiring
                    immediate attention. Compliance status shows <strong>${stats.compliantDevices}</strong> devices
                    meeting all regulatory requirements.</p>
                </div>
                ` : ''}

                <div class="summary-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalDevices}</div>
                        <div class="stat-label">Total Devices</div>
                        <div class="stat-detail">${stats.regions.join(', ')}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.haConfigured}</div>
                        <div class="stat-label">HA Configured</div>
                        <div class="stat-detail">${Math.round((stats.haConfigured/stats.totalDevices)*100)}% Coverage</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.uniqueVendors}</div>
                        <div class="stat-label">Vendors</div>
                        <div class="stat-detail">Multi-vendor Environment</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.avgHealthScore}%</div>
                        <div class="stat-label">Avg Health</div>
                        <div class="stat-detail">${stats.healthyDevices} Healthy Devices</div>
                    </div>
                </div>

                <div class="risk-summary">
                    <h3>Risk Distribution Analysis</h3>
                    <div class="risk-grid">
                        <div class="risk-item risk-critical">
                            <div style="font-size: 1.8em; font-weight: bold;">${stats.criticalDevices}</div>
                            <div style="font-size: 0.9em;">Critical</div>
                        </div>
                        <div class="risk-item risk-high">
                            <div style="font-size: 1.8em; font-weight: bold;">${stats.highRiskDevices}</div>
                            <div style="font-size: 0.9em;">High</div>
                        </div>
                        <div class="risk-item risk-medium">
                            <div style="font-size: 1.8em; font-weight: bold;">${processedData.filter(d => d.riskLevel === 'Medium').length}</div>
                            <div style="font-size: 0.9em;">Medium</div>
                        </div>
                        <div class="risk-item risk-low">
                            <div style="font-size: 1.8em; font-weight: bold;">${processedData.filter(d => d.riskLevel === 'Low').length}</div>
                            <div style="font-size: 0.9em;">Low</div>
                        </div>
                        <div class="risk-item risk-minimal">
                            <div style="font-size: 1.8em; font-weight: bold;">${processedData.filter(d => d.riskLevel === 'Minimal' || d.riskLevel === 'Unknown').length}</div>
                            <div style="font-size: 0.9em;">Minimal</div>
                        </div>
                    </div>
                </div>

                <h2>Device Inventory Details</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Device Name</th>
                            <th>IP Address</th>
                            <th>Vendor/Model</th>
                            <th>Location</th>
                            <th>HA Status</th>
                            <th>Health</th>
                            <th>Risk</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${processedData.slice(0, 100).map(d => `
                        <tr>
                            <td><span class="device-name">${d.deviceName}</span></td>
                            <td>${d.ipAddress}</td>
                            <td>${d.vendor} ${d.model}</td>
                            <td>${d.location} (${d.region})</td>
                            <td>
                                <span class="badge ${d.haStatus !== 'standalone' ? 'badge-success' : 'badge-warning'}">
                                    ${d.haStatus}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${d.healthScore >= 80 ? 'badge-success' :
                                                    d.healthScore >= 50 ? 'badge-warning' :
                                                    'badge-danger'}">
                                    ${d.healthGrade} (${d.healthScore}%)
                                </span>
                            </td>
                            <td>
                                <span class="badge ${d.riskLevel === 'Critical' ? 'badge-danger' :
                                                    d.riskLevel === 'High' ? 'badge-warning' :
                                                    d.riskLevel === 'Medium' ? 'badge-info' :
                                                    'badge-success'}">
                                    ${d.riskLevel}
                                </span>
                            </td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>

                ${processedData.length > 100 ? `
                <p style="text-align: center; color: #64748b; margin-top: 20px; font-style: italic;">
                    Showing first 100 of ${processedData.length} devices. Full dataset available in CSV/JSON export.
                </p>` : ''}

                <div class="data-quality">
                    <h3>Data Quality Assessment</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Serial Number Coverage</span>
                                <span>${Math.round((processedData.filter(d => d.sn && d.sn !== 'N/A').length / processedData.length) * 100)}%</span>
                            </div>
                            <div class="quality-bar">
                                <div class="quality-fill" style="width: ${(processedData.filter(d => d.sn && d.sn !== 'N/A').length / processedData.length) * 100}%"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>IP Address Coverage</span>
                                <span>${Math.round((processedData.filter(d => d.ipAddress && d.ipAddress !== 'Not Configured').length / processedData.length) * 100)}%</span>
                            </div>
                            <div class="quality-bar">
                                <div class="quality-fill" style="width: ${(processedData.filter(d => d.ipAddress && d.ipAddress !== 'Not Configured').length / processedData.length) * 100}%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="footer">
                    <div class="footer-logo">NetAssets Enterprise v2.1</div>
                    <p><strong>Network Infrastructure Management Platform</strong></p>
                    <p>This report contains confidential and proprietary information. Handle according to company data classification policies.</p>
                    <p style="margin-top: 10px; font-size: 0.85em;">Report Template: ${template.toUpperCase()} | Data Points: ${Object.keys(processedData[0] || {}).length} | Processing Time: ${Date.now() - now.getTime()}ms</p>
                </div>
            </body>
            </html>
            `;

            // Create professional PDF download
            const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `NetAssets_${template.toUpperCase()}_Report_${now.toISOString().split('T')[0]}_${Math.random().toString(36).substr(2, 9).toUpperCase()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            // Log export for audit trail
            console.log('PDF Export Generated:', {
                timestamp: now.toISOString(),
                template: template,
                devices: processedData.length,
                stats: stats,
                quality: {
                    serialCoverage: `${Math.round((processedData.filter(d => d.sn && d.sn !== 'N/A').length / processedData.length) * 100)}%`,
                    ipCoverage: `${Math.round((processedData.filter(d => d.ipAddress && d.ipAddress !== 'Not Configured').length / processedData.length) * 100)}%`,
                    healthData: `${Math.round((processedData.filter(d => d.healthScore > 0).length / processedData.length) * 100)}%`
                }
            });

            showNotification(`✅ Professional PDF report generated successfully for ${processedData.length} devices`, 'success');
        }

        // Import functionality
        let importData = [];
        let importOption = 'replace';
        let importFileType = null;

        // Toggle import menu
        function toggleImportMenu() {
            const dropdown = document.getElementById('importDropdown');
            dropdown.classList.toggle('show');
        }

        // Close import dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('importDropdown');
            const importBtn = document.querySelector('.import-menu-container');

            if (dropdown && importBtn && !importBtn.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Open import modal
        function openImportModal(fileType) {
            importFileType = fileType;
            const modal = document.getElementById('importModal');
            if (!modal) {
                console.error('Import modal not found');
                showNotification('❌ Import modal not found. Please refresh the page.', 'error');
                return;
            }
            modal.classList.add('show');

            const dropdown = document.getElementById('importDropdown');
            if (dropdown) dropdown.classList.remove('show');

            // Reset modal state
            const fileInput = document.getElementById('fileInput');
            const optionsSection = document.getElementById('importOptionsSection');
            const previewSection = document.getElementById('importPreviewSection');
            const errorDiv = document.getElementById('importError');
            const confirmBtn = document.getElementById('confirmImportBtn');

            if (fileInput) fileInput.value = '';
            if (optionsSection) optionsSection.style.display = 'none';
            if (previewSection) previewSection.style.display = 'none';
            if (errorDiv) errorDiv.style.display = 'none';
            if (confirmBtn) confirmBtn.disabled = true;
            importData = [];
        }

        // Close import modal
        function closeImportModal() {
            const modal = document.getElementById('importModal');
            if (modal) {
                modal.classList.remove('show');
                // Reset the modal content
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.value = '';
                importData = [];
                importOption = 'replace';  // Reset to default

                // Reset option buttons
                document.querySelectorAll('.import-option-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.option === 'replace') {
                        btn.classList.add('active');
                    }
                });
            }
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;

                    if (fileName.endsWith('.csv')) {
                        importData = parseCSV(content);
                    } else if (fileName.endsWith('.json')) {
                        importData = parseJSON(content);
                    } else if (isExcel) {
                        importData = parseXLSX(content);
                    } else {
                        showImportError('Unsupported file format. Please use CSV, JSON, or Excel (.xlsx/.xls).');
                        return;
                    }

                    if (importData.length === 0) {
                        showImportError('No valid data found in file.');
                        return;
                    }

                    // Validate and show preview
                    const validation = validateImportData(importData);
                    if (!validation.valid) {
                        showImportError(validation.error);
                        return;
                    }

                    showImportPreview(importData);

                    const optionsSection = document.getElementById('importOptionsSection');
                    const confirmBtn = document.getElementById('confirmImportBtn');

                    if (optionsSection) optionsSection.style.display = 'block';
                    if (confirmBtn) confirmBtn.disabled = false;

                } catch (error) {
                    showImportError('Error reading file: ' + error.message);
                }
            };

            // Read as binary for Excel files, text for others
            if (isExcel) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // 🔧 HIERARCHICAL CSV PRE-PROCESSOR
        // Automatically detects and flattens NMS exports with repeating headers
        // ═══════════════════════════════════════════════════════════════════════════════
        function preprocessHierarchicalCSV(content) {
            const lines = content.trim().split('\n');
            if (lines.length < 10) return content; // Too small to be hierarchical

            // Detect hierarchical CSV patterns:
            // Pattern 1: Repeating blocks (same header appears 3+ times)
            // Pattern 2: Two-section format (device header + component header)

            let deviceHeaderCount = 0;
            let componentHeaderCount = 0;
            let deviceHeaderLine = -1;
            let componentHeaderLine = -1;

            // Scan first 200 lines for headers (components can be far down)
            for (let i = 0; i < Math.min(200, lines.length); i++) {
                const line = lines[i];

                // Device section header: "Status,Device Category,Name,..."
                if (line.includes('Status,Device Category') && line.includes('Name,Hostname')) {
                    deviceHeaderCount++;
                    if (deviceHeaderLine === -1) {
                        deviceHeaderLine = i;
                    }
                }

                // Component section header: "Status,Administrative State,...,Serial Number,..."
                if (line.includes('Status,Administrative State') && line.includes('Serial Number')) {
                    componentHeaderCount++;
                    if (componentHeaderLine === -1) {
                        componentHeaderLine = i;
                    }
                }
            }

            // Pattern 1: Repeating blocks (same device header appears multiple times)
            if (deviceHeaderCount > 2) {
                console.log('🔍 Hierarchical CSV detected (repeating blocks)! Auto-flattening...');
                return flattenHierarchicalCSV(lines);
            }

            // Pattern 2: Two-section format (one device header + one component header)
            if (deviceHeaderLine !== -1 && componentHeaderLine !== -1 && componentHeaderLine > deviceHeaderLine) {
                console.log(`🔍 Two-section hierarchical CSV detected! Device section at line ${deviceHeaderLine + 1}, Component section at line ${componentHeaderLine + 1}`);
                console.log('🔄 Auto-flattening to merge device and component data...');
                return flattenHierarchicalCSV(lines);
            }

            return content; // Return original if not hierarchical
        }

        function flattenHierarchicalCSV(lines) {
            // This CSV has TWO sections:
            // Section 1: Device rows (all devices together)
            // Section 2: Component rows (all components together)
            // Components reference their parent device via "Managed By" field (column [3])

            const deviceMap = new Map(); // Map device name -> device object
            let deviceHeader = null;
            let componentHeader = null;
            let state = 'INIT';
            let deviceHeaderLine = -1;
            let componentHeaderLine = -1;

            console.log('🔍 Parsing hierarchical CSV with separated device and component sections...');

            // PASS 1: Parse ALL devices and store in map
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const cols = parseCSVLine(line);

                // Device header
                if (cols.length >= 30 && cols[0] === 'Status' && cols[1] === 'Device Category') {
                    deviceHeader = cols;
                    deviceHeaderLine = i;
                    state = 'DEVICE_SECTION';
                    console.log(`   📋 Device header found at line ${i + 1}`);
                    continue;
                }

                // Component header - marks end of device section
                if (cols.length >= 10 && cols[0] === 'Status' && cols[1] === 'Administrative State') {
                    componentHeader = cols;
                    componentHeaderLine = i;
                    state = 'COMPONENT_SECTION';
                    console.log(`   📋 Component header found at line ${i + 1}`);
                    console.log(`   ✅ Parsed ${deviceMap.size} devices from device section`);
                    break; // Stop parsing devices, will parse components in pass 2
                }

                // Device data row
                if (state === 'DEVICE_SECTION' && cols.length >= 25) {
                    const deviceName = cols[2] || ''; // Column [2] = Name
                    if (deviceName && !deviceName.includes('Pseudo') && deviceName !== 'VDOM') {
                        deviceMap.set(deviceName, {
                            deviceRow: cols,
                            components: []
                        });
                    }
                }
            }

            // PASS 2: Parse ALL components and match to devices by "Managed By" field
            if (componentHeaderLine !== -1) {
                console.log('   🔗 Matching components to parent devices...');
                let matchedComponents = 0;
                let unmatchedComponents = 0;

                for (let i = componentHeaderLine + 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const cols = parseCSVLine(line);
                    if (cols.length < 5) continue;

                    const managedBy = cols[3] || ''; // Column [3] = "Managed By" (parent device name)
                    const compName = cols[5] || '';  // Column [5] = Component Name

                    // Skip noise
                    if (!compName || compName.includes('Pseudo Chassis') || compName === 'VDOM') {
                        continue;
                    }

                    // Find parent device
                    if (deviceMap.has(managedBy)) {
                        deviceMap.get(managedBy).components.push(cols);
                        matchedComponents++;
                    } else {
                        unmatchedComponents++;
                        if (unmatchedComponents <= 5) {
                            console.warn(`   ⚠️ Component "${compName}" references unknown device "${managedBy}"`);
                        }
                    }
                }

                console.log(`   ✅ Matched ${matchedComponents} components to devices`);
                if (unmatchedComponents > 0) {
                    console.warn(`   ⚠️ ${unmatchedComponents} components couldn't be matched to parent devices`);
                }
            }

            // Convert map to array
            const devices = Array.from(deviceMap.values());

            // Build flattened CSV
            const flatLines = [];

            // Combined header
            const flatHeader = [
                'Status', 'Device Category', 'Name', 'Hostname', 'Management Address',
                'Tenant', 'Security Group', 'System Location', 'Device Vendor', 'Device Family',
                'Device Profile', 'Model Name', 'Serial Number', 'Firmware Version',
                'Hardware Version', 'Software Version', 'System Description',
                'Node Management Mode', 'System Object ID', 'SNMP Agent', 'Protocol Version',
                'Agent SNMP State', 'Management Address ICMP State', 'Status Last Modified',
                'Discovery State', 'Last Completed', 'Created', 'Last Modified'
            ];
            flatLines.push(flatHeader.join(','));

            // Device rows with merged component data
            devices.forEach(device => {
                const row = [];
                const d = device.deviceRow;

                // Device fields (map to output columns)
                row[0] = d[0] || '';   // Status
                row[1] = d[1] || '';   // Device Category
                row[2] = d[2] || '';   // Name
                row[3] = d[3] || '';   // Hostname
                row[4] = d[4] || '';   // Management Address
                row[5] = d[5] || '';   // Tenant
                row[6] = d[6] || '';   // Security Group
                row[7] = d[7] || '';   // System Location
                row[8] = d[20] || '';  // Device Vendor
                row[9] = d[21] || '';  // Device Family
                row[10] = d[8] || '';  // Device Profile

                // Find best component (skip VDOMs, prefer with serial)
                let bestComp = null;
                for (const comp of device.components) {
                    if (comp[8] && comp[8].trim()) {
                        bestComp = comp;
                        break;
                    }
                    if (!bestComp) bestComp = comp;
                }

                // Component fields
                if (bestComp) {
                    row[11] = bestComp[6] || '';  // Model Name
                    row[12] = bestComp[8] || '';  // Serial Number
                    row[13] = bestComp[9] || '';  // Firmware Version
                    row[14] = bestComp[10] || ''; // Hardware Version
                    row[15] = bestComp[11] || ''; // Software Version
                }

                // Rest of device fields
                row[16] = d[17] || '';  // System Description
                row[17] = d[18] || '';  // Node Management Mode
                row[18] = d[19] || '';  // System Object ID
                row[19] = d[22] || '';  // SNMP Agent
                row[20] = d[23] || '';  // Protocol Version
                row[21] = d[24] || '';  // Agent SNMP State
                row[22] = d[25] || '';  // Management Address ICMP State
                row[23] = d[10] || '';  // Status Last Modified
                row[24] = d[27] || '';  // Discovery State
                row[25] = d[28] || '';  // Last Completed
                row[26] = d[29] || '';  // Created
                row[27] = d[30] || '';  // Last Modified

                // CSV escape and join
                const csvRow = row.map(cell => {
                    if (!cell) return '';
                    const str = String(cell);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                }).join(',');

                flatLines.push(csvRow);
            });

            console.log(`✅ Flattened ${devices.length} devices from hierarchical CSV`);
            return flatLines.join('\n');
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // 🧠 INTELLIGENT NAMING CONVENTION PARSER
        // Extracts location, site type, device role, and HA pairing from hostnames
        // ═══════════════════════════════════════════════════════════════════════════════

        function parseHostnameIntelligent(hostname, systemLocation = '', ipAddress = '') {
            const result = {
                country: '', state: '', stateCode: '', city: '', jurisdiction: '',
                siteType: '', siteName: '', pod: '', stack: '',
                deviceRole: '', deviceFunction: '', vendor: '',
                haGroup: '', haRole: '', isPrimary: false, haPartner: '',
                confidence: 0
            };

            if (!hostname) return result;
            const lower = hostname.toLowerCase();
            let confidence = 0;

            // 1. LOCATION/JURISDICTION EXTRACTION
            // NOTE: Only match SPECIFIC multi-letter prefixes at hostname start with word boundary
            // Avoid short 2-letter codes that match device names/chassis/models
            const jurisdictionMap = {
                'lil': { jurisdiction: 'Lottery IL', state: 'Illinois', stateCode: 'IL', country: 'US' },
                'ris': { jurisdiction: 'RI Sports', state: 'Rhode Island', stateCode: 'RI', country: 'US' },
                'risp': { jurisdiction: 'RI Sports', state: 'Rhode Island', stateCode: 'RI', country: 'US' },
                'usvi': { jurisdiction: 'US Virgin Islands', state: 'US Virgin Islands', stateCode: 'VI', country: 'US' }
                // Removed short codes like 'tx', 'ca', 'co', 'in' - too generic, cause false positives
                // These match chassis names (CAT6509), model names (CO-ROUTER), etc.
            };

            // Only match if prefix is followed by non-letter (word boundary) or end of string
            // This prevents "CATALYST" from matching "ca", "CORE" from matching "co", etc.
            for (const [prefix, data] of Object.entries(jurisdictionMap)) {
                const regex = new RegExp(`^${prefix}(?=[^a-z]|$)`);
                if (regex.test(lower)) {
                    Object.assign(result, data);
                    confidence += 30;
                    break;
                }
            }

            // 2. CITY EXTRACTION
            const locLower = systemLocation.toLowerCase();
            if (locLower.includes('austin') || lower.includes('aust')) {
                result.city = 'Austin';
                if (!result.state) result.state = 'Texas';
                confidence += 15;
            } else if (locLower.includes('west greenwich') || locLower.includes('wg')) {
                result.city = 'West Greenwich';
                if (!result.state) result.state = 'Rhode Island';
                confidence += 15;
            } else if (locLower.includes('st.thomas') || locLower.includes('st thomas')) {
                result.city = 'St. Thomas';
                if (!result.state) result.state = 'US Virgin Islands';
                confidence += 15;
            }

            // 3. SITE TYPE EXTRACTION
            if (lower.includes('pdc') || locLower.includes('pdc')) {
                result.siteType = 'PDC';
                confidence += 15;
            } else if (lower.includes('bdc') || locLower.includes('bdc')) {
                result.siteType = 'BDC';
                confidence += 15;
            } else if (lower.includes('cat') || locLower.includes('cat')) {
                result.siteType = 'CAT';
                confidence += 15;
            } else if (locLower.includes('hub')) {
                result.siteType = 'Hub';
                confidence += 15;
            }

            // 4. DEVICE ROLE EXTRACTION
            const deviceRoleMap = {
                'fw': { role: 'Firewall', function: 'Security', type: 'Firewall' },
                'crsw': { role: 'Core Switch', function: 'Core Switching', type: 'Switch' },
                'wansw': { role: 'WAN Switch', function: 'WAN Edge', type: 'Switch' },
                'vtlb': { role: 'Virtual Load Balancer', function: 'Load Balancing', type: 'Load Balancer' },
                'hp': { role: 'HP Server', function: 'Compute', type: 'Server', vendor: 'Hewlett Packard' },
                'acon': { role: 'Console Server', function: 'Management', type: 'Console' },
                'lantronix': { role: 'Console Server', function: 'Management', type: 'Console', vendor: 'Lantronix' },
                'pix': { role: 'Firewall', function: 'Security', type: 'Firewall', vendor: 'Cisco' }
            };

            for (const [pattern, data] of Object.entries(deviceRoleMap)) {
                if (lower.includes(pattern)) {
                    result.deviceRole = data.role;
                    result.deviceFunction = data.function;
                    if (data.vendor) result.vendor = data.vendor;
                    confidence += 25;
                    break;
                }
            }

            // 5. HA DETECTION
            const siteMatch = lower.match(/s(\d+)/);
            if (siteMatch) {
                result.haGroup = siteMatch[1];
                if (siteMatch[1] === '1') {
                    result.isPrimary = true;
                    result.haRole = 'Primary';
                    result.haPartner = hostname.replace(/s1/, 's2');
                } else if (siteMatch[1] === '2') {
                    result.isPrimary = false;
                    result.haRole = 'Secondary';
                    result.haPartner = hostname.replace(/s2/, 's1');
                }
                confidence += 15;
            }

            // 6. IP ADDRESS RANGE MAPPING
            if (ipAddress) {
                if (ipAddress.startsWith('10.215.49.')) {
                    if (!result.city) result.city = 'Austin';
                    confidence += 10;
                } else if (ipAddress.startsWith('10.215.59.')) {
                    if (!result.city) result.city = 'West Greenwich';
                    confidence += 10;
                }
            }

            result.confidence = Math.min(confidence, 100);
            return result;
        }

        /**
         * Extract region from Tenant field (e.g., "California_Tenant" → "California")
         */
        function extractRegionFromTenant(tenant) {
            if (!tenant) return '';

            // Pattern: "StateName_Tenant"
            const match = tenant.match(/^([A-Za-z\s]+)_Tenant$/);
            if (match) {
                return match[1].trim();
            }

            // If tenant doesn't match pattern, return as-is (might be useful)
            return tenant;
        }

        /**
         * Enrich device data with COMPREHENSIVE GEOGRAPHIC VALIDATION
         * Multi-field analysis with cross-validation and confidence scoring
         * Only populates geographic data when VALIDATED and ACCURATE
         */
        function enrichDeviceDataWithIntelligence(devices) {
            console.log('\n🌍 Starting comprehensive geographic validation for all devices...');

            let validatedCount = 0;
            let rejectedCount = 0;
            let sheetNameCount = 0;
            const mismatches = [];

            const enriched = devices.map(device => {
                // STEP 1: Comprehensive geographic analysis (validates from multiple sources)
                const geoResult = analyzeGeographicLocation(device);

                // Track validation statistics
                if (geoResult.validated) {
                    validatedCount++;
                    if (device.sheetName) sheetNameCount++;
                } else {
                    rejectedCount++;
                    if (device.sheetName) {
                        console.warn(`   ⚠️ VALIDATION FAILED despite sheet name: ${device.sheetName} - Device: ${device.deviceName}`);
                    }
                }

                // Check for state mismatches (device from one sheet assigned to different state)
                if (device.sheetName && geoResult.validated && geoResult.state) {
                    const sheetNameClean = device.sheetName
                        .replace(/_Tenant$/i, '')
                        .replace(/^node-list-/i, '')
                        .replace(/_/g, ' ')
                        .trim();

                    // Compare (ignoring spaces for compound names like NorthCarolina)
                    const sheetLower = sheetNameClean.toLowerCase().replace(/\s+/g, '');
                    const stateLower = geoResult.state.toLowerCase().replace(/\s+/g, '');

                    if (sheetLower !== stateLower &&
                        sheetNameClean !== 'Default' &&
                        sheetNameClean !== 'DCA Hosted Services' &&
                        sheetNameClean !== 'NRC' &&
                        sheetNameClean !== 'Antilles') {
                        mismatches.push({
                            device: device.deviceName,
                            sheet: sheetNameClean,
                            assigned: geoResult.state
                        });
                    }
                }

                // STEP 2: Only parse hostname for non-geographic data (HA, site type, etc.)
                // NEVER use hostname for geographic data
                const parsed = parseHostnameIntelligent(
                    device.deviceName || device.hostname,
                    '', // Don't pass system location to avoid geographic parsing
                    ''  // Don't pass IP to avoid geographic parsing
                );

                // STEP 2.5: Comprehensive device name parsing for model, location, site enrichment
                const comprehensive = parseDeviceNameComprehensive(device.deviceName || device.hostname || '');

                // STEP 2.6: Extract model number if not already populated
                const extractedModel = comprehensive.model || extractModelFromDeviceName(device.deviceName || '');

                // STEP 2.7: Build display region (use validated state, fallback to comprehensive parsing)
                let displayRegion = '';
                if (geoResult.validated && geoResult.state) {
                    // Use validated state for display
                    displayRegion = geoResult.city ? `${geoResult.city}, ${geoResult.state}` : geoResult.state;
                } else if (comprehensive.state) {
                    // Fallback to comprehensive parsing
                    displayRegion = comprehensive.city ? `${comprehensive.city}, ${comprehensive.state}` : comprehensive.state;
                }

                // STEP 3: Merge data with STRICT validation
                return {
                    ...device,
                    // Geographic data: ONLY from validated analysis (never from hostname)
                    country: geoResult.validated ? geoResult.country : (comprehensive.state ? 'US' : ''),
                    state: geoResult.validated ? geoResult.state : comprehensive.state,
                    stateCode: geoResult.validated ? geoResult.stateCode : comprehensive.stateCode,
                    city: geoResult.validated ? geoResult.city : comprehensive.city,

                    // World Region (US/EU/AP/LA)
                    worldRegion: geoResult.validated ? geoResult.worldRegion : '',

                    // Region field for display (replaces "Default")
                    region: displayRegion || device.region || '',

                    // Site type from comprehensive parsing (priority) or hostname parsing
                    siteType: comprehensive.siteType || device.siteType || parsed.siteType,

                    // Device role: comprehensive parsing (priority), then CSV, then parsed
                    deviceRole: comprehensive.deviceRole || device.deviceRole || parsed.deviceRole,

                    // Model: Use existing model, or extracted model, or comprehensive parsing
                    model: device.model || extractedModel || 'Unknown',

                    // HA data (from hostname parsing - not geographic)
                    haGroup: parsed.haGroup,
                    haRole: parsed.haRole,
                    isPrimary: parsed.isPrimary,
                    haPartner: parsed.haPartner,

                    // Computed fields
                    fullLocation: geoResult.validated ? [
                        geoResult.city,
                        geoResult.state,
                        geoResult.country
                    ].filter(x => x).join(', ') : (comprehensive.city || comprehensive.state ? [
                        comprehensive.city,
                        comprehensive.state,
                        'US'
                    ].filter(x => x).join(', ') : ''),

                    // Validation metadata
                    geoValidated: geoResult.validated || false,
                    geoConfidence: geoResult.confidence || 0
                };
            });

            // Print validation summary
            console.log(`\n📊 Geographic Validation Summary:`);
            console.log(`   ✅ Validated: ${validatedCount}/${devices.length} (${(validatedCount/devices.length*100).toFixed(1)}%)`);
            console.log(`   ❌ Rejected: ${rejectedCount}/${devices.length} (${(rejectedCount/devices.length*100).toFixed(1)}%)`);
            console.log(`   📄 From Sheet Names: ${sheetNameCount}/${validatedCount}`);

            if (mismatches.length > 0) {
                console.warn(`\n⚠️ STATE MISMATCHES DETECTED: ${mismatches.length} devices`);
                console.warn(`   Devices from one sheet assigned to different state!`);
                console.table(mismatches.slice(0, 20)); // Show first 20
                if (mismatches.length > 20) {
                    console.warn(`   ... and ${mismatches.length - 20} more mismatches`);
                }
            } else {
                console.log(`   ✅ No state mismatches - all devices assigned to correct sheet states`);
            }

            return enriched;
        }

        // Enhanced CSV Parser - Handles multiple column name variations
        function parseCSV(content) {
            // Pre-process: Check if hierarchical and flatten if needed
            content = preprocessHierarchicalCSV(content);

            const lines = content.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
            const data = [];

            console.log('📋 CSV Headers detected:', headers);

            // 🎯 Enterprise Smart Column Mapping - Handles 100+ column name variations
            // Order matters: more specific matches first!
            const columnMap = {
                // Basic fields
                region: findColumn(headers, ['region']),
                deviceName: findColumn(headers, ['device name', 'devicename', 'hostname', 'host', 'name', 'system name', 'systemname']),
                vendor: findColumn(headers, ['vendor', 'manufacturer', 'make']),
                deviceType: findColumn(headers, ['device type', 'devicetype', 'type', 'model type']),
                model: findColumn(headers, ['model', 'device model', 'product model', 'hardware model', 'model name']),
                siteType: findColumn(headers, ['site type', 'sitetype', 'site']),
                deviceRole: findColumn(headers, ['device role', 'devicerole', 'role']),
                sn: findColumn(headers, ['serial number', 'serialnumber', 'serial', 'sn', 'primary sn', 'primary serial']),
                hasHA: findColumn(headers, ['ha status', 'hastatus', 'ha configured', 'ha']),
                sn_ha1: findColumn(headers, ['ha serial 1', 'sn_ha1', 'ha sn 1', 'hasn1']),
                sn_ha2: findColumn(headers, ['ha serial 2', 'sn_ha2', 'ha sn 2', 'hasn2']),
                city: findColumn(headers, ['city', 'town']),
                state: findColumn(headers, ['state', 'province']),
                country: findColumn(headers, ['country', 'nation']),

                // Advanced fields for monitoring system integration (SolarWinds, Zabbix, PRTG, etc.)
                status: findColumn(headers, ['health status', 'device status', 'status']),
                administrativeState: findColumn(headers, ['administrative state', 'admin state', 'adminstate']),
                operationalState: findColumn(headers, ['operational state', 'oper state', 'operstate']),
                managedBy: findColumn(headers, ['managed by', 'managedby', 'manager id']),
                statusLastModified: findColumn(headers, ['status last modified', 'statuslastmodified', 'last status change']),
                stateLastModified: findColumn(headers, ['state last modified', 'statelastmodified', 'last state change']),
                firmwareVersion: findColumn(headers, ['firmware version', 'firmwareversion', 'firmware', 'fw version']),
                hardwareVersion: findColumn(headers, ['hardware version', 'hardwareversion', 'hw version']),
                softwareVersion: findColumn(headers, ['software version', 'softwareversion', 'sw version', 'os version']),
                componentIdentifier: findColumn(headers, ['component identifier', 'componentidentifier', 'component id']),
                deviceCategory: findColumn(headers, ['device category', 'devicecategory', 'category']),
                deviceVendor: findColumn(headers, ['device vendor', 'devicevendor', 'vendor id']),
                deviceFamily: findColumn(headers, ['device family', 'devicefamily', 'family', 'product family']),
                deviceProfile: findColumn(headers, ['device profile', 'deviceprofile', 'profile']),
                systemDescription: findColumn(headers, ['system description', 'systemdescription', 'sys description', 'sysdescr', 'description']),
                systemObjectID: findColumn(headers, ['system object id', 'systemobjectid', 'oid', 'snmp oid']),
                tenant: findColumn(headers, ['tenant name', 'tenant', 'organization']),
                managementIP: findColumn(headers, ['management address', 'managementaddress', 'management ip', 'ip address', 'ip']),
                snmpState: findColumn(headers, ['agent snmp state', 'snmp state', 'snmpstate']),
                icmpState: findColumn(headers, ['management address icmp state', 'icmp state', 'icmpstate', 'ping state']),
                managementMode: findColumn(headers, ['node management mode', 'management mode', 'managementmode']),
                discoveryState: findColumn(headers, ['discovery state', 'discoverystate']),
                systemLocation: findColumn(headers, ['system location', 'systemlocation', 'location']),
                systemContact: findColumn(headers, ['system contact', 'systemcontact', 'contact'])
            };

            console.log('🗺️ Column mapping:', {
                'Device Name': columnMap.deviceName,
                'Model': columnMap.model,
                'Serial Number': columnMap.sn,
                'Vendor': columnMap.vendor,
                'Type': columnMap.deviceType
            });

            // Enhanced debugging: show which header matched to which column
            console.log('🗺️ Column details:', {
                'Model column index': columnMap.model,
                'Model header': columnMap.model !== -1 ? headers[columnMap.model] : 'NOT FOUND',
                'SN column index': columnMap.sn,
                'SN header': columnMap.sn !== -1 ? headers[columnMap.sn] : 'NOT FOUND'
            });

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.split(',').every(v => !v.trim())) continue; // Skip empty lines

                // Enhanced CSV parsing (handles quoted values and commas inside quotes)
                const values = parseCSVLine(line);

                // 🔍 Build device object with intelligent field extraction
                const rawModel = getValue(values, columnMap.model);
                const rawSN = getValue(values, columnMap.sn);
                const rawDeviceName = getValue(values, columnMap.deviceName);

                // 🚫 FILTER OUT NOISE: Skip pseudo/virtual entries
                if (rawDeviceName && (
                    rawDeviceName.toLowerCase().includes('pseudo chassis') ||
                    rawModel.toLowerCase() === 'vdom' ||
                    rawDeviceName === '-1'
                )) {
                    continue; // Skip this row
                }

                // Extract all raw values first
                const rawDeviceVendor = getValue(values, columnMap.deviceVendor) || '';
                const rawDeviceCategory = getValue(values, columnMap.deviceCategory) || '';
                const rawDeviceProfile = getValue(values, columnMap.deviceProfile) || '';
                const rawVendor = getValue(values, columnMap.vendor) || '';
                const rawDeviceType = getValue(values, columnMap.deviceType) || '';
                const rawSystemDescription = getValue(values, columnMap.systemDescription) || '';
                const rawFirmwareVersion = getValue(values, columnMap.firmwareVersion) || '';
                const rawSoftwareVersion = getValue(values, columnMap.softwareVersion) || '';

                // 🎯 INTELLIGENT FIELD FALLBACK LOGIC
                // Use Device Vendor if Vendor is empty
                const finalVendor = rawVendor || rawDeviceVendor;

                // Use Device Category if Device Type is empty
                const finalDeviceType = rawDeviceType || rawDeviceCategory;

                // Use Device Profile if Model is empty (common in NMS exports)
                const finalModel = rawModel || rawDeviceProfile;

                // Extract firmware version from System Description if not explicitly provided
                let finalFirmwareVersion = rawFirmwareVersion || rawSoftwareVersion;
                if (!finalFirmwareVersion && rawSystemDescription) {
                    const versionMatch = rawSystemDescription.match(/Version\s+([\d\.]+[a-zA-Z0-9\-\(\)]+)/i);
                    if (versionMatch) {
                        finalFirmwareVersion = versionMatch[1];
                    }
                }

                // Map Device Category to Device Role (use CSV data FIRST)
                const categoryToRole = {
                    'Firewall': 'Firewall',
                    'Router': 'Router',
                    'Switch': 'Switch',
                    'Switch-Router': 'Switch',
                    'Load Balancer': 'Load Balancer',
                    'Server': 'Server',
                    'Computer': 'Server'
                };

                const derivedRole = categoryToRole[rawDeviceCategory] || getValue(values, columnMap.deviceRole) || '';

                const device = {
                    // Basic fields with intelligent fallbacks
                    region: getValue(values, columnMap.region) || 'US',
                    deviceName: getValue(values, columnMap.deviceName) || `Device-${i}`,
                    vendor: finalVendor,
                    deviceType: finalDeviceType,
                    model: finalModel,
                    series: finalModel,
                    siteType: getValue(values, columnMap.siteType) || '',
                    deviceRole: derivedRole,
                    sn: rawSN || '',
                    hasHA: parseBoolean(getValue(values, columnMap.hasHA)),
                    sn_ha1: getValue(values, columnMap.sn_ha1) || '',
                    sn_ha2: getValue(values, columnMap.sn_ha2) || '',
                    city: getValue(values, columnMap.city) || '',
                    state: getValue(values, columnMap.state) || '', // Column mapper now excludes timestamp columns
                    country: getValue(values, columnMap.country) || '',

                    // NOC-Critical Fields (for health monitoring and troubleshooting)
                    status: getValue(values, columnMap.status) || 'UNKNOWN',
                    administrativeState: getValue(values, columnMap.administrativeState) || '',
                    operationalState: getValue(values, columnMap.operationalState) || '',
                    managedBy: getValue(values, columnMap.managedBy) || '',
                    statusLastModified: getValue(values, columnMap.statusLastModified) || '',
                    stateLastModified: getValue(values, columnMap.stateLastModified) || '',
                    firmwareVersion: finalFirmwareVersion,
                    hardwareVersion: getValue(values, columnMap.hardwareVersion) || '',
                    softwareVersion: finalFirmwareVersion, // Use extracted version as fallback
                    componentIdentifier: getValue(values, columnMap.componentIdentifier) || '',

                    // Advanced fields for monitoring integration (captured for intelligent parsing)
                    deviceCategory: rawDeviceCategory,
                    deviceVendor: rawDeviceVendor,
                    deviceFamily: getValue(values, columnMap.deviceFamily) || '',
                    deviceProfile: rawDeviceProfile,
                    systemDescription: rawSystemDescription,
                    systemObjectID: getValue(values, columnMap.systemObjectID) || '',
                    tenant: getValue(values, columnMap.tenant) || 'Default Tenant',
                    managementIP: getValue(values, columnMap.managementIP) || '',
                    snmpState: getValue(values, columnMap.snmpState) || 'UNKNOWN',
                    icmpState: getValue(values, columnMap.icmpState) || 'UNKNOWN',
                    managementMode: getValue(values, columnMap.managementMode) || 'UNKNOWN',
                    discoveryState: getValue(values, columnMap.discoveryState) || 'UNKNOWN',
                    systemLocation: getValue(values, columnMap.systemLocation) || '',
                    systemContact: getValue(values, columnMap.systemContact) || ''
                };

                // 🚨 CRITICAL DEBUG: First 3 devices from CSV (RAW DATA)
                if (i <= 3) {
                    console.group(`🔍 CSV ROW ${i}: ${device.deviceName}`);
                    console.log('📋 RAW CSV VALUES (all columns):', values);
                    console.log('📊 EXTRACTED FIELDS:', {
                        deviceName: device.deviceName,
                        vendor: device.vendor || '(EMPTY)',
                        model: device.model || '(EMPTY)',
                        sn: device.sn || '(EMPTY)',
                        deviceVendor: device.deviceVendor || '(EMPTY)',
                        deviceFamily: device.deviceFamily || '(EMPTY)',
                        deviceProfile: device.deviceProfile || '(EMPTY)',
                        systemDescription: device.systemDescription ?
                            device.systemDescription.substring(0, 200) : '(EMPTY)'
                    });
                    console.log('🗺️ COLUMN MAPPING:', {
                        'model column index': columnMap.model,
                        'sn column index': columnMap.sn,
                        'deviceFamily index': columnMap.deviceFamily,
                        'deviceProfile index': columnMap.deviceProfile,
                        'systemDescription index': columnMap.systemDescription
                    });
                    console.groupEnd();
                }

                data.push(device);
            }

            // Final debug: Show first 3 parsed devices
            console.log('✅ parseCSV complete - First 3 devices:', data.slice(0, 3).map(d => ({
                deviceName: d.deviceName,
                model: d.model,
                sn: d.sn,
                vendor: d.vendor
            })));

            // 🧠 Apply intelligent hostname parsing to enrich data
            const enrichedData = enrichDeviceDataWithIntelligence(data);
            console.log(`🧠 Intelligent parsing complete - Enriched ${enrichedData.length} devices`);

            return enrichedData;
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // 🏆 ENTERPRISE-GRADE INTELLIGENT DATA EXTRACTION SYSTEM
        // ═══════════════════════════════════════════════════════════════════════════════

        // Helper: Find column index by multiple possible names
        // First tries exact matches, then falls back to partial matches
        function findColumn(headers, possibleNames) {
            // First pass: exact matches only
            for (const name of possibleNames) {
                const index = headers.findIndex(h => h === name.toLowerCase());
                if (index !== -1) return index;
            }
            // Second pass: partial matches (contains) - with strict exclusions
            for (const name of possibleNames) {
                const index = headers.findIndex(h => {
                    // Avoid matching boolean/HA columns for text fields
                    if (h.includes('ha ') || h.includes('configured')) {
                        return false;
                    }
                    // CRITICAL FIX: Prevent "State Last Modified" from matching geographic "state"
                    // Geographic state should NEVER match timestamp/status columns
                    if (name.toLowerCase() === 'state' || name.toLowerCase() === 'province') {
                        if (h.includes('modified') || h.includes('last') ||
                            h.includes('admin') || h.includes('oper') || h.includes('discovery') ||
                            h.includes('icmp') || h.includes('snmp') || h.includes('agent')) {
                            return false;
                        }
                    }
                    // CRITICAL FIX: Prevent "IP Discovery Time" from matching "ip address" or "ip"
                    // IP address should NEVER match timestamp/date columns
                    if (name.toLowerCase().includes('ip') || name.toLowerCase().includes('address')) {
                        // Exclude any column with these timestamp-related terms
                        if (h.includes('modified') || h.includes('last') || h.includes('time') ||
                            h.includes('date') || h.includes('discovery') || h.includes('learned') ||
                            h.includes('first') || h.includes('updated') || h.includes('changed') ||
                            h.includes('timestamp') || h.includes('scan') || h.includes('added') ||
                            h.includes('created') || h.includes('when') || h.includes('aging')) {
                            return false;
                        }
                        // Also exclude if column starts with "ip" but has timestamp keywords
                        // e.g., "IP Discovery Time", "IP Last Modified", "IP Aging Time"
                        if (h.startsWith('ip ') && (h.includes('time') || h.includes('date') ||
                            h.includes('modified') || h.includes('discovered') || h.includes('learned'))) {
                            return false;
                        }
                    }
                    // For non-state fields, exclude status columns unless explicitly looking for status
                    if (h.includes('status') && !name.toLowerCase().includes('status')) {
                        return false;
                    }
                    return h.includes(name.toLowerCase());
                });
                if (index !== -1) return index;
            }
            return -1;
        }

        // ═══════════════════════════════════════════════════════════════════════════════
        // 🚨 NOC ANALYTICS & INTELLIGENCE FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════════════

        // 📊 Calculate health score (0-100) based on device status
        function calculateHealthScore(device) {
            let score = 0;

            // Base status scoring (50 points max)
            if (device.status === 'NORMAL') score += 50;
            else if (device.status === 'MINOR') score += 40;
            else if (device.status === 'UNKNOWN') score += 25;
            else if (device.status === 'CRITICAL') score += 0;

            // Operational state (20 points max)
            if (device.operationalState === 'UP') score += 20;
            else if (device.operationalState === 'NO_POLLING_POLICY') score += 10;

            // ICMP reachability (15 points max) - if available
            if (device.icmpState === 'RESPONDING') score += 15;
            else if (device.icmpState === 'NOT_POLLED') score += 7;

            // Management state (10 points max)
            if (device.managementMode === 'MANAGED') score += 10;
            else if (device.managedBy && device.managedBy !== '') score += 10;

            // Firmware presence (5 points max)
            if (device.firmwareVersion && device.firmwareVersion !== '') score += 5;

            return score;
        }

        // 🔌 Extract port count from model name
        function extractPortCount(model) {
            if (!model) return null;

            // Cisco patterns: WS-C3850-48T, WS-C2960X-24TS, Catalyst 3850-48
            const ciscoMatch = model.match(/[-\s](\d{2,3})[PTX-]/i);
            if (ciscoMatch) return parseInt(ciscoMatch[1]);

            // Juniper patterns: ex3300-48p, ex3200-24t
            const juniperMatch = model.match(/[-\s](\d{2})[pt]/i);
            if (juniperMatch) return parseInt(juniperMatch[1]);

            // Generic pattern: any model with port count
            const genericMatch = model.match(/[-\s](\d{2,3})(?:port|p|t)/i);
            if (genericMatch) return parseInt(genericMatch[1]);

            return null;
        }

        // 📅 Calculate device age from serial number
        function calculateDeviceAge(serial) {
            if (!serial) return null;

            // Cisco format: [Site][YY][WW][Sequence]
            // Example: FTX1416AKXH = FTX (Foxconn) + 14 (2014) + 16 (Week 16)
            const ciscoMatch = serial.match(/^([A-Z]{3})(\d{2})(\d{2})/);
            if (ciscoMatch) {
                const yearCode = parseInt(ciscoMatch[2]);
                const week = parseInt(ciscoMatch[3]);

                // Handle year 2000+ format (14 = 2014, 98 = 1998, etc.)
                // Assume serials with YY < 90 are 2000+, otherwise 1900+
                const year = yearCode < 90 ? 2000 + yearCode : 1900 + yearCode;

                // Calculate approximate manufacturing date (week * 7 days)
                const mfgDate = new Date(year, 0, 1 + (week * 7));
                const ageMs = Date.now() - mfgDate.getTime();
                const ageYears = ageMs / (1000 * 60 * 60 * 24 * 365.25);

                return {
                    manufacturingDate: mfgDate,
                    ageYears: Math.floor(ageYears),
                    ageMonths: Math.floor(ageYears * 12),
                    ageInDays: Math.floor(ageMs / (1000 * 60 * 60 * 24))
                };
            }

            // Juniper format: GB0213294010 (less standardized, but GB02 might indicate year)
            const juniperMatch = serial.match(/^([A-Z]{2})(\d{2})(\d{2})/);
            if (juniperMatch) {
                const yearCode = parseInt(juniperMatch[2]);
                const monthCode = parseInt(juniperMatch[3]);

                if (yearCode >= 0 && yearCode <= 30 && monthCode >= 1 && monthCode <= 53) {
                    const year = yearCode < 90 ? 2000 + yearCode : 1900 + yearCode;
                    const mfgDate = new Date(year, 0, 1 + (monthCode * 7));
                    const ageMs = Date.now() - mfgDate.getTime();
                    const ageYears = ageMs / (1000 * 60 * 60 * 24 * 365.25);

                    return {
                        manufacturingDate: mfgDate,
                        ageYears: Math.floor(ageYears),
                        ageMonths: Math.floor(ageYears * 12),
                        ageInDays: Math.floor(ageMs / (1000 * 60 * 60 * 24)),
                        confidence: 0.75  // Lower confidence for Juniper
                    };
                }
            }

            return null;
        }

        // 🚨 Detect if device is critical or offline
        function isCriticalDevice(device) {
            // Critical conditions
            if (device.status === 'CRITICAL') return true;
            if (device.operationalState === 'DOWN') return true;
            if (device.operationalState === 'NOT_RESPONDING') return true;
            if (device.icmpState === 'NOT_RESPONDING') return true;

            // Health score < 50
            const healthScore = calculateHealthScore(device);
            if (healthScore < 50) return true;

            return false;
        }

        // ⚠️ Detect if device is offline
        function isOfflineDevice(device) {
            if (device.operationalState === 'DOWN') return true;
            if (device.operationalState === 'NOT_RESPONDING') return true;
            if (device.administrativeState === 'NOT_POLLED') return true;
            return false;
        }

        // 📍 Calculate days since last seen
        function calculateDaysSinceLastSeen(lastModified) {
            if (!lastModified) return null;

            try {
                const lastSeenDate = new Date(lastModified);
                const nowDate = new Date();
                const diffMs = nowDate - lastSeenDate;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                return diffDays;
            } catch (e) {
                return null;
            }
        }

        // 🔬 Extract model from hostname (e.g., "AUSDCA2851RTR3" -> "2851")
        function extractModelFromHostname(hostname) {
            if (!hostname) return null;

            const name = hostname.toUpperCase();

            // Cisco router patterns in hostname
            // Examples: AUSDCA2811VXMLGW5, AUSDCA2851RTR3, AUSDCA3845RTR1, AUSDCA7206RTR2
            const ciscoRouterMatch = name.match(/(28\d{2}|38\d{2}|72\d{2})/);  // 2800, 3800, 7200 series
            if (ciscoRouterMatch) {
                return {
                    vendor: 'Cisco',
                    model: `C${ciscoRouterMatch[1]}`,
                    series: ciscoRouterMatch[1],
                    confidence: 0.88
                };
            }

            // Cisco Catalyst Switch patterns in hostname
            // Examples: AUSDCA3850SW1, AUSDCA6506SW7, AUSDCA6513SW1, AUSDCADMZ2950SW8
            const ciscoCatalystMatch = name.match(/(3850|6506|6513|2950|2960|3560|3750|4500|6500)/);
            if (ciscoCatalystMatch) {
                return {
                    vendor: 'Cisco',
                    model: `Catalyst ${ciscoCatalystMatch[1]}`,
                    series: `Cat${ciscoCatalystMatch[1]}`,
                    confidence: 0.88
                };
            }

            // Cisco PIX patterns in hostname
            // Example: AUSDCAINT515PIX1
            const pixMatch = name.match(/(\d{3,4})PIX/);
            if (pixMatch) {
                return {
                    vendor: 'Cisco',
                    model: `PIX ${pixMatch[1]}`,
                    series: `PIX-${pixMatch[1]}`,
                    confidence: 0.92
                };
            }

            // Fortinet patterns in hostname (FW suffix often indicates FortiGate)
            // Examples: Abilene_CC_FW, Amarillo_CC_FW
            if (name.includes('_FW') || name.includes('-FW')) {
                return {
                    vendor: 'Fortinet',  // Will be refined by OID or System Description
                    model: 'Firewall',
                    series: 'FW',
                    confidence: 0.70
                };
            }

            return null;
        }

        // 🔬 Advanced Pattern Recognition: Extract model from system description
        function extractModelFromDescription(description) {
            if (!description) return null;

            const desc = description.trim();

            // APC UPS patterns - PRIORITY #1 (for your data!)
            // Format: "APC Web/SNMP Management Card ... MN:AP9641 HR:5 SN: 5A2212T86184"
            const apcMatch = desc.match(/\bAPC\b/i);
            if (apcMatch) {
                // Extract model from MN: field (Model Number)
                const modelMatch = desc.match(/\bMN:\s*([A-Z0-9]+)/i);
                if (modelMatch) {
                    return {
                        vendor: 'APC',
                        model: modelMatch[1],  // e.g., AP9641
                        series: modelMatch[1],
                        confidence: 0.98
                    };
                }
                // Fallback: look for "Smart-UPS" or other APC product names
                const productMatch = desc.match(/APC\s+(Smart-UPS|Back-UPS|Symmetra)[\s-]?(\w+)?/i);
                if (productMatch) {
                    const model = productMatch[2] ? `${productMatch[1]} ${productMatch[2]}` : productMatch[1];
                    return {
                        vendor: 'APC',
                        model: model,
                        series: model,
                        confidence: 0.95
                    };
                }
                // Generic APC detection
                return {
                    vendor: 'APC',
                    model: 'UPS',
                    series: 'UPS',
                    confidence: 0.85
                };
            }

            // Fortinet patterns
            const fortinetMatch = desc.match(/FortiGate[- ]?(\w+[-\w]*)/i) ||
                                 desc.match(/FGT[- ]?(\w+)/i) ||
                                 desc.match(/FG(\d{2,4}[A-Z]?)/i);
            if (fortinetMatch) {
                return {
                    vendor: 'Fortinet',
                    model: fortinetMatch[1] ? `FGT${fortinetMatch[1]}` : fortinetMatch[0],
                    series: fortinetMatch[1] || fortinetMatch[0],
                    confidence: 0.95
                };
            }

            // Palo Alto patterns
            const paloAltoMatch = desc.match(/PA[-\s]?(\d{3,4})/i) ||
                                 desc.match(/Palo Alto.*?(\d{3,4})/i);
            if (paloAltoMatch) {
                return {
                    vendor: 'Palo Alto Networks',
                    model: `PA-${paloAltoMatch[1]}`,
                    series: `PA-${paloAltoMatch[1]}`,
                    confidence: 0.95
                };
            }

            // Cisco PIX Firewall patterns
            const ciscoPIXMatch = desc.match(/Cisco\s+PIX\s+Firewall/i);
            if (ciscoPIXMatch) {
                // Try to extract model from description
                const pixModel = desc.match(/PIX\s+(\d{3,4})/i);
                if (pixModel) {
                    return {
                        vendor: 'Cisco',
                        model: `PIX ${pixModel[1]}`,
                        series: `PIX-${pixModel[1]}`,
                        confidence: 0.95
                    };
                }
                return {
                    vendor: 'Cisco',
                    model: 'PIX Firewall',
                    series: 'PIX',
                    confidence: 0.90
                };
            }

            // Cisco IOS Router patterns - ENHANCED for your data
            // Format: "Cisco IOS Software, 2800 Software (C2800NM-IPVOICEK9-M)"
            const ciscoIOSMatch = desc.match(/Cisco\s+IOS\s+Software/i);
            if (ciscoIOSMatch) {
                // Try to extract model from software image name (most accurate)
                const imageMatch = desc.match(/\(([A-Z0-9]+)[-_]/i);  // e.g., (C2800NM-...) or (C3845-...)
                if (imageMatch) {
                    const model = imageMatch[1];
                    return {
                        vendor: 'Cisco',
                        model: model,
                        series: model,
                        confidence: 0.95
                    };
                }

                // Fallback: Extract from software description
                const seriesMatch = desc.match(/(\d{4})\s+Software/i);  // e.g., "2800 Software"
                if (seriesMatch) {
                    return {
                        vendor: 'Cisco',
                        model: `Cisco ${seriesMatch[1]}`,
                        series: seriesMatch[1],
                        confidence: 0.85
                    };
                }

                return {
                    vendor: 'Cisco',
                    model: 'IOS Router',
                    series: 'IOS',
                    confidence: 0.75
                };
            }

            // Cisco Catalyst Switch patterns - ENHANCED
            // Format: "Catalyst L3 Switch Software (CAT3K_CAA-UNIVERSALK9-M)"
            const ciscoCatalystMatch = desc.match(/Catalyst/i);
            if (ciscoCatalystMatch) {
                // Try to extract model from image name
                const catImageMatch = desc.match(/\(CAT([0-9K]+)[_-]/i);  // e.g., (CAT3K_...)
                if (catImageMatch) {
                    const model = catImageMatch[1].replace('K', '000');  // 3K -> 3000
                    return {
                        vendor: 'Cisco',
                        model: `Catalyst ${model}`,
                        series: `Cat${model}`,
                        confidence: 0.92
                    };
                }

                // Fallback: generic catalyst
                return {
                    vendor: 'Cisco',
                    model: 'Catalyst Switch',
                    series: 'Catalyst',
                    confidence: 0.80
                };
            }

            // Cisco Internetwork Operating System (older format)
            const ciscoInternetworkMatch = desc.match(/Cisco\s+Internetwork\s+Operating\s+System/i);
            if (ciscoInternetworkMatch) {
                // Try to extract from software type
                const softwareMatch = desc.match(/\(([a-z0-9_]+)-/i);
                if (softwareMatch) {
                    return {
                        vendor: 'Cisco',
                        model: softwareMatch[1].toUpperCase(),
                        series: softwareMatch[1].toUpperCase(),
                        confidence: 0.85
                    };
                }
                return {
                    vendor: 'Cisco',
                    model: 'Cisco IOS',
                    series: 'IOS',
                    confidence: 0.75
                };
            }

            // Juniper patterns - ENHANCED for your CSV format
            // Format: "ex3300-48p", "ex3200-24t", etc.
            const juniperMatch = desc.match(/\b(ex|srx|mx)(\d{4})[-\s]?(\w+)?/i);
            if (juniperMatch) {
                const prefix = juniperMatch[1].toUpperCase();
                const model = juniperMatch[2];
                const variant = juniperMatch[3] ? `-${juniperMatch[3]}` : '';
                return {
                    vendor: 'Juniper Networks',
                    model: `${prefix}${model}${variant}`,
                    series: `${prefix}${model}`,
                    confidence: 0.95
                };
            }

            // FPC (Flexible PIC Concentrator) detection for Juniper
            if (desc.match(/FPC\s+\d/i)) {
                return {
                    vendor: 'Juniper Networks',
                    model: 'Switch Module',
                    series: 'EX',
                    confidence: 0.85
                };
            }

            // HP/Aruba patterns
            const hpArubaMatch = desc.match(/(?:HPE?|Aruba).*?(\d{4})/i);
            if (hpArubaMatch) {
                return {
                    vendor: 'HPE/Aruba',
                    model: hpArubaMatch[1],
                    series: hpArubaMatch[1],
                    confidence: 0.85
                };
            }

            return null;
        }

        // 🔬 Advanced Serial Number Extraction from System Description - ENHANCED
        function extractSerialFromDescription(description) {
            if (!description) return null;

            const desc = description.trim();

            // Priority 1: Explicit serial labels (highest confidence)
            const explicitPatterns = [
                /\bS\/N[:\s]*([A-Z0-9]{6,20})\b/i,
                /\bSerial\s*(?:Number|#)?[:\s]*([A-Z0-9]{6,20})\b/i,
                /\bSN[:\s]+([A-Z0-9]{6,20})\b/i,
                /\bSerial[:\s]+([A-Z0-9]{6,20})\b/i
            ];

            for (const pattern of explicitPatterns) {
                const match = desc.match(pattern);
                if (match && match[1]) {
                    // Verify it's not a model number or version
                    const serial = match[1].trim();
                    if (!serial.match(/^v?\d+\.\d+/i) && !serial.match(/^build/i)) {
                        return {
                            serial: serial,
                            confidence: 0.95
                        };
                    }
                }
            }

            // Priority 2: Vendor-specific serial patterns
            const vendorPatterns = [
                /\b(FGT?[A-Z0-9]{10,18})\b/i,  // Fortinet: FG or FGT followed by alphanumeric
                /\b(PA[A-Z0-9]{10,18})\b/i,    // Palo Alto: PA followed by alphanumeric
                /\b(JAD[A-Z0-9]{8,15})\b/i,    // Cisco ASA: JAD prefix
                /\b(FCH[A-Z0-9]{8,15})\b/i,    // Cisco: FCH prefix
                /\b(JW[A-Z0-9]{8,15})\b/i,     // HP/Aruba: JW prefix
                /\b([A-Z]{2}\d{10,})\b/,       // Generic: 2 letters + 10+ digits
            ];

            for (const pattern of vendorPatterns) {
                const match = desc.match(pattern);
                if (match && match[1]) {
                    const serial = match[1].trim();
                    // Additional validation: not a model number
                    if (serial.length >= 10 && !serial.match(/^(FGT|PA|ASA|SRX)\d{1,4}$/i)) {
                        return {
                            serial: serial,
                            confidence: 0.85
                        };
                    }
                }
            }

            // Priority 3: Generic alphanumeric patterns (12+ chars, mixed case/numbers)
            const genericPattern = /\b([A-Z]{2,4}[A-Z0-9]{10,18})\b/i;
            const genericMatch = desc.match(genericPattern);
            if (genericMatch && genericMatch[1]) {
                const serial = genericMatch[1].trim();
                // Validate: has both letters and numbers, minimum length
                if (serial.match(/[A-Z]/i) && serial.match(/[0-9]/) && serial.length >= 10) {
                    return {
                        serial: serial,
                        confidence: 0.75
                    };
                }
            }

            return null;
        }

        // 🧠 Intelligent Vendor Detection from Multiple Sources
        function detectVendorIntelligent(device) {
            // Priority 1: System description parsing (MOVED UP - most reliable!)
            if (device.systemDescription && device.systemDescription.length > 10) {
                const extracted = extractModelFromDescription(device.systemDescription);
                if (extracted) {
                    return { vendor: extracted.vendor, confidence: extracted.confidence, source: 'system_description' };
                }
            }

            // Priority 2: Explicit vendor field (but validate it's not a number)
            if (device.vendor && device.vendor !== '' && device.vendor !== 'Unknown') {
                // Reject pure numeric values (database IDs)
                if (!device.vendor.match(/^\d+$/)) {
                    return { vendor: device.vendor, confidence: 1.0, source: 'csv_vendor_column' };
                }
            }

            // Priority 3: Device Vendor field (from monitoring systems - but validate!)
            if (device.deviceVendor && device.deviceVendor !== '') {
                // Reject pure numeric values (database IDs like "1924")
                if (!device.deviceVendor.match(/^\d+$/)) {
                    return { vendor: device.deviceVendor, confidence: 0.95, source: 'device_vendor_field' };
                }
            }

            // Priority 4: Serial number pattern analysis
            if (device.sn) {
                const snAnalysis = detectDeviceInfo({ sn: device.sn });
                if (snAnalysis.vendor && snAnalysis.vendor !== 'Unknown') {
                    return { vendor: snAnalysis.vendor, confidence: 0.80, source: 'serial_pattern' };
                }
            }

            // Priority 5: Device name pattern analysis
            if (device.deviceName) {
                const name = device.deviceName.toUpperCase();
                if (name.includes('FW-') || name.includes('FGT') || name.includes('FORTI')) {
                    return { vendor: 'Fortinet', confidence: 0.70, source: 'device_name' };
                }
                if (name.includes('PA-') || name.includes('PALO')) {
                    return { vendor: 'Palo Alto Networks', confidence: 0.70, source: 'device_name' };
                }
                if (name.includes('ASA') || name.includes('CISCO')) {
                    return { vendor: 'Cisco', confidence: 0.70, source: 'device_name' };
                }
                if (name.includes('SRX') || name.includes('JUNIPER')) {
                    return { vendor: 'Juniper Networks', confidence: 0.70, source: 'device_name' };
                }
            }

            return { vendor: 'Unknown', confidence: 0.0, source: 'none' };
        }

        // 🧠 Intelligent Model Detection from Multiple Sources - OPTIMIZED
        function detectModelIntelligent(device) {
            // Priority 1: Explicit model field (but validate it's not just a number)
            if (device.model && device.model !== '' && device.model !== 'Unknown') {
                // Check if it's a meaningful model (not just a number like "60" or "100")
                if (device.model.match(/[A-Za-z]/)) {
                    return { model: device.model, series: device.model, confidence: 1.0, source: 'csv_model_column' };
                }
            }

            // Priority 2: System description parsing (MOST POWERFUL - moved up!)
            if (device.systemDescription && device.systemDescription.length > 10) {
                const extracted = extractModelFromDescription(device.systemDescription);
                if (extracted) {
                    return {
                        model: extracted.model,
                        series: extracted.series,
                        confidence: extracted.confidence,
                        source: 'system_description_parsed'
                    };
                }
            }

            // Priority 2.5: Hostname-based extraction (VERY POWERFUL for Cisco!)
            // For devices where System Description doesn't have enough info
            if (device.deviceName) {
                const hostnameExtracted = extractModelFromHostname(device.deviceName);
                if (hostnameExtracted) {
                    return {
                        model: hostnameExtracted.model,
                        series: hostnameExtracted.series,
                        confidence: hostnameExtracted.confidence,
                        source: 'hostname_parsed'
                    };
                }
            }

            // Priority 3: Combine Device Family + Device Profile for better results
            // BUT: Skip if they're numeric-only (database IDs, not real model info)
            if (device.deviceFamily && device.deviceProfile) {
                const family = device.deviceFamily.trim();
                const profile = device.deviceProfile.trim();

                // VALIDATION: Skip if both are pure numbers (they're database IDs!)
                const familyIsNumeric = family.match(/^\d+$/);
                const profileIsNumeric = profile.match(/^\d+$/);

                if (!familyIsNumeric && !profileIsNumeric) {
                    // Check if profile is just a number or model suffix
                    if (profile.match(/^\d+[A-Z]?$/i) || profile.match(/^[-\s]\d+/)) {
                        // Combine: e.g., "FortiGate" + "60F" = "FortiGate-60F"
                        const combined = `${family}-${profile}`.replace(/\s+/g, '-');
                        return { model: combined, series: combined, confidence: 0.90, source: 'device_family_profile_combined' };
                    } else if (!familyIsNumeric) {
                        // Use family or profile if meaningful
                        const useField = family.match(/[A-Za-z]/) ? family : profile;
                        return { model: useField, series: useField, confidence: 0.85, source: 'device_profile' };
                    }
                }
            }

            // Priority 4: Device Family field (from monitoring systems)
            // VALIDATION: Must contain letters, not just numbers
            if (device.deviceFamily && device.deviceFamily !== '') {
                const family = device.deviceFamily.trim();
                // Reject pure numbers and require meaningful content
                if (!family.match(/^\d+$/) && family.length > 2 && family.match(/[A-Za-z]/)) {
                    return { model: family, series: family, confidence: 0.80, source: 'device_family' };
                }
            }

            // Priority 5: Device Profile field
            // VALIDATION: Must contain letters, not just numbers
            if (device.deviceProfile && device.deviceProfile !== '') {
                const profile = device.deviceProfile.trim();
                // Reject pure numbers
                if (!profile.match(/^\d+$/) && profile.length > 1 && profile.match(/[A-Za-z]/)) {
                    return { model: profile, series: profile, confidence: 0.75, source: 'device_profile' };
                }
            }

            // Priority 6: Try to build model from vendor + any numeric field
            if (device.vendor && device.vendor !== 'Unknown') {
                // Check if model field has a number we can use
                if (device.model && device.model.match(/^\d+[A-Z]?$/)) {
                    const fullModel = `${device.vendor} ${device.model}`;
                    return { model: fullModel, series: device.model, confidence: 0.70, source: 'vendor_model_combined' };
                }
            }

            // Priority 7: Serial number analysis
            if (device.sn && device.sn.length >= 8) {
                const snAnalysis = detectDeviceInfo({ sn: device.sn });
                if (snAnalysis.model && snAnalysis.model !== 'Unknown') {
                    return {
                        model: snAnalysis.model,
                        series: snAnalysis.series,
                        confidence: 0.65,
                        source: 'serial_pattern'
                    };
                }
            }

            return { model: 'Unknown', series: 'Unknown', confidence: 0.0, source: 'none' };
        }

        // 🧠 Intelligent Serial Number Detection from Multiple Sources
        function detectSerialIntelligent(device) {
            // Priority 1: Explicit serial number field
            if (device.sn && device.sn !== '' && device.sn !== '-') {
                return { serial: device.sn, confidence: 1.0, source: 'csv_sn_column' };
            }

            // Priority 2: System description parsing
            if (device.systemDescription) {
                const extracted = extractSerialFromDescription(device.systemDescription);
                if (extracted) {
                    return {
                        serial: extracted.serial,
                        confidence: extracted.confidence,
                        source: 'system_description_parsed'
                    };
                }
            }

            // Priority 3: Look in device name (sometimes SNs are in hostnames)
            if (device.deviceName) {
                const snMatch = device.deviceName.match(/[A-Z]{2,3}\d{8,}[A-Z0-9]*/);
                if (snMatch) {
                    return { serial: snMatch[0], confidence: 0.60, source: 'device_name_extracted' };
                }
            }

            return { serial: '', confidence: 0.0, source: 'none' };
        }

        // Helper: Get value from array by index
        function getValue(values, index) {
            if (index === -1 || index >= values.length) return '';
            const value = values[index].trim().replace(/^"|"$/g, '');
            // Filter out boolean-like values that shouldn't be in text fields
            if (value.toLowerCase() === 'true' || value.toLowerCase() === 'false') {
                return '';
            }
            return value;
        }

        // Helper: Parse boolean from various formats
        function parseBoolean(value) {
            if (!value) return false;
            const v = value.toLowerCase().trim();
            return v === 'true' || v === 'yes' || v === '1' || v === 'ha configured' || v === 'enabled';
        }

        // Helper: Parse a single CSV line handling quotes properly
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;

            for (let j = 0; j < line.length; j++) {
                const char = line[j];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current);
            return values;
        }

        // Parse JSON content
        function parseJSON(content) {
            const json = JSON.parse(content);
            if (!Array.isArray(json)) {
                throw new Error('JSON must be an array of devices');
            }

            return json.map(item => ({
                region: item.region || item.Region || '',
                deviceName: item.deviceName || item['Device Name'] || item.device_name || '',
                model: item.model || item.Model || detectModel(item.sn || item.serialNumber),
                sn: item.sn || item.serialNumber || item['Serial Number'] || '',
                hasHA: item.hasHA || item.haConfigured || item['HA Status'] === 'HA Configured' || false,
                sn_ha1: item.sn_ha1 || item.haSerial1 || item['HA Serial 1'] || '',
                sn_ha2: item.sn_ha2 || item.haSerial2 || item['HA Serial 2'] || ''
            }));
        }

        // Parse Excel (XLSX/XLS) files
        function parseXLSX(arrayBuffer) {
            try {
                console.log('📊 Parsing Excel file...');

                // Check if XLSX library is loaded
                if (typeof XLSX === 'undefined') {
                    throw new Error('Excel library not loaded. Please refresh the page and try again.');
                }

                // Read the workbook
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                console.log(`📚 Excel file contains ${workbook.SheetNames.length} sheets:`, workbook.SheetNames.join(', '));

                // ═══════════════════════════════════════════════════════════════════════════════
                // IMPORT ALL SHEETS - Use sheet name as region/state indicator
                // ═══════════════════════════════════════════════════════════════════════════════
                let allDevices = [];
                let totalSheetsParsed = 0;

                for (const sheetName of workbook.SheetNames) {
                    console.log(`\n📋 Processing sheet: "${sheetName}"`);

                    const worksheet = workbook.Sheets[sheetName];

                    // Convert to JSON with header row
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: '' });

                    if (!jsonData || jsonData.length === 0) {
                        console.warn(`⚠️ Sheet "${sheetName}" is empty, skipping...`);
                        continue;
                    }

                    console.log(`   📊 Found ${jsonData.length} rows`);

                    // Extract region from sheet name
                    // "California_Tenant" → "California"
                    // "Florida" → "Florida"
                    // "Default" → "Default"
                    let sheetRegion = sheetName.replace(/_Tenant$/i, '').replace(/^node-list-/i, '').trim();
                    console.log(`   🌎 Sheet region: "${sheetRegion}"`);

                    // Convert Excel data to our internal format using the same column mapping as CSV
                    const headers = Object.keys(jsonData[0]).map(h => h.toLowerCase());
                    console.log(`   📋 Headers detected:`, headers.slice(0, 10).join(', '), '...');

                    // Use the same column mapping logic as CSV parser
                    const columnMap = {
                        region: findColumn(headers, ['region']),
                        deviceName: findColumn(headers, ['device name', 'devicename', 'hostname', 'host', 'name', 'system name', 'systemname']),
                        vendor: findColumn(headers, ['vendor', 'manufacturer', 'make']),
                        deviceType: findColumn(headers, ['device type', 'devicetype', 'type', 'model type']),
                        model: findColumn(headers, ['model', 'device model', 'product model', 'hardware model', 'model name']),
                        siteType: findColumn(headers, ['site type', 'sitetype', 'site']),
                        deviceRole: findColumn(headers, ['device role', 'devicerole', 'role']),
                        sn: findColumn(headers, ['serial number', 'serialnumber', 'serial #', 'serial#', 'serial', 'sn', 's/n', 'device serial', 'device sn', 'primary sn', 'primary serial']),
                        hasHA: findColumn(headers, ['ha status', 'hastatus', 'ha configured', 'ha']),
                        sn_ha1: findColumn(headers, ['ha serial 1', 'sn_ha1', 'ha sn 1', 'hasn1']),
                        sn_ha2: findColumn(headers, ['ha serial 2', 'sn_ha2', 'ha sn 2', 'hasn2']),
                        city: findColumn(headers, ['city', 'town']),
                        state: findColumn(headers, ['state', 'province']),
                        country: findColumn(headers, ['country', 'nation']),
                        systemLocation: findColumn(headers, ['system location', 'location', 'site location', 'physical location']),
                        managedBy: findColumn(headers, ['managed by', 'managedby', 'manager id']),
                        tenant: findColumn(headers, ['tenant name', 'tenant', 'organization']),
                        managementIP: findColumn(headers, ['management address', 'managementaddress', 'management ip', 'ip address', 'ip']),
                        ipAddress: findColumn(headers, ['ip address', 'ip', 'management ip', 'mgmt ip']),
                        deviceCategory: findColumn(headers, ['device category', 'devicecategory', 'category']),
                        systemDescription: findColumn(headers, ['system description', 'systemdescription', 'sys description', 'sysdescr', 'description']),
                        // CRITICAL ADDITIONS: Fields that were missing but exist in CSV parser
                        deviceVendor: findColumn(headers, ['device vendor', 'devicevendor', 'vendor id']),
                        deviceProfile: findColumn(headers, ['device profile', 'deviceprofile', 'profile']),
                        deviceFamily: findColumn(headers, ['device family', 'devicefamily', 'family', 'product family']),
                        firmwareVersion: findColumn(headers, ['firmware version', 'firmwareversion', 'firmware', 'fw version', 'fw ver']),
                        softwareVersion: findColumn(headers, ['software version', 'softwareversion', 'sw version', 'os version', 'sw ver'])
                    };

                    // DEBUG: Log column mapping results
                    console.log('   🗺️ Column Mapping Results:');
                    const mappingResults = {};
                    for (const [field, colIndex] of Object.entries(columnMap)) {
                        if (colIndex !== -1) {
                            mappingResults[field] = `"${headers[colIndex]}" (column ${colIndex})`;
                        } else {
                            mappingResults[field] = '❌ NOT FOUND';
                        }
                    }
                    console.table(mappingResults);

                    // Highlight critical fields
                    if (columnMap.ipAddress === -1 && columnMap.managementIP === -1) {
                        console.warn('   ⚠️ WARNING: No IP address column found!');
                    } else {
                        const ipCol = columnMap.ipAddress !== -1 ? columnMap.ipAddress : columnMap.managementIP;
                        console.log(`   ✅ IP Address mapped to: "${headers[ipCol]}"`);
                    }
                    if (columnMap.sn === -1) {
                        console.warn('   ⚠️ WARNING: No serial number column found!');
                    } else {
                        console.log(`   ✅ Serial Number mapped to: "${headers[columnMap.sn]}"`);
                    }
                    if (columnMap.deviceName === -1) {
                        console.warn('   ⚠️ WARNING: No device name column found!');
                    } else {
                        console.log(`   ✅ Device Name mapped to: "${headers[columnMap.deviceName]}"`);
                    }

                    // Map Excel rows to device objects
                    const devices = jsonData.map((row, index) => {
                        try {
                            const headerKeys = Object.keys(jsonData[0]);
                            const getValue = (idx) => idx !== -1 ? row[headerKeys[idx]] : '';

                        // STEP 1: Extract raw values from all relevant columns
                            const rawVendor = getValue(columnMap.vendor) || '';
                            const rawDeviceVendor = getValue(columnMap.deviceVendor) || '';
                            const rawModel = getValue(columnMap.model) || '';
                            const rawDeviceProfile = getValue(columnMap.deviceProfile) || '';
                            const rawDeviceFamily = getValue(columnMap.deviceFamily) || '';
                            const rawSystemDescription = getValue(columnMap.systemDescription) || '';
                            const rawFirmwareVersion = getValue(columnMap.firmwareVersion) || '';
                            const rawSoftwareVersion = getValue(columnMap.softwareVersion) || '';
                            const rawDeviceType = getValue(columnMap.deviceType) || '';
                            const rawDeviceCategory = getValue(columnMap.deviceCategory) || '';

                        // STEP 2: Build temporary device object for detection with all needed fields
                        const tempDevice = {
                            deviceName: getValue(columnMap.deviceName) || '',
                            model: rawModel,
                            sn: getValue(columnMap.sn) || '',
                            deviceType: rawDeviceType,
                            deviceCategory: rawDeviceCategory,
                            systemDescription: rawSystemDescription,
                            vendor: rawVendor,
                            deviceVendor: rawDeviceVendor,
                            deviceProfile: rawDeviceProfile
                        };

                            // STEP 3: Apply intelligent fallback logic (matching CSV parser logic)

                            // Vendor: Use vendor column, fallback to deviceVendor, then detection
                            const finalVendor = rawVendor || rawDeviceVendor || detectVendorFromCSV(tempDevice) || '';

                            // Model: Use model column, fallback to deviceProfile, then detection
                            const finalModel = rawModel || rawDeviceProfile || detectModel(getValue(columnMap.sn)) || '';

                            // Device Type: Use deviceType column, fallback to detection
                            const finalDeviceType = rawDeviceType || detectDeviceTypeFromCSV(tempDevice) || '';

                            // Firmware: Use explicit firmware columns, fallback to extraction from System Description
                            let finalFirmwareVersion = rawFirmwareVersion || rawSoftwareVersion;
                            if (!finalFirmwareVersion && rawSystemDescription) {
                                // Extract firmware version from System Description
                                // Matches patterns like: "Version 16.12.3a", "Version 9.3(8)", "v10.3.5", "Ver 12.2(55)"
                                const versionMatch = rawSystemDescription.match(/(?:Version|Ver|v)[\s:]+?([\d\.]+[a-zA-Z0-9\-\(\)]*)/i);
                                if (versionMatch) {
                                    finalFirmwareVersion = versionMatch[1];
                                }
                            }

                            return {
                                // CRITICAL: Include sheet name for geographic validation
                                sheetName: sheetName,
                                // Use sheet name as region if not in data
                                region: getValue(columnMap.region) || sheetRegion,
                                deviceName: getValue(columnMap.deviceName) || `Device-${index + 1}`,

                                // Use final values with intelligent fallbacks
                                vendor: finalVendor,
                                deviceType: finalDeviceType,
                                model: finalModel,

                                siteType: getValue(columnMap.siteType) || '',
                                deviceRole: getValue(columnMap.deviceRole) || '',
                                sn: getValue(columnMap.sn) || '',
                                hasHA: getValue(columnMap.hasHA) || false,
                                sn_ha1: getValue(columnMap.sn_ha1) || '',
                                sn_ha2: getValue(columnMap.sn_ha2) || '',
                                city: getValue(columnMap.city) || '',
                                state: getValue(columnMap.state) || '', // Column mapper now excludes timestamp columns
                                country: getValue(columnMap.country) || '',
                                managedBy: getValue(columnMap.managedBy) || '',
                                tenant: getValue(columnMap.tenant) || 'Default Tenant',
                                managementIP: getValue(columnMap.managementIP) || getValue(columnMap.ipAddress) || '',
                                ipAddress: getValue(columnMap.ipAddress) || getValue(columnMap.managementIP) || '',
                                // Store additional location data for validator
                                systemLocation: getValue(columnMap.systemLocation) || '',

                                // CRITICAL ADDITIONS: Fields that were missing
                                firmwareVersion: finalFirmwareVersion || '',  // Extracted firmware
                                softwareVersion: finalFirmwareVersion || '',   // Same as firmware
                                deviceVendor: rawDeviceVendor,                 // Raw field for enrichment
                                deviceProfile: rawDeviceProfile,               // Raw field for enrichment
                                deviceFamily: rawDeviceFamily,                 // Raw field for enrichment
                                deviceCategory: rawDeviceCategory,             // For role mapping
                                systemDescription: rawSystemDescription        // For intelligent parsing
                            };
                        } catch (err) {
                            console.error(`Error processing Excel row ${index + 1}:`, err);
                            // Return basic device info on error
                            return {
                                sheetName: sheetName,
                                region: sheetRegion,
                                deviceName: row[Object.keys(jsonData[0])[columnMap.deviceName]] || `Device-${index + 1}`,
                                vendor: '',
                                deviceType: '',
                                model: '',
                                siteType: '',
                                deviceRole: '',
                                sn: '',
                                hasHA: false,
                                sn_ha1: '',
                                sn_ha2: '',
                                city: '',
                                state: '',
                                country: '',
                                managedBy: '',
                                tenant: 'Default Tenant',
                                managementIP: '',
                                ipAddress: '',
                                systemLocation: '',
                                // CRITICAL ADDITIONS: Match main return object structure
                                firmwareVersion: '',
                                softwareVersion: '',
                                deviceVendor: '',
                                deviceProfile: '',
                                deviceFamily: '',
                                deviceCategory: '',
                                systemDescription: ''
                            };
                        }
                    });

                    console.log(`   ✅ Parsed ${devices.length} devices from "${sheetName}"`);

                    // Add devices from this sheet to the combined array
                    allDevices = allDevices.concat(devices);
                    totalSheetsParsed++;
                }

                // Done processing all sheets
                console.log(`\n🎉 Successfully imported ${workbook.SheetNames.length} sheets!`);
                console.log(`📊 Total devices from all sheets: ${allDevices.length}`);
                console.log(`📋 Sheets processed: ${totalSheetsParsed}`);

                return allDevices;

            } catch (error) {
                console.error('❌ Excel parsing error:', error);
                throw new Error(`Failed to parse Excel file: ${error.message}`);
            }
        }

        // Validate import data
        function validateImportData(data) {
            if (!data || data.length === 0) {
                return { valid: false, error: 'No data to import' };
            }

            // Only check that we have device names (serial numbers are optional)
            // Device names are auto-generated if missing, so this is very permissive
            for (let i = 0; i < data.length; i++) {
                const device = data[i];
                if (!device.deviceName) {
                    return {
                        valid: false,
                        error: `Row ${i + 1}: Unable to identify device (no name or identifier found)`
                    };
                }
            }

            return { valid: true };
        }

        // 🔍 COMPREHENSIVE DUPLICATE DETECTION
        // Checks: Serial Number, Hostname, ManagedBy + Hostname, Tenant + Hostname
        function detectDuplicates(importDevices, existingDevices) {
            const duplicates = [];
            const duplicateIndices = new Set();

            console.log(`🔍 Checking ${importDevices.length} devices against ${existingDevices.length} existing devices...`);

            importDevices.forEach((importDevice, index) => {
                const matchedBy = [];
                let existingDevice = null;

                // Normalize fields for comparison (trim, lowercase)
                const normalize = (str) => str ? String(str).trim().toLowerCase() : '';

                const importSerial = normalize(importDevice.sn);
                const importHostname = normalize(importDevice.deviceName);
                const importManagedBy = normalize(importDevice.managedBy);
                const importTenant = normalize(importDevice.tenant);

                // Check against all existing devices
                for (const existing of existingDevices) {
                    const existingSerial = normalize(existing.sn);
                    const existingHostname = normalize(existing.deviceName);
                    const existingManagedBy = normalize(existing.managedBy);
                    const existingTenant = normalize(existing.tenant);

                    // Priority 1: Serial Number match (most reliable)
                    if (importSerial && existingSerial && importSerial === existingSerial && importSerial !== 'n/a') {
                        matchedBy.push('Serial Number');
                        existingDevice = existing;
                        break; // Serial match is definitive
                    }

                    // Priority 2: Exact Hostname match
                    if (importHostname && existingHostname && importHostname === existingHostname) {
                        matchedBy.push('Hostname');
                        existingDevice = existing;
                        // Don't break - might also match on serial
                    }

                    // Priority 3: ManagedBy + Hostname combination (for multi-tenant environments)
                    if (importManagedBy && existingManagedBy && importHostname && existingHostname &&
                        importManagedBy === existingManagedBy && importHostname === existingHostname) {
                        if (!matchedBy.includes('ManagedBy + Hostname')) {
                            matchedBy.push('ManagedBy + Hostname');
                        }
                        existingDevice = existing;
                    }

                    // Priority 4: Tenant + Hostname combination
                    if (importTenant && existingTenant && importHostname && existingHostname &&
                        importTenant === existingTenant && importHostname === existingHostname &&
                        importTenant !== 'default tenant') {
                        if (!matchedBy.includes('Tenant + Hostname')) {
                            matchedBy.push('Tenant + Hostname');
                        }
                        existingDevice = existing;
                    }
                }

                // If any matches found, mark as duplicate
                if (matchedBy.length > 0 && existingDevice) {
                    duplicates.push({
                        importDevice: importDevice,
                        existingDevice: existingDevice,
                        matchedBy: matchedBy
                    });
                    duplicateIndices.add(index);
                }
            });

            console.log(`✅ Duplicate check complete: ${duplicates.length} duplicates found`);

            return {
                duplicates: duplicates,
                duplicateIndices: duplicateIndices
            };
        }

        // Show import preview
        function showImportPreview(data) {
            // Analyze what data is present and what will be auto-detected
            const hasVendor = data.some(d => d.vendor);
            const hasModel = data.some(d => d.model);
            const hasSN = data.some(d => d.sn);
            const hasLocation = data.some(d => d.city || d.state);
            const hasSiteType = data.some(d => d.siteType);
            const hasDeviceRole = data.some(d => d.deviceRole);

            // Show statistics with helpful info
            const statsHtml = `
                <div class="import-stat">
                    <div class="import-stat-value">${data.length}</div>
                    <div class="import-stat-label">Total Devices</div>
                </div>
                <div class="import-stat">
                    <div class="import-stat-value">${data.filter(d => d.hasHA).length}</div>
                    <div class="import-stat-label">HA Configured</div>
                </div>
                <div class="import-stat">
                    <div class="import-stat-value">${data.filter(d => d.region === 'US').length}</div>
                    <div class="import-stat-label">US Devices</div>
                </div>
                <div class="import-stat">
                    <div class="import-stat-value">${data.filter(d => d.region === 'EU').length}</div>
                    <div class="import-stat-label">EU Devices</div>
                </div>
            `;

            // Show what will be auto-detected
            const detectionInfo = [];
            if (!hasVendor) detectionInfo.push('vendors');
            if (!hasModel) detectionInfo.push('models');
            if (!hasLocation) detectionInfo.push('locations');
            if (!hasSiteType) detectionInfo.push('site types');
            if (!hasDeviceRole) detectionInfo.push('device roles');

            let infoHtml = statsHtml;
            if (detectionInfo.length > 0) {
                infoHtml += `
                    <div style="margin-top: 15px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-left: 4px solid var(--primary-color); border-radius: 4px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">🔍 Smart Detection Enabled</div>
                        <div style="font-size: 0.9em; color: #666;">Will auto-detect: ${detectionInfo.join(', ')}</div>
                    </div>
                `;
            }

            const statsElem = document.getElementById('importStats');
            if (statsElem) statsElem.innerHTML = infoHtml;

            // Show preview table (first 10 rows)
            const previewData = data.slice(0, 10);
            const tableHtml = `
                <table class="import-preview-table">
                    <thead>
                        <tr>
                            <th>Region</th>
                            <th>Device Name</th>
                            <th>Model</th>
                            <th>Serial Number</th>
                            <th>HA Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${previewData.map(device => `
                            <tr>
                                <td>${device.region || '-'}</td>
                                <td>${escapeHtml(device.deviceName)}</td>
                                <td>${device.model || '-'}</td>
                                <td>${device.sn}</td>
                                <td>${device.hasHA ? '✅ HA' : '⚠️ Standalone'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${data.length > 10 ? `<p style="text-align: center; margin-top: 10px; color: #666;">Showing 10 of ${data.length} devices</p>` : ''}
            `;
            const previewElem = document.getElementById('importPreview');
            const previewSection = document.getElementById('importPreviewSection');
            const errorDiv = document.getElementById('importError');

            if (previewElem) previewElem.innerHTML = tableHtml;
            if (previewSection) previewSection.style.display = 'block';
            if (errorDiv) errorDiv.style.display = 'none';
        }

        // Show import error
        function showImportError(message) {
            const errorDiv = document.getElementById('importError');
            if (errorDiv) {
                errorDiv.className = 'import-error';
                errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
                errorDiv.style.display = 'block';
            }

            const previewSection = document.getElementById('importPreviewSection');
            const optionsSection = document.getElementById('importOptionsSection');
            const confirmBtn = document.getElementById('confirmImportBtn');

            if (previewSection) previewSection.style.display = 'none';
            if (optionsSection) optionsSection.style.display = 'none';
            if (confirmBtn) confirmBtn.disabled = true;
        }

        // Select import option
        function selectImportOption(option) {
            importOption = option;
            document.querySelectorAll('.import-option-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Confirm import
        function confirmImport() {
            if (importData.length === 0) {
                showNotification('❌ No data to import', 'error');
                return;
            }

            // Show loading indicator
            const confirmBtn = document.getElementById('confirmImportBtn');
            if (!confirmBtn) {
                console.error('Import button not found');
                showNotification('❌ Import button not found. Please refresh the page.', 'error');
                return;
            }
            const originalBtnText = confirmBtn.textContent;
            confirmBtn.disabled = true;

            // 🔍 COMPREHENSIVE DUPLICATE DETECTION - Check multiple fields
            const duplicateResults = detectDuplicates(importData, deviceData);
            if (duplicateResults.duplicates.length > 0) {
                const duplicateCount = duplicateResults.duplicates.length;
                const totalImportCount = importData.length;
                const newDevicesCount = totalImportCount - duplicateCount;

                console.warn(`⚠️ Found ${duplicateCount} duplicate devices out of ${totalImportCount} imports`);

                // Filter out duplicates, keep only new devices
                importData = importData.filter((device, index) => !duplicateResults.duplicateIndices.has(index));

                showNotification(
                    `🔍 Duplicate Check: ${duplicateCount} duplicates removed, importing ${newDevicesCount} new devices`,
                    'warning'
                );

                // Show detailed duplicate report in console
                console.table(duplicateResults.duplicates.map(d => ({
                    'Device Name': d.importDevice.deviceName,
                    'Serial': d.importDevice.sn || 'N/A',
                    'Matched By': d.matchedBy.join(', '),
                    'Existing Device': d.existingDevice.deviceName
                })));

                if (importData.length === 0) {
                    showNotification('❌ All devices in import file already exist. No new devices to import.', 'error');
                    confirmBtn.textContent = originalBtnText;
                    confirmBtn.disabled = false;
                    return;
                }
            }

            // Check if this is a large dataset - optimized for 1K+ devices
            const isLargeDataset = importData.length > 100;
            const isVeryLargeDataset = importData.length > 1000;
            const batchSize = isVeryLargeDataset ? 250 : (isLargeDataset ? 150 : 50);

            if (isVeryLargeDataset) {
                confirmBtn.textContent = `⏳ Processing ${importData.length} devices (Large Dataset)...`;
                showNotification(`📊 Processing ${importData.length} devices in batches for optimal performance`, 'info');
            } else if (isLargeDataset) {
                confirmBtn.textContent = `⏳ Processing ${importData.length} devices...`;
            } else {
                confirmBtn.textContent = '⏳ Processing...';
            }

            // Process in batches for large datasets
            const processBatch = (startIndex, processedDevices, detectedFields) => {
                const endIndex = Math.min(startIndex + batchSize, importData.length);
                const batch = importData.slice(startIndex, endIndex);

                // 🧠 Process this batch with INTELLIGENT DETECTION
                const processedBatch = batch.map((device, batchIndex) => {
                    // Use fallback detection system (old system for location/role)
                    const deviceInfo = detectDeviceInfo(device);

                    // 🎯 Apply Enterprise Intelligent Detection
                    const intelligentVendor = detectVendorIntelligent(device);
                    const intelligentModel = detectModelIntelligent(device);
                    const intelligentSerial = detectSerialIntelligent(device);

                    // Track what was auto-detected
                    if (intelligentVendor.confidence > 0 && intelligentVendor.confidence < 1.0) detectedFields.vendors++;
                    if (intelligentModel.confidence > 0 && intelligentModel.confidence < 1.0) detectedFields.models++;
                    if (!device.city && deviceInfo.city) detectedFields.locations++;
                    if (!device.siteType && deviceInfo.siteType) detectedFields.siteTypes++;
                    if (!device.deviceRole && deviceInfo.deviceRole) detectedFields.deviceRoles++;

                    // 🚨 NOC ANALYTICS ENRICHMENT
                    const healthScore = calculateHealthScore(device);
                    const portCount = extractPortCount(intelligentModel.model);
                    const deviceAge = calculateDeviceAge(intelligentSerial.serial || device.sn);
                    const isCritical = isCriticalDevice(device);
                    const isOffline = isOfflineDevice(device);
                    const daysSinceLastSeen = calculateDaysSinceLastSeen(device.statusLastModified);

                    const processed = {
                        ...device,
                        // 🏆 Use intelligent detection with confidence scoring
                        vendor: intelligentVendor.vendor,
                        model: intelligentModel.model,
                        series: intelligentModel.series,
                        sn: intelligentSerial.serial || device.sn,
                        // Use legacy detection for other fields
                        deviceType: device.deviceType || deviceInfo.deviceType,
                        siteType: device.siteType || deviceInfo.siteType,
                        deviceRole: device.deviceRole || deviceInfo.deviceRole,
                        country: device.country || deviceInfo.country,
                        state: device.state || deviceInfo.state,
                        city: device.city || deviceInfo.city,
                        fullLocation: device.fullLocation || deviceInfo.fullLocation,
                        // 🚨 NOC ANALYTICS FIELDS
                        healthScore: healthScore,
                        portCount: portCount,
                        deviceAge: deviceAge,
                        isCritical: isCritical,
                        isOffline: isOffline,
                        daysSinceLastSeen: daysSinceLastSeen,
                        // Store confidence and source for transparency
                        _detectionMeta: {
                            vendorConfidence: intelligentVendor.confidence,
                            vendorSource: intelligentVendor.source,
                            modelConfidence: intelligentModel.confidence,
                            modelSource: intelligentModel.source,
                            serialConfidence: intelligentSerial.confidence,
                            serialSource: intelligentSerial.source
                        }
                    };

                    // 🔍 ENHANCED DEBUG: Show first 10 devices + any failures (skip for very large datasets)
                    const deviceIndex = startIndex + batchIndex;
                    const skipDebugForPerformance = isVeryLargeDataset && deviceIndex > 5;
                    const showDebug = !skipDebugForPerformance && (
                                    deviceIndex < 10 ||
                                    intelligentModel.model === 'Unknown' ||
                                    !intelligentSerial.serial);

                    if (showDebug) {
                        const prefix = deviceIndex < 10 ? `Device #${deviceIndex + 1}` :
                                      `⚠️ DETECTION ISSUE - Device #${deviceIndex + 1}`;

                        console.group(`🧠 ${prefix}: ${device.deviceName || 'Unnamed'}`);
                        console.log('📥 INPUT:', {
                            deviceName: device.deviceName,
                            csvVendor: device.vendor || '(empty)',
                            csvModel: device.model || '(empty)',
                            csvSN: device.sn || '(empty)',
                            deviceVendor: device.deviceVendor || '(empty)',
                            deviceFamily: device.deviceFamily || '(empty)',
                            deviceProfile: device.deviceProfile || '(empty)',
                            systemDescription: device.systemDescription ?
                                device.systemDescription.substring(0, 100) + '...' : '(empty)'
                        });
                        console.log('🔍 DETECTED:', {
                            vendor: `${intelligentVendor.vendor} (${(intelligentVendor.confidence * 100).toFixed(0)}% via ${intelligentVendor.source})`,
                            model: `${intelligentModel.model} (${(intelligentModel.confidence * 100).toFixed(0)}% via ${intelligentModel.source})`,
                            serial: intelligentSerial.serial ?
                                `${intelligentSerial.serial} (${(intelligentSerial.confidence * 100).toFixed(0)}% via ${intelligentSerial.source})` :
                                '❌ NOT DETECTED'
                        });
                        console.log('✅ OUTPUT:', {
                            vendor: processed.vendor,
                            model: processed.model,
                            sn: processed.sn || '❌ EMPTY'
                        });

                        // Flag issues
                        if (processed.model === 'Unknown') {
                            console.warn('⚠️ Model not detected - check deviceFamily, deviceProfile, or systemDescription');
                        }
                        if (!processed.sn || processed.sn === '') {
                            console.warn('⚠️ Serial number not detected - check systemDescription or add SN column');
                        }

                        console.groupEnd();
                    }

                    return processed;
                });

                processedDevices.push(...processedBatch);

                // Update progress for large datasets
                if (isLargeDataset) {
                    const progress = Math.round((endIndex / importData.length) * 100);
                    confirmBtn.textContent = `⏳ Processing: ${progress}% (${endIndex}/${importData.length})`;

                    // Update progress bar if very large dataset
                    if (isVeryLargeDataset && progress % 10 === 0) {
                        console.log(`📊 Import Progress: ${progress}% (${endIndex}/${importData.length} devices)`);
                    }
                }

                // Continue processing if there are more devices
                if (endIndex < importData.length) {
                    // Use minimal delay for better performance, allow UI to breathe
                    const delay = isVeryLargeDataset ? 1 : 5;
                    setTimeout(() => processBatch(endIndex, processedDevices, detectedFields), delay);
                } else {
                    // All devices processed, finalize import
                    finalizeImport(processedDevices, detectedFields);
                }
            };

            const finalizeImport = (processedDevices, detectedFields) => {
                try {
                    // 📊 DETECTION QUALITY SUMMARY
                    const stats = {
                        total: processedDevices.length,
                        withModel: processedDevices.filter(d => d.model && d.model !== 'Unknown').length,
                        withSerial: processedDevices.filter(d => d.sn && d.sn !== '').length,
                        withVendor: processedDevices.filter(d => d.vendor && d.vendor !== 'Unknown').length,
                        highConfidenceModel: processedDevices.filter(d => d._detectionMeta && d._detectionMeta.modelConfidence >= 0.85).length,
                        highConfidenceSerial: processedDevices.filter(d => d._detectionMeta && d._detectionMeta.serialConfidence >= 0.85).length
                    };

                    console.log('═══════════════════════════════════════════════════════════════════');
                    console.log('📊 IMPORT QUALITY SUMMARY');
                    console.log('═══════════════════════════════════════════════════════════════════');
                    console.log(`Total Devices: ${stats.total}`);
                    console.log(`✅ With Model: ${stats.withModel}/${stats.total} (${((stats.withModel/stats.total)*100).toFixed(1)}%) - High confidence: ${stats.highConfidenceModel}`);
                    console.log(`✅ With Serial: ${stats.withSerial}/${stats.total} (${((stats.withSerial/stats.total)*100).toFixed(1)}%) - High confidence: ${stats.highConfidenceSerial}`);
                    console.log(`✅ With Vendor: ${stats.withVendor}/${stats.total} (${((stats.withVendor/stats.total)*100).toFixed(1)}%)`);

                    if (stats.withModel < stats.total) {
                        console.warn(`⚠️ ${stats.total - stats.withModel} devices missing model - check deviceFamily/deviceProfile/systemDescription fields`);
                    }
                    if (stats.withSerial < stats.total) {
                        console.warn(`⚠️ ${stats.total - stats.withSerial} devices missing serial - check systemDescription field or add Serial Number column`);
                    }
                    console.log('═══════════════════════════════════════════════════════════════════');

                    // Debug: Show first 3 processed devices before saving
                    console.log('💾 First 3 Devices:', processedDevices.slice(0, 3).map(d => ({
                        deviceName: d.deviceName,
                        vendor: d.vendor,
                        model: d.model,
                        sn: d.sn
                    })));

                    // 🌍 CRITICAL: Apply geographic validation and intelligence enrichment
                    console.log('\n🧠 Applying geographic validation and intelligence enrichment...');
                    const enrichedDevices = enrichDeviceDataWithIntelligence(processedDevices);
                    console.log(`✅ Enrichment complete - ${enrichedDevices.length} devices processed`);

                    if (importOption === 'replace') {
                        deviceData = enrichedDevices;
                        let message = `✅ Successfully imported ${deviceData.length} devices (replaced existing data)`;
                        if (detectedFields.vendors > 0 || detectedFields.models > 0 || detectedFields.locations > 0) {
                            message += ` - Auto-detected: ${detectedFields.vendors} vendors, ${detectedFields.models} models, ${detectedFields.locations} locations`;
                        }
                        showNotification(message);
                    } else {
                        const previousCount = deviceData.length;
                        // Add unique IDs to prevent duplicate key issues
                        const newDevices = enrichedDevices.map((device, idx) => ({
                            ...device,
                            _importId: `import_${Date.now()}_${idx}`,
                            _importIndex: previousCount + idx
                        }));
                        // Create new array to ensure proper update
                        deviceData = [...deviceData, ...newDevices];
                        let message = `✅ Successfully imported ${enrichedDevices.length} devices (now ${deviceData.length} total, previously ${previousCount})`;
                        if (detectedFields.vendors > 0 || detectedFields.models > 0 || detectedFields.locations > 0) {
                            message += ` - Auto-detected: ${detectedFields.vendors} vendors, ${detectedFields.models} models, ${detectedFields.locations} locations`;
                        }
                        showNotification(message);
                    }

                    // Debug: Verify deviceData after assignment (including geographic data)
                    console.log('💾 deviceData after import - First 3:', deviceData.slice(0, 3).map(d => ({
                        deviceName: d.deviceName,
                        model: d.model,
                        sn: d.sn,
                        vendor: d.vendor,
                        state: d.state || '(empty)',
                        geoValidated: d.geoValidated || false,
                        sheetName: d.sheetName || '(none)'
                    })));

                    // Update the display
                    confirmBtn.textContent = '⏳ Updating display...';

                    // Clear table body to prevent display issues
                    const tbody = document.getElementById('tableBody');
                    if (tbody) {
                        tbody.innerHTML = '';
                        tbody.style.opacity = '1';
                        tbody.style.transition = 'none';
                    }

                    // Defer UI updates slightly to show progress
                    setTimeout(() => {
                        filteredData = [...deviceData];

                        // For very large datasets, update UI in stages
                        if (deviceData.length > 1000) {
                            confirmBtn.textContent = '⏳ Updating statistics...';
                            setTimeout(() => {
                                updateStats();
                                updateFilterBadges();
                                confirmBtn.textContent = '⏳ Updating filters...';

                                setTimeout(() => {
                                    updateModelBreakdown();
                                    populateAllFilters();
                                    confirmBtn.textContent = '⏳ Rendering table...';

                                    // Force complete re-render
                                    requestAnimationFrame(() => {
                                        renderTable();
                                        if (currentView === 'card') {
                                            renderCardView();
                                        }
                                        confirmBtn.textContent = originalBtnText;
                                        confirmBtn.disabled = false;
                                    });
                                }, 50);
                            }, 50);
                        } else {
                            // Normal flow for smaller datasets
                            updateStats();
                            updateFilterBadges();
                            updateModelBreakdown();
                            populateAllFilters();

                            // Force complete re-render
                            requestAnimationFrame(() => {
                                renderTable();
                                if (currentView === 'card') {
                                    renderCardView();
                                }
                            });
                        }

                        // Close modal
                        closeImportModal();
                    }, 100);
                } catch (error) {
                    console.error('Import error details:', error);
                    console.error('Stack trace:', error.stack);
                    console.error('Import data length:', importData.length);
                    console.error('Import option:', importOption);

                    const errorMsg = error.message || 'Unknown error occurred';
                    showNotification('❌ Error processing import: ' + errorMsg + '. Check console for details.', 'error');

                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = originalBtnText;
                    }
                }
            };

            // Start batch processing
            const detectedFields = {
                vendors: 0,
                models: 0,
                locations: 0,
                siteTypes: 0,
                deviceRoles: 0
            };

            setTimeout(() => {
                try {
                    processBatch(0, [], detectedFields);
                } catch (error) {
                    console.error('Import initialization error:', error);
                    showNotification('❌ Failed to start import: ' + error.message, 'error');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = originalBtnText;
                    }
                }
            }, 100);
        }

        // Clear all data function
        function clearAllData() {
            if (deviceData.length === 0) {
                showNotification('ℹ️ No data to clear', 'error');
                return;
            }

            const confirmed = confirm(`⚠️ Are you sure you want to clear all data?\n\nThis will remove all ${deviceData.length} devices from the dashboard.\n\nThis action cannot be undone.`);

            if (confirmed) {
                deviceData = [];
                filteredData = [];
                selectedRows.clear();

                // Update the display
                updateStats();
                updateModelBreakdown();
                populateAllFilters();
                renderTable();
                if (currentView === 'card') {
                    renderCardView();
                }

                showNotification('✅ All data cleared successfully');
            }
        }

        // Drag and drop handlers
        const fileUploadArea = document.getElementById('fileUploadArea');
        if (fileUploadArea) {
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const fileInput = document.getElementById('fileInput');
                    fileInput.files = files;
                    handleFileSelect({ target: { files: files } });
                }
            });
        }

        // Update last updated date
        function updateLastUpdatedDate() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const dateStr = now.toLocaleDateString('en-US', options);
            const lastUpdatedElem = document.getElementById('lastUpdatedDate');
            if (lastUpdatedElem) {
                lastUpdatedElem.textContent = dateStr;
            }
        }

        // =====================================================
        // EXPORT UTILITIES & NOC HELPERS - ENTERPRISE GRADE
        // =====================================================

        // Data Validation System
        function validateDeviceData(device) {
            const issues = [];
            const warnings = [];

            // Critical fields check
            if (!device.deviceName) issues.push('Missing device name');
            if (!device.sn && !device.serialNumber) warnings.push('No serial number');
            if (!device.vendor) warnings.push('Vendor not identified');
            if (!device.model) warnings.push('Model not specified');
            if (!device.region) warnings.push('Region not set');

            // Data integrity checks
            if (device.healthScore && (device.healthScore < 0 || device.healthScore > 100)) {
                issues.push(`Invalid health score: ${device.healthScore}`);
            }

            if (device.hasHA && !device.sn_ha1 && !device.secondarySN) {
                warnings.push('HA configured but no secondary serial');
            }

            return {
                valid: issues.length === 0,
                issues: issues,
                warnings: warnings,
                quality: issues.length === 0 && warnings.length === 0 ? 'Excellent' :
                        issues.length === 0 && warnings.length <= 2 ? 'Good' :
                        issues.length === 0 ? 'Fair' : 'Poor'
            };
        }

        // Export Quality Analyzer
        function analyzeExportQuality() {
            if (!filteredData || filteredData.length === 0) {
                return {
                    status: 'No Data',
                    score: 0,
                    issues: ['No devices to export'],
                    recommendations: []
                };
            }

            let totalScore = 100;
            const issues = [];
            const recommendations = [];

            // Check data completeness
            let missingSerials = 0;
            let missingModels = 0;
            let missingVendors = 0;
            let invalidHealthScores = 0;

            filteredData.forEach(device => {
                const validation = validateDeviceData(device);
                if (!validation.valid) {
                    totalScore -= 5;
                }
                if (validation.warnings.length > 0) {
                    totalScore -= validation.warnings.length;
                }

                if (!device.sn && !device.serialNumber) missingSerials++;
                if (!device.model) missingModels++;
                if (!device.vendor) missingVendors++;
                if (device.healthScore && (device.healthScore < 0 || device.healthScore > 100)) invalidHealthScores++;
            });

            // Calculate quality metrics
            const serialCoverage = ((filteredData.length - missingSerials) / filteredData.length) * 100;
            const modelCoverage = ((filteredData.length - missingModels) / filteredData.length) * 100;
            const vendorCoverage = ((filteredData.length - missingVendors) / filteredData.length) * 100;

            if (serialCoverage < 80) {
                issues.push(`Low serial number coverage: ${serialCoverage.toFixed(1)}%`);
                recommendations.push('Import serial numbers from device management system');
            }

            if (modelCoverage < 90) {
                issues.push(`Missing model information: ${missingModels} devices`);
                recommendations.push('Update device models for better reporting');
            }

            if (vendorCoverage < 95) {
                issues.push(`Vendor not identified for ${missingVendors} devices`);
                recommendations.push('Review and update vendor information');
            }

            if (invalidHealthScores > 0) {
                issues.push(`Invalid health scores: ${invalidHealthScores} devices`);
                recommendations.push('Recalculate health scores');
            }

            // Overall quality assessment
            totalScore = Math.max(0, totalScore);
            const status = totalScore >= 90 ? 'Excellent' :
                          totalScore >= 75 ? 'Good' :
                          totalScore >= 60 ? 'Fair' :
                          'Poor';

            return {
                status: status,
                score: totalScore,
                metrics: {
                    totalDevices: filteredData.length,
                    serialCoverage: serialCoverage.toFixed(1) + '%',
                    modelCoverage: modelCoverage.toFixed(1) + '%',
                    vendorCoverage: vendorCoverage.toFixed(1) + '%',
                    missingSerials: missingSerials,
                    missingModels: missingModels,
                    missingVendors: missingVendors,
                    invalidHealthScores: invalidHealthScores
                },
                issues: issues,
                recommendations: recommendations
            };
        }

        // Export Diagnostics Dashboard
        function showExportDiagnostics() {
            const quality = analyzeExportQuality();

            let diagnosticsHTML = `
                <div style="padding: 20px; background: white; border-radius: 12px; max-width: 600px; margin: 20px auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="color: #1e293b; margin-bottom: 20px;">📊 Export Diagnostics Dashboard</h2>

                    <div style="background: ${quality.status === 'Excellent' ? '#d1fae5' :
                                             quality.status === 'Good' ? '#fef3c7' :
                                             quality.status === 'Fair' ? '#fed7aa' :
                                             '#fee2e2'};
                               padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-size: 1.5em; font-weight: bold; color: ${quality.status === 'Excellent' ? '#065f46' :
                                                                                   quality.status === 'Good' ? '#92400e' :
                                                                                   quality.status === 'Fair' ? '#92400e' :
                                                                                   '#991b1b'};">
                            Data Quality: ${quality.status}
                        </div>
                        <div style="font-size: 2em; margin-top: 10px;">Score: ${quality.score}/100</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #475569; margin-bottom: 10px;">📈 Metrics</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div style="padding: 10px; background: #f8fafc; border-radius: 6px;">
                                <div style="font-size: 0.9em; color: #64748b;">Total Devices</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${quality.metrics.totalDevices}</div>
                            </div>
                            <div style="padding: 10px; background: #f8fafc; border-radius: 6px;">
                                <div style="font-size: 0.9em; color: #64748b;">Serial Coverage</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${quality.metrics.serialCoverage}</div>
                            </div>
                            <div style="padding: 10px; background: #f8fafc; border-radius: 6px;">
                                <div style="font-size: 0.9em; color: #64748b;">Model Coverage</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${quality.metrics.modelCoverage}</div>
                            </div>
                            <div style="padding: 10px; background: #f8fafc; border-radius: 6px;">
                                <div style="font-size: 0.9em; color: #64748b;">Vendor Coverage</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${quality.metrics.vendorCoverage}</div>
                            </div>
                        </div>
                    </div>

                    ${quality.issues.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #dc2626; margin-bottom: 10px;">⚠️ Issues</h3>
                        <ul style="color: #7f1d1d; margin: 0; padding-left: 20px;">
                            ${quality.issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>` : ''}

                    ${quality.recommendations.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #0369a1; margin-bottom: 10px;">💡 Recommendations</h3>
                        <ul style="color: #075985; margin: 0; padding-left: 20px;">
                            ${quality.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>` : ''}

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="runDataCleanup()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            🔧 Run Data Cleanup
                        </button>
                        <button onclick="exportQualityReport()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            📥 Export Quality Report
                        </button>
                    </div>
                </div>
            `;

            // Create modal to show diagnostics
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = diagnosticsHTML;
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            document.body.appendChild(modal);
        }

        // Data Cleanup Utility
        function runDataCleanup() {
            let cleaned = 0;
            let updated = 0;

            filteredData.forEach(device => {
                // Clean up empty strings
                Object.keys(device).forEach(key => {
                    if (device[key] === '' || device[key] === 'null' || device[key] === 'undefined') {
                        device[key] = null;
                        cleaned++;
                    }
                });

                // Auto-detect missing vendors
                if (!device.vendor && device.sn) {
                    const detected = detectVendorFromCSV(device);
                    if (detected && detected !== 'Unknown') {
                        device.vendor = detected;
                        updated++;
                    }
                }

                // Auto-detect missing models
                if (!device.model && device.sn) {
                    const detected = detectModelIntelligent(device);
                    if (detected && detected.model !== 'Unknown') {
                        device.model = detected.model;
                        updated++;
                    }
                }

                // Fix health scores
                if (device.healthScore && (device.healthScore < 0 || device.healthScore > 100)) {
                    device.healthScore = Math.min(100, Math.max(0, device.healthScore));
                    updated++;
                }
            });

            showNotification(`✅ Data cleanup complete: ${cleaned} fields cleaned, ${updated} fields updated`, 'success');
            renderTable();
        }

        // Export Quality Report
        function exportQualityReport() {
            const quality = analyzeExportQuality();
            const now = new Date();

            const report = {
                reportType: 'Data Quality Assessment',
                generated: now.toISOString(),
                summary: {
                    status: quality.status,
                    score: quality.score,
                    totalDevices: quality.metrics.totalDevices
                },
                metrics: quality.metrics,
                issues: quality.issues,
                recommendations: quality.recommendations,
                deviceValidation: filteredData.map(device => ({
                    deviceName: device.deviceName,
                    validation: validateDeviceData(device)
                }))
            };

            const json = JSON.stringify(report, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DataQualityReport_${now.toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('✅ Quality report exported successfully', 'success');
        }

        // NOC Helper: Bulk Serial Number Updater
        function bulkUpdateSerials() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
                    <h2>📝 Bulk Serial Number Update</h2>
                    <p>Paste serial numbers (one per line) in format: DeviceName,SerialNumber</p>
                    <textarea id="bulkSerials" style="width: 100%; height: 200px; margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 6px;"
                        placeholder="FW-NYC-01,FGT60F123456\nFW-LON-01,PA220789012"></textarea>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('div').parentElement.remove()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="processBulkSerials()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Update</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function processBulkSerials() {
            const textarea = document.getElementById('bulkSerials');
            if (!textarea) return;

            const lines = textarea.value.split('\n').filter(line => line.trim());
            let updated = 0;

            lines.forEach(line => {
                const [deviceName, serial] = line.split(',').map(s => s.trim());
                if (deviceName && serial) {
                    const device = deviceData.find(d => d.deviceName === deviceName);
                    if (device) {
                        device.sn = serial;
                        updated++;
                    }
                }
            });

            textarea.closest('div').parentElement.remove();
            showNotification(`✅ Updated ${updated} serial numbers`, 'success');
            renderTable();
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            loadData();
            updateLastUpdatedDate();

            // Load compact view preference
            const preferCompact = localStorage.getItem('preferCompactView');
            if (preferCompact === 'true') {
                setTimeout(() => {
                    const compactBtn = document.querySelector('button[onclick*="toggleCompactMode"]');
                    if (compactBtn) {
                        compactBtn.click();
                    }
                }, 500);
            }
        });
    </script>
</body>
</html>